<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/static/css/colorful.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/second.css">
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">
        <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
        <title>rsync - Wiki · Tanky Woo</title>
        <meta name="keywords" content="wiki, makrdown, linux, python, cpp, ops, simiki"/>
        <meta name="description" content="Tanky Woo's personal wiki, powered by vim and markdown. Focus on Python, C/C++, Linux, Ops-Dev, Gentoo, and so on."/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        

    </head>

    <body>
        <div id="container" class="typo">
            
    <div id="header">
        <div id="post-nav">
            
            <a href="/">Wiki · Tanky Woo</a> » <a href="/#tool">tool</a> » rsync
            
        </div>
    </div>
    <div class="clearfix"></div>
    <div id="content">
        <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">使用方式</a><ul>
<li><a href="#_2">本地同步</a></li>
<li><a href="#remote-shell">remote shell方式 远程同步</a></li>
<li><a href="#rsync-daemon">rsync daemon方式 远程同步</a></li>
</ul>
</li>
<li><a href="#_3">常用参数</a></li>
<li><a href="#_4">经验</a><ul>
<li><a href="#hosts-allow-hosts-deny">关于 hosts allow 和 hosts deny</a></li>
<li><a href="#_5">关于认证用户和密码</a></li>
<li><a href="#filter-exclude-exclude-from">关于 filter, exclude, exclude from 等</a></li>
</ul>
</li>
<li><a href="#_6">关于权限问题</a></li>
<li><a href="#troubleshoot">Troubleshoot</a></li>
</ul>
</div>
<p>rsync - a fast, versatile, remote (and local) file-copying tool</p>
<p>广泛用于<code>备份(backup)</code>和<code>镜像(mirror)</code></p>
<p>支持本地或远程复制, 有<code>shell</code>和<code>rsync daemon</code>两种方式</p>
<ul>
<li>remote shell<ul>
<li>via ssh or rsh</li>
<li>the source or destination path contains a single colon (:) separator after a host specification</li>
</ul>
</li>
<li>rsync daemon<ul>
<li>via TCP</li>
<li>the source or destination path contains a double colon (::) separator after a  host  specification</li>
<li>OR  when  an rsync://  URL  is  specified</li>
</ul>
</li>
</ul>
<h2 id="_1">使用方式</h2>
<div class="hlcode"><pre><span class="n">Local</span><span class="o">:</span>
    <span class="n">rsync</span> <span class="o">[</span><span class="n">OPTION</span><span class="o">...]</span> <span class="n">SRC</span><span class="o">...</span> <span class="o">[</span><span class="n">DEST</span><span class="o">]</span>

<span class="n">Access</span> <span class="n">via</span> <span class="n">remote</span> <span class="n">shell</span><span class="o">:</span>
    <span class="n">Pull</span><span class="o">:</span> <span class="n">rsync</span> <span class="o">[</span><span class="n">OPTION</span><span class="o">...]</span> <span class="o">[</span><span class="n">USER</span><span class="err">@</span><span class="o">]</span><span class="n">HOST</span><span class="o">:</span><span class="n">SRC</span><span class="o">...</span> <span class="o">[</span><span class="n">DEST</span><span class="o">]</span>
    <span class="n">Push</span><span class="o">:</span> <span class="n">rsync</span> <span class="o">[</span><span class="n">OPTION</span><span class="o">...]</span> <span class="n">SRC</span><span class="o">...</span> <span class="o">[</span><span class="n">USER</span><span class="err">@</span><span class="o">]</span><span class="n">HOST</span><span class="o">:</span><span class="n">DEST</span>

<span class="n">Access</span> <span class="n">via</span> <span class="n">rsync</span> <span class="n">daemon</span><span class="o">:</span>
    <span class="n">Pull</span><span class="o">:</span> <span class="n">rsync</span> <span class="o">[</span><span class="n">OPTION</span><span class="o">...]</span> <span class="o">[</span><span class="n">USER</span><span class="err">@</span><span class="o">]</span><span class="n">HOST</span><span class="o">::</span><span class="n">SRC</span><span class="o">...</span> <span class="o">[</span><span class="n">DEST</span><span class="o">]</span>
          <span class="n">rsync</span> <span class="o">[</span><span class="n">OPTION</span><span class="o">...]</span> <span class="n">rsync</span><span class="o">://[</span><span class="n">USER</span><span class="err">@</span><span class="o">]</span><span class="n">HOST</span><span class="o">[:</span><span class="n">PORT</span><span class="o">]/</span><span class="n">SRC</span><span class="o">...</span> <span class="o">[</span><span class="n">DEST</span><span class="o">]</span>
    <span class="n">Push</span><span class="o">:</span> <span class="n">rsync</span> <span class="o">[</span><span class="n">OPTION</span><span class="o">...]</span> <span class="n">SRC</span><span class="o">...</span> <span class="o">[</span><span class="n">USER</span><span class="err">@</span><span class="o">]</span><span class="n">HOST</span><span class="o">::</span><span class="n">DEST</span>
          <span class="n">rsync</span> <span class="o">[</span><span class="n">OPTION</span><span class="o">...]</span> <span class="n">SRC</span><span class="o">...</span> <span class="n">rsync</span><span class="o">://[</span><span class="n">USER</span><span class="err">@</span><span class="o">]</span><span class="n">HOST</span><span class="o">[:</span><span class="n">PORT</span><span class="o">]/</span><span class="n">DEST</span>

<span class="n">Usages</span> <span class="k">with</span> <span class="n">just</span> <span class="n">one</span> <span class="n">SRC</span> <span class="n">arg</span> <span class="n">and</span> <span class="n">no</span> <span class="n">DEST</span> <span class="n">arg</span> <span class="n">will</span> <span class="n">list</span> <span class="n">the</span> <span class="n">source</span> <span class="n">files</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">copying</span><span class="o">.</span>
</pre></div>


<h3 id="_2">本地同步</h3>
<div class="hlcode"><pre><span class="n">rsync</span> <span class="p">[</span><span class="n">OPTION</span><span class="p">...]</span> <span class="n">SRC</span><span class="p">...</span> <span class="p">[</span><span class="n">DEST</span><span class="p">]</span>
</pre></div>


<h3 id="remote-shell">remote shell方式 远程同步</h3>
<p>使用一个冒号<code>:</code>分隔主机和目录</p>
<div class="hlcode"><pre><span class="n">Pull</span><span class="o">:</span> <span class="n">rsync</span> <span class="o">[</span><span class="n">OPTION</span><span class="o">...]</span> <span class="o">[</span><span class="n">USER</span><span class="err">@</span><span class="o">]</span><span class="n">HOST</span><span class="o">:</span><span class="n">SRC</span><span class="o">...</span> <span class="o">[</span><span class="n">DEST</span><span class="o">]</span>
<span class="n">Push</span><span class="o">:</span> <span class="n">rsync</span> <span class="o">[</span><span class="n">OPTION</span><span class="o">...]</span> <span class="n">SRC</span><span class="o">...</span> <span class="o">[</span><span class="n">USER</span><span class="err">@</span><span class="o">]</span><span class="n">HOST</span><span class="o">:</span><span class="n">DEST</span>
</pre></div>


<p>可以使用<code>ssh</code>或<code>rsh</code>方式传输</p>
<p>举例:</p>
<div class="hlcode"><pre><span class="cp"># 使用ssh方式, 端口为1234. 传输主机tankywoo的/data目录到本地的/tmp/backup下</span>
<span class="n">rsync</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">ssh</span> <span class="o">-</span><span class="n">p</span> <span class="mi">1234</span><span class="err">&#39;</span> <span class="n">root</span><span class="err">@</span><span class="n">tankywoo</span><span class="o">:/</span><span class="n">data</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span>
</pre></div>


<h3 id="rsync-daemon">rsync daemon方式 远程同步</h3>
<p>有两种方式:</p>
<ul>
<li>
<p>使用两个冒号<code>::</code>分隔主机和目录</p>
<div class="hlcode"><pre><span class="n">Pull</span><span class="o">:</span> <span class="n">rsync</span> <span class="o">[</span><span class="n">OPTION</span><span class="o">...]</span> <span class="o">[</span><span class="n">USER</span><span class="err">@</span><span class="o">]</span><span class="n">HOST</span><span class="o">::</span><span class="n">SRC</span><span class="o">...</span> <span class="o">[</span><span class="n">DEST</span><span class="o">]</span>
<span class="n">Push</span><span class="o">:</span> <span class="n">rsync</span> <span class="o">[</span><span class="n">OPTION</span><span class="o">...]</span> <span class="n">SRC</span><span class="o">...</span> <span class="o">[</span><span class="n">USER</span><span class="err">@</span><span class="o">]</span><span class="n">HOST</span><span class="o">::</span><span class="n">DEST</span>
</pre></div>


</li>
<li>
<p>主机前加上<code>rsync://</code>, 后面直接使用<code>/</code>分隔主机和目录, 和目录结构一样</p>
<div class="hlcode"><pre><span class="n">Pull</span><span class="o">:</span> <span class="n">rsync</span> <span class="o">[</span><span class="n">OPTION</span><span class="o">...]</span> <span class="n">rsync</span><span class="o">://[</span><span class="n">USER</span><span class="err">@</span><span class="o">]</span><span class="n">HOST</span><span class="o">[:</span><span class="n">PORT</span><span class="o">]/</span><span class="n">SRC</span><span class="o">...</span> <span class="o">[</span><span class="n">DEST</span><span class="o">]</span>
<span class="n">Push</span><span class="o">:</span> <span class="n">rsync</span> <span class="o">[</span><span class="n">OPTION</span><span class="o">...]</span> <span class="n">SRC</span><span class="o">...</span> <span class="n">rsync</span><span class="o">://[</span><span class="n">USER</span><span class="err">@</span><span class="o">]</span><span class="n">HOST</span><span class="o">[:</span><span class="n">PORT</span><span class="o">]/</span><span class="n">DEST</span>
</pre></div>


</li>
</ul>
<h2 id="_3">常用参数</h2>
<ul>
<li><code>-a</code> - archive mode; 相当于 <code>-rlptgoD</code></li>
<li><code>-r</code> - 递归. 和<code>cp</code>的 -r 参数一样</li>
<li><code>-l</code> - 复制软链接</li>
<li><code>-p</code> - 保持权限不变</li>
<li><code>-t</code> - 保持修改时间不变</li>
<li><code>-g</code> - 保持group组不变</li>
<li><code>-o</code> - 保持owner不变</li>
<li><code>-D</code> - 等价于<code>--devices --specials</code>, 分别是同步设备文件和特殊文件</li>
<li><code>-b</code> - backup. 配合<code>--backup-dir</code>来用.</li>
<li><code>-n</code> - 这个非常有用. 在同步前可以先测试来查看会由哪些变化, 但不实际修改. 类似gentoo emerge时的<code>-pv</code></li>
<li><code>-v</code> - 更详细的输出信息</li>
<li><code>-h</code> - 以human-readable的方式输出数字格式</li>
<li><code>-H</code> - 复制硬链接</li>
<li><code>-E</code> - 保持可执行权限一致</li>
<li><code>-X</code> - 保持扩展属性(extended attributes), 如<code>setattr</code>配置的属性</li>
<li><code>-A</code> - 保持ACL</li>
<li><code>--delete</code> - 删除src没有, 但dest存在的文件. 这是mirror方式需要的, 保持两边所有文件一致.</li>
<li><code>--stats</code> - 输出文件传输的状态</li>
<li><code>--progress</code> - 输出文件传输的进度</li>
<li><code>--exclude-from</code> - 从文件里读取排除在外的文件或目录</li>
<li><code>--numeric-ids</code> - 不映射uid/gid到user/group的名字</li>
<li><code>--list-only</code> - 只列出文件列表, 不同步. 这个和同步时加上<code>-n</code>做pretend有点类似</li>
</ul>
<p>列出可用modules(只有module未配置<code>list = no</code>的才会被列出):</p>
<div class="hlcode"><pre><span class="n">rsync</span> <span class="mf">192.168.1.100</span><span class="o">::</span>
</pre></div>


<p>查看文件列表:</p>
<div class="hlcode"><pre><span class="n">rsync</span> <span class="o">--</span><span class="n">list</span><span class="o">-</span><span class="n">only</span> <span class="n">bob</span><span class="err">@</span><span class="mf">192.168.1.100</span><span class="o">::</span><span class="n">mymodule</span>
</pre></div>


<p>常用的mirror同步命令:</p>
<div class="hlcode"><pre><span class="n">rsync</span> <span class="o">-</span><span class="n">hvaHEXA</span> <span class="o">--</span><span class="n">delete</span> <span class="o">--</span><span class="n">stats</span> <span class="o">--</span><span class="n">progress</span> <span class="o">--</span><span class="n">numeric</span><span class="o">-</span><span class="n">ids</span> <span class="o">--</span><span class="n">exclude</span><span class="o">-</span><span class="n">from</span><span class="o">=/</span><span class="n">root</span><span class="o">/</span><span class="n">filter_file</span> <span class="n">tankywoo</span><span class="o">::</span><span class="n">wiki</span> <span class="o">/</span><span class="n">data</span>
</pre></div>


<p>rsyncd 可以配置多个modules, 如:</p>
<div class="hlcode"><pre><span class="k">[mymodule]</span>
    <span class="na">uid</span> <span class="o">=</span> <span class="s">root</span>
<span class="s">    gid = root</span>
<span class="s">    path = /home/test/</span>
<span class="s">    numeric ids = yes</span>
<span class="s">    list = no</span>
<span class="s">    exclude from = /path/to/file</span>
<span class="s">    ignore errors</span>
<span class="s">    auth users = bob</span>
<span class="s">    secrets file = /etc/rsyncd.secrets</span>
<span class="s">    hosts allow = 192.168.1.101</span>
<span class="s">    comment = &quot;for rsyncd test&quot;</span>
</pre></div>


<h2 id="_4">经验</h2>
<h3 id="hosts-allow-hosts-deny">关于 hosts allow 和 hosts deny</h3>
<p>如果只设置了<code>hosts allow</code>, 则不符合的都会拒绝连接(reject).</p>
<p>如果同时设置了<code>hosts allow</code>和<code>hosts deny</code>, 则首先会判断是否符合allow列表, 如果符合则连接, 否则判断deny连接, 如果符合则拒绝, 剩下的都允许连接.</p>
<p>另外, 这两个配置项都可以是全局级的.</p>
<p>逻辑上有点绕, 所以感觉这个如果没有仔细看文档和尝试的话, 容易造成安全问题.</p>
<p>这里也可以使用通配符(wildcards) <code>*</code>.</p>
<h3 id="_5">关于认证用户和密码</h3>
<p><code>auth users</code> 和 <code>secrets file</code> 控制.</p>
<p>前者列出允许连接module的用户, 后者管理用户和密码.</p>
<p>普通的设置只是简单的帐号密码匹配, 这套用户密码体系和本地用户(<code>/etc/passwd</code>)是无关的.</p>
<p>也可以配置<code>groupname matching</code>, 组名使用<code>@</code>前缀, 此时认证用户必须是本地系统上存在的真实用户, 且是这个组下的成员.</p>
<h3 id="filter-exclude-exclude-from">关于 filter, exclude, exclude from 等</h3>
<p>排除的文件路径, 始终是<strong>相对路径</strong>, 相对于path的路径.</p>
<p><code>exclude</code> 配置排除的模式</p>
<p><code>exclude from</code> 配置排除文件, 包含多行排除模式/文件, 一个module只能配置一个此配置项, 配置多个的话以最后一个为主. 但是客户端命令可以指定多个<code>--exclude-from</code>, 且都生效.</p>
<blockquote>
<p>Only one "exclude from" parameter can apply to a given module; if you have multiple exclude-from files, you can specify them as a merge file in the "filter" parameter.</p>
</blockquote>
<p>排除模式可以使用<code>-</code>和<code>+</code>来显示的指定<code>exclude</code>和<code>include</code>.</p>
<p>关于filter和exclude from的区别:</p>
<ul>
<li>filter 必须指定 <code>-</code> 和 <code>+</code>, 而exclude from里的模式默认都是<code>-</code></li>
</ul>
<p>这里还有些疑惑的地方:</p>
<p>如果配置了<code>use chroot = yes</code>, 那么感觉<code>exclude from</code> 以及 <code>filter</code> 指定的文件都应该是相对路径, 相对于path, 但是实际还是要配置绝对路径, 否则报错.</p>
<p>不过, filter是可以显式配置为相对:</p>
<div class="hlcode"><pre><span class="n">filter</span> <span class="o">=</span> <span class="o">:</span> <span class="p">.</span><span class="n">rsync</span><span class="o">-</span><span class="n">filter</span>
</pre></div>


<p>这样就是相对了path配置的路径下的.rsync-filter文件.</p>
<p>另外就是关于:</p>
<blockquote>
<p>you can specify them as a merge file in the "filter" parameter</p>
</blockquote>
<p>这里不清楚怎么使用?  <strong>TODO</strong></p>
<h2 id="_6">关于权限问题</h2>
<p>同步时会看到有些文件报 <code>failed: Permission denied</code>, <code>uid</code> 选项给出了说明:</p>
<blockquote>
<p>The default when run by a super-user is to switch to the system’s "nobody" user.  The default for a non-super-user is to not try to change the user.</p>
</blockquote>
<p>所以需要配置 <code>uid = root</code> (或其它足够的权限)</p>
<h2 id="troubleshoot">Troubleshoot</h2>
<blockquote>
<p>rsync: didn't get server startup line</p>
</blockquote>
<p>测试时配置的<code>exclude from</code>是一个无效路径, 导致这个错误</p>
<blockquote>
<p>auth failed on module xxx</p>
</blockquote>
<p>见 <a href="http://blog.tankywoo.com/linux/2013/12/07/rsync-auth-failed-on-module-xxx.html">rsync auth failed on module xxx 问题总结</a></p>
    </div>

        </div>
        <div id="footer">
              <p>
                Copyright © 2012-2016 Tanky Woo.
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
                Theme by <a href="https://github.com/tankywoo/yasimple" target="_blank">YASimple</a>.
              </p>
              <p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</p>
              <p>Last Update 2016-03-15 12:49:45</p>
              <p><a href="https://github.com/tankywoo/wiki.tankywoo.com">Fork me on Github</a></p>
        </div>
<script type="text/javascript">
	var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
	document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F754de327571c0ba7ff50a61fc964e196' type='text/javascript'%3E%3C/script%3E"));
</script>
    </body>
</html>