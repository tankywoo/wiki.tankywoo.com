<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Version Control with Git - Wiki · Tanky Woo</title>
    <meta name="keywords" content="wiki, makrdown, linux, python, cpp, ops, simiki"/>
    <meta name="description" content="Tanky Woo's personal wiki, powered by vim and markdown. Focus on Python, C/C++, Linux, Ops-Dev, Gentoo, and so on."/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/">Wiki · Tanky Woo</a>
    &nbsp;&#187;&nbsp;
    <a href="/#tool">tool</a>
    &nbsp;&#187;&nbsp;Version Control with Git
    <span class="updated">当前页面最后更新&nbsp;
    2014-04-28 23:31
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#3">3. 起步</a></li>
<li><a href="#4git">4.基本的Git概念</a><ul>
<li><a href="#object-store">对象库(Object Store)</a></li>
<li><a href="#index">索引(Index)</a></li>
<li><a href="#_1">可寻址内容名称</a></li>
<li><a href="#git">Git追踪内容</a></li>
<li><a href="#pack-file">打包文件(pack file)</a></li>
<li><a href="#_2">底层命令例子</a></li>
</ul>
</li>
<li><a href="#5">5. 文件管理和索引</a></li>
<li><a href="#6">6. 提交</a><ul>
<li><a href="#_3">查看提交历史</a></li>
<li><a href="#_4">查找提交</a></li>
</ul>
</li>
<li><a href="#7">7. 分支</a></li>
<li><a href="#8-diff">8. Diff</a></li>
<li><a href="#9">9. 合并</a></li>
<li><a href="#10">10. 更改提交</a></li>
<li><a href="#11">11. 储藏和引用日志</a></li>
<li><a href="#12">12. 远程版本库</a></li>
<li><a href="#13">13. 版本库管理(略)</a></li>
<li><a href="#14">14. 补丁</a></li>
<li><a href="#15">15. 钩子</a></li>
<li><a href="#16">16. 合并项目</a></li>
<li><a href="#17">17. 子模块最佳实践(略)</a></li>
<li><a href="#18-svngit">18. 结合SVN版本库使用Git(略)</a></li>
<li><a href="#19">19. 高级操作</a></li>
<li><a href="#20">20. 提示、技巧和技术</a></li>
<li><a href="#21-git-github">21. Git 和 Github(略)</a></li>
</ul>
</div>
<ul>
<li>First Edition, 2009, 英文影印版</li>
<li>第二版, 2015, 中文版</li>
</ul>
<p><em>注</em>: 在 <a href="https://github.com/tankywoo/wiki.tankywoo.com/commit/e2c89f107421c1bc668185298946cc33d969e441?short_path=031a497#diff-031a497c22aeea7eabd1a48496833702">@e2c89f10</a> 这个提交及之前, 因为看的是影印版(看了3年才只看了8章...), 所以很多笔记都是英文的. 5月份第二版中文版出了, 立马买了一本, 所以后续会逐步改为中文笔记, 部分原话及术语保留英文.</p>
<h2 id="3">3. 起步</h2>
<p>查看帮助:</p>
<div class="hlcode"><pre><span class="err">#</span> <span class="nb">For</span> <span class="nx">a</span> <span class="nx">complete</span> <span class="nb">list</span> <span class="nx">of</span> <span class="nx">git</span> <span class="nx">subcommands</span>
<span class="err">$</span> <span class="nx">git</span> <span class="nx">help</span> <span class="o">--</span><span class="kc">all</span>

<span class="err">#</span> <span class="nb">document</span> <span class="nb">for</span> <span class="nx">git</span> <span class="nx">subcommand</span>
<span class="err">$</span> <span class="nx">git</span> <span class="nx">help</span> <span class="o">&lt;</span><span class="nx">subcommand</span><span class="o">&gt;</span>
<span class="err">$</span> <span class="nx">git</span> <span class="o">&lt;</span><span class="nx">subcommand</span><span class="o">&gt;</span> <span class="o">--</span><span class="nx">help</span>
</pre></div>


<p>命令行中的<code>双破折号</code>(double dash):</p>
<blockquote>
<p>About <code>bare double dash</code> (<code>--</code>), in shell, it indicate the end of the command options; The same as in git, it seperate the option and the path.<br />
<a href="http://unix.stackexchange.com/questions/11376/what-does-double-dash-mean-also-known-as-bare-double-dash">ref 1</a><br />
<a href="http://unix.stackexchange.com/questions/52167/what-does-mean-in-linux-unix-command-line">ref 2</a><br />
<a href="http://stackoverflow.com/questions/1192180/deleting-a-badly-named-git-branch/1192194#1192194">ref 3</a><br />
<a href="http://stackoverflow.com/questions/13321458/meaning-of-git-checkout-double-dashes">ref 4</a></p>
</blockquote>
<p>查看某个特定提交的详细信息 <code>git show</code>:</p>
<div class="hlcode"><pre><span class="cp"># show the details of the most recent commit</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">show</span>

<span class="cp"># To see more detail about a particular commit</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">show</span> <span class="o">&lt;</span><span class="n">commit</span> <span class="n">number</span><span class="o">&gt;</span>
</pre></div>


<p>查看所有分支的整体情况 <code>git show-branch</code>:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">show</span><span class="o">-</span><span class="n">branch</span> <span class="o">--</span><span class="n">more</span><span class="o">=</span><span class="mi">10</span>
</pre></div>


<p>更详细的可以看看<a href="http://www.gitguys.com/topics/git-show-branch-to-see-branches-and-their-commits/?lang=zh">GitGuys</a>上的图解.</p>
<hr />
<h2 id="4git">4.基本的Git概念</h2>
<p><strong>注意</strong>: 这章太重要了, 字字都是珠玑, 真想把整篇都copy过来.</p>
<p>在版本库中, Git维护两个主要的数据结构: <code>对象库(object store)</code> 和 <code>索引(index)</code>. 所有这些版本库数据存放在工作目录根目录下的<code>.git</code>的隐藏目录中.</p>
<p>索引是<strong>暂时</strong>的信息, 对版本库来说是<strong>私有</strong>的, 并且可以在需要的时候按需求进行创建和修改.</p>
<p>对象库是git版本库实现的核心. 包含了原始数据文件和所有日志信息、作者信息、日期, 以及其它用来重建项目任意版本或分支的信息.</p>
<h3 id="object-store">对象库(Object Store)</h3>
<p>Git对象库中的对象<strong>只有</strong>四种类型: 块(blog), 目录树(tree), 提交(commit)和标签(tag). 这四种原子对象构成Git高层数据结构的基础.</p>
<ul>
<li>
<p><code>块 (Blob)</code> : </p>
<p>文件的每一个版本都表示为一个块(blob). blob 是<code>二进制大对象(binary large object)</code>的缩写. 一个blob保存一个文件的数据, 但不包含任何关于这个文件的元数据, 甚至没有文件名.</p>
</li>
<li>
<p><code>树 (Tree)</code> :</p>
<p>一个目录树(tree)对象代表一层目录信息. 它记录blob标识符, 路径名和在一个目录下所有文件的一些元数据. 它可以递归引用其它目录树或子树对象, 从而建立一个包含文件和子目录的完整层次结构.</p>
</li>
<li>
<p><code>提交 (Commit)</code> :</p>
<p>一个提交(commit)对象保存版本库中每一次变化的元数据, 包括作者、提交者、提交日期和日志消息. 每一个提交对象指向一个目录树对象, 这个目录树对象在一张完整的快照中捕获提交时版本库的状态.</p>
</li>
<li>
<p><code>标签 (Tag)</code> :</p>
<p>一个标签对象分配一个任意的且human readable的名字给一个特定对象, 通常是一个提交对象.</p>
</li>
</ul>
<p>对象库会随着项目的开发一直变化和增长, 为了有效利用磁盘空间和网络带宽, Git把对象压缩并存储在<code>打包文件(pack file)</code>里, 这些文件也在对象库里.</p>
<h3 id="index">索引(Index)</h3>
<p>索引, 又称<code>暂存区(Stage)</code>, 是一个临时的、动态的二进制文件.</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">file</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">index</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">index</span><span class="o">:</span> <span class="n">data</span>
</pre></div>


<p>它捕获项目在某个时刻的整体结构的一个版本.</p>
<p>下面是一个简单的git object内部dag图, 经过两次的提交, 非常清晰(摘自书上图4-2):</p>
<p><img alt="Figure 4-2. Git objects after a second commit" src="https://tankywoo-wb.b0.upaiyun.com/git-4-2.png!small" /></p>
<h3 id="_1">可寻址内容名称</h3>
<p>Git对象库被组织及实现成一个内容可寻址的存储系统. 对象库中每个对象都有一个唯一的名称, 这个名称是向对象的内容应用sha1得到的<code>sha1散列值</code>, sha1值是一个160位的数, 通常表示为一个40位的十六进制数.</p>
<h3 id="git">Git追踪内容</h3>
<p>Git不仅是一个VCS, 还是一个内容追踪系统(content tracking system). 主要表现为两个方式:</p>
<ul>
<li>
<p>Git的对象库基于其对象内容的散列计算的值, 而不是基于用户的原始文件布局的文件名或目录的设置.</p>
<p>Git追踪的是内容而不是文件, 如果两个文件的内容完全一样, 无论是否在相同的目录, Git在对象库里只保存一份blob形式的内容副本.</p>
</li>
<li>
<p>当文件从一个版本变到下一个版本时, Git的内部数据库有效地存储每个文件的每个版本, 而不是他们的差异.</p>
</li>
</ul>
<h3 id="pack-file">打包文件(pack file)</h3>
<p>之前提到的, git 会存储每个文件的每一个版本.</p>
<p>但是, 这个并不是绝对的, 比如一个大文件, 每次只修改其中一行, 那么, 经过多次修改后, 这个文件的各个blob会占用非常大的空间.</p>
<p>实际上git不会这么笨的, git有一个有效的存储机制, 叫做 <code>打包文件(pack file)</code>.</p>
<p>git 往磁盘保存对象时默认使用的格式叫松散对象 (loose object) 格式</p>
<p>git 时不时地将这些对象打包至一个叫 packfile 的二进制文件以节省空间并提高效率.</p>
<p>经过打包后, git会存储文件的最新版本, 其余的版本都以差异形式存储(<code>delta</code>)</p>
<p>例子:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">init</span>
<span class="err">$</span> <span class="n">echo</span> <span class="err">&#39;</span><span class="n">hello</span><span class="err">&#39;</span> <span class="o">&gt;</span> <span class="n">hello</span><span class="p">.</span><span class="n">txt</span><span class="p">;</span> <span class="n">git</span> <span class="n">add</span> <span class="n">hello</span><span class="p">.</span><span class="n">txt</span><span class="p">;</span> <span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="err">&#39;</span><span class="n">add</span> <span class="n">hello</span><span class="p">.</span><span class="n">txt</span><span class="err">&#39;</span>

<span class="err">$</span> <span class="n">tree</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span>
<span class="err">├──</span> <span class="mi">0</span><span class="n">b</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="mi">9</span><span class="n">d7dbd4e9e2b8be42ebe043083937acd52fccf</span>
<span class="err">├──</span> <span class="n">aa</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="n">a96ced2d9a1c8e72c56b253a0e2fe78393feb7</span>
<span class="err">├──</span> <span class="n">ce</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="mo">013625030</span><span class="n">ba8dba906f756967f9e9ca394464a</span>
<span class="err">├──</span> <span class="n">info</span>
<span class="err">└──</span> <span class="n">pack</span>

<span class="mi">5</span> <span class="n">directories</span><span class="p">,</span> <span class="mi">3</span> <span class="n">files</span>

<span class="cp"># 将Python自带的BaseHTTPServer.py加到仓库里</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">add</span> <span class="n">BaseHTTPServer</span><span class="p">.</span><span class="n">py</span><span class="p">;</span> <span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="err">&#39;</span><span class="n">add</span> <span class="n">BaseHTTPServer</span><span class="p">.</span><span class="n">py</span><span class="err">&#39;</span>

<span class="err">$</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span> <span class="n">BaseHTTPServer</span><span class="p">.</span><span class="n">py</span>
     <span class="mi">603</span> <span class="n">BaseHTTPServer</span><span class="p">.</span><span class="n">py</span>

<span class="cp"># mac os 下 du 没有 -b 参数</span>
<span class="err">$</span> <span class="n">stat</span> <span class="o">-</span><span class="n">f</span><span class="o">%</span><span class="n">z</span> <span class="n">BaseHTTPServer</span><span class="p">.</span><span class="n">py</span>
<span class="mi">22461</span>

<span class="err">$</span> <span class="n">tree</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span>
<span class="err">├──</span> <span class="mo">04</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="mf">0f</span><span class="n">c62ff827be04d5def454bfef3ef8c49ea488</span>
<span class="err">├──</span> <span class="mi">0</span><span class="n">b</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="mi">9</span><span class="n">d7dbd4e9e2b8be42ebe043083937acd52fccf</span>
<span class="err">├──</span> <span class="mi">25</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="n">fc7b5d264c24fed7f7a843fbe9ae3224a07de8</span>
<span class="err">├──</span> <span class="n">aa</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="n">a96ced2d9a1c8e72c56b253a0e2fe78393feb7</span>
<span class="err">├──</span> <span class="n">ce</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="mo">013625030</span><span class="n">ba8dba906f756967f9e9ca394464a</span>
<span class="err">├──</span> <span class="n">de</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="n">af2f960b83c76b38b0c494db91202c70886833</span>
<span class="err">├──</span> <span class="n">info</span>
<span class="err">└──</span> <span class="n">pack</span>

<span class="mi">8</span> <span class="n">directories</span><span class="p">,</span> <span class="mi">6</span> <span class="n">files</span>

<span class="cp"># 找到blob id是 deaf2f960b83c76b38b0c494db91202c70886833</span>
<span class="cp"># 显示的大小是字节, 这个是经过压缩的大小</span>
<span class="err">$</span> <span class="n">stat</span> <span class="o">-</span><span class="n">f</span><span class="o">%</span><span class="n">z</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">de</span><span class="o">/</span><span class="n">af2f960b83c76b38b0c494db91202c70886833</span>
<span class="mi">8569</span>

<span class="cp"># 添加一行</span>
<span class="err">$</span> <span class="n">echo</span> <span class="err">&#39;</span><span class="n">a</span> <span class="n">new</span> <span class="n">line</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">BaseHTTPServer</span><span class="p">.</span><span class="n">py</span><span class="p">;</span> <span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="err">&#39;</span><span class="n">add</span> <span class="n">a</span> <span class="n">new</span> <span class="n">line</span><span class="err">&#39;</span> <span class="n">BaseHTTPServer</span><span class="p">.</span><span class="n">py</span>

<span class="err">$</span> <span class="n">find</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span> <span class="o">-</span><span class="n">type</span> <span class="n">f</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="mo">04</span><span class="o">/</span><span class="mf">0f</span><span class="n">c62ff827be04d5def454bfef3ef8c49ea488</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="mi">0</span><span class="n">b</span><span class="o">/</span><span class="mi">9</span><span class="n">d7dbd4e9e2b8be42ebe043083937acd52fccf</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="mi">25</span><span class="o">/</span><span class="n">fc7b5d264c24fed7f7a843fbe9ae3224a07de8</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="mi">28</span><span class="o">/</span><span class="mf">5f</span><span class="n">b1a7ab0bcfe01588ad548ac96187366e8c74</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="mi">3</span><span class="n">b</span><span class="o">/</span><span class="mf">119f</span><span class="mi">80</span><span class="n">b81e4483b12812eb72ebb2df338adbc5</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="mi">95</span><span class="o">/</span><span class="mi">16</span><span class="n">bba0fea3fb039a6e028fb975bb35d158626f</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">aa</span><span class="o">/</span><span class="n">a96ced2d9a1c8e72c56b253a0e2fe78393feb7</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">ce</span><span class="o">/</span><span class="mo">013625030</span><span class="n">ba8dba906f756967f9e9ca394464a</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">de</span><span class="o">/</span><span class="n">af2f960b83c76b38b0c494db91202c70886833</span>

<span class="cp"># 新的blob id是 9516bba0fea3fb039a6e028fb975bb35d158626f</span>
<span class="err">$</span> <span class="n">stat</span> <span class="o">-</span><span class="n">f</span><span class="o">%</span><span class="n">z</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="mi">95</span><span class="o">/</span><span class="mi">16</span><span class="n">bba0fea3fb039a6e028fb975bb35d158626f</span>
<span class="mi">8575</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">gc</span>
<span class="n">Counting</span> <span class="n">objects</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span> <span class="n">done</span><span class="p">.</span>
<span class="n">Delta</span> <span class="n">compression</span> <span class="n">using</span> <span class="n">up</span> <span class="n">to</span> <span class="mi">4</span> <span class="n">threads</span><span class="p">.</span>
<span class="n">Compressing</span> <span class="n">objects</span><span class="o">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">7</span><span class="o">/</span><span class="mi">7</span><span class="p">),</span> <span class="n">done</span><span class="p">.</span>
<span class="n">Writing</span> <span class="n">objects</span><span class="o">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">9</span><span class="o">/</span><span class="mi">9</span><span class="p">),</span> <span class="n">done</span><span class="p">.</span>
<span class="n">Total</span> <span class="mi">9</span> <span class="p">(</span><span class="n">delta</span> <span class="mi">1</span><span class="p">),</span> <span class="n">reused</span> <span class="mi">0</span> <span class="p">(</span><span class="n">delta</span> <span class="mi">0</span><span class="p">)</span>

<span class="err">$</span> <span class="n">tree</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span>
<span class="err">├──</span> <span class="n">info</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="n">packs</span>
<span class="err">└──</span> <span class="n">pack</span>
    <span class="err">├──</span> <span class="n">pack</span><span class="o">-</span><span class="n">dde2d3ff207bb65df9a3a3d2f4f6e088a18622ad</span><span class="p">.</span><span class="n">idx</span>
    <span class="err">└──</span> <span class="n">pack</span><span class="o">-</span><span class="n">dde2d3ff207bb65df9a3a3d2f4f6e088a18622ad</span><span class="p">.</span><span class="n">pack</span>

<span class="mi">2</span> <span class="n">directories</span><span class="p">,</span> <span class="mi">3</span> <span class="n">files</span>

<span class="err">$</span> <span class="n">more</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">info</span><span class="o">/</span><span class="n">packs</span>
<span class="n">P</span> <span class="n">pack</span><span class="o">-</span><span class="n">dde2d3ff207bb65df9a3a3d2f4f6e088a18622ad</span><span class="p">.</span><span class="n">pack</span>

<span class="err">$</span> <span class="n">stat</span> <span class="o">-</span><span class="n">f</span><span class="o">%</span><span class="n">z</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">pack</span><span class="o">/</span><span class="n">pack</span><span class="o">-</span><span class="n">dde2d3ff207bb65df9a3a3d2f4f6e088a18622ad</span><span class="p">.</span><span class="n">idx</span>
<span class="mi">1324</span>
<span class="err">$</span> <span class="n">stat</span> <span class="o">-</span><span class="n">f</span><span class="o">%</span><span class="n">z</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">pack</span><span class="o">/</span><span class="n">pack</span><span class="o">-</span><span class="n">dde2d3ff207bb65df9a3a3d2f4f6e088a18622ad</span><span class="p">.</span><span class="n">pack</span>
<span class="mi">8334</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">verify</span><span class="o">-</span><span class="n">pack</span> <span class="o">-</span><span class="n">v</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">pack</span><span class="o">/</span><span class="n">pack</span><span class="o">-</span><span class="n">dde2d3ff207bb65df9a3a3d2f4f6e088a18622ad</span><span class="p">.</span><span class="n">idx</span>
<span class="mi">3</span><span class="n">b119f80b81e4483b12812eb72ebb2df338adbc5</span> <span class="n">commit</span> <span class="mi">221</span> <span class="mi">155</span> <span class="mi">12</span>
<span class="mf">25f</span><span class="n">c7b5d264c24fed7f7a843fbe9ae3224a07de8</span> <span class="n">commit</span> <span class="mi">228</span> <span class="mi">163</span> <span class="mi">167</span>
<span class="mi">0</span><span class="n">b9d7dbd4e9e2b8be42ebe043083937acd52fccf</span> <span class="n">commit</span> <span class="mi">172</span> <span class="mi">125</span> <span class="mi">330</span>
<span class="mi">9516</span><span class="n">bba0fea3fb039a6e028fb975bb35d158626f</span> <span class="n">blob</span>   <span class="mi">22472</span> <span class="mi">7596</span> <span class="mi">455</span>
<span class="n">ce013625030ba8dba906f756967f9e9ca394464a</span> <span class="n">blob</span>   <span class="mi">6</span> <span class="mi">15</span> <span class="mi">8051</span>
<span class="mf">285f</span><span class="n">b1a7ab0bcfe01588ad548ac96187366e8c74</span> <span class="n">tree</span>   <span class="mi">82</span> <span class="mi">90</span> <span class="mi">8066</span>
<span class="mf">040f</span><span class="n">c62ff827be04d5def454bfef3ef8c49ea488</span> <span class="n">tree</span>   <span class="mi">82</span> <span class="mi">90</span> <span class="mi">8156</span>
<span class="n">deaf2f960b83c76b38b0c494db91202c70886833</span> <span class="n">blob</span>   <span class="mi">9</span> <span class="mi">20</span> <span class="mi">8246</span> <span class="mi">1</span> <span class="mi">9516</span><span class="n">bba0fea3fb039a6e028fb975bb35d158626f</span>
<span class="n">aaa96ced2d9a1c8e72c56b253a0e2fe78393feb7</span> <span class="n">tree</span>   <span class="mi">37</span> <span class="mi">48</span> <span class="mi">8266</span>
<span class="n">non</span> <span class="n">delta</span><span class="o">:</span> <span class="mi">8</span> <span class="n">objects</span>
<span class="n">chain</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span> <span class="mi">1</span> <span class="n">object</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">pack</span><span class="o">/</span><span class="n">pack</span><span class="o">-</span><span class="n">dde2d3ff207bb65df9a3a3d2f4f6e088a18622ad</span><span class="p">.</span><span class="n">pack</span><span class="o">:</span> <span class="n">ok</span>
</pre></div>


<p><code>git verify-pack</code>是用于验证pack文件的, 查看man手册里输出格式说明:</p>
<div class="hlcode"><pre><span class="n">When</span> <span class="n">specifying</span> <span class="n">the</span> <span class="o">-</span><span class="n">v</span> <span class="n">option</span> <span class="n">the</span> <span class="n">format</span> <span class="n">used</span> <span class="n">is</span><span class="o">:</span>

   <span class="n">SHA</span><span class="o">-</span><span class="mi">1</span> <span class="n">type</span> <span class="n">size</span> <span class="n">size</span><span class="o">-</span><span class="n">in</span><span class="o">-</span><span class="n">pack</span><span class="o">-</span><span class="n">file</span> <span class="n">offset</span><span class="o">-</span><span class="n">in</span><span class="o">-</span><span class="n">packfile</span>

<span class="k">for</span> <span class="n">objects</span> <span class="n">that</span> <span class="n">are</span> <span class="n">not</span> <span class="n">deltified</span> <span class="n">in</span> <span class="n">the</span> <span class="n">pack</span><span class="p">,</span> <span class="n">and</span>

   <span class="n">SHA</span><span class="o">-</span><span class="mi">1</span> <span class="n">type</span> <span class="n">size</span> <span class="n">size</span><span class="o">-</span><span class="n">in</span><span class="o">-</span><span class="n">packfile</span> <span class="n">offset</span><span class="o">-</span><span class="n">in</span><span class="o">-</span><span class="n">packfile</span> <span class="n">depth</span> <span class="n">base</span><span class="o">-</span><span class="n">SHA</span><span class="o">-</span><span class="mi">1</span>
</pre></div>


<p>对比上面的输出, 可以看到, BaseHTTPServer.py的第一个版本就是 @deaf2f96, 它的base-SHA-1是 @9516bba0, 且 @deaf2f96 的大小只有9bytes, pack中的压缩后大小是20, 而新的blob在pack中的大小是22472字节. pack中的大小是7596</p>
<p>第二个版本是完整保存文件内容的对象, 而第一个版本是以差异方式保存的, 这是因为大部分情况下需要快速访问文件的最新版本.</p>
<p>git 自动定期对仓库进行重新打包以节省空间. 也可以手工运行 git gc 命令来这么做.</p>
<p>参考:</p>
<ul>
<li>Pro Git: Git Internals - Packfiles <a href="https://git-scm.com/book/zh/v1/Git-%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86-Packfiles">zh</a> | <a href="https://git-scm.com/book/en/v2/Git-Internals-Packfiles">en</a></li>
<li>Git Community Book <a href="http://gitbook.liuhui998.com/7_5.html">zh</a> | <a href="https://schacon.github.io/gitbook/7_the_packfile.html">en</a></li>
</ul>
<p>另外, 在 pro git那一章还学到一个命令:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">cat</span><span class="o">-</span><span class="n">file</span> <span class="o">-</span><span class="n">p</span> <span class="n">master</span><span class="o">^</span><span class="p">{</span><span class="n">tree</span><span class="p">}</span>
</pre></div>


<p>和下面效果一样:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">ls</span><span class="o">-</span><span class="n">tree</span> <span class="n">master</span>
</pre></div>


<h3 id="_2">底层命令例子</h3>
<p>以下例子使用的基本都是Git的底层命令, 在实际使用中, 有更简单的命令封装了这些底层命令, 不过通过底层命令, 可以更清晰的了解Git的工作流程.</p>
<ul>
<li><code>git cat-file</code></li>
<li><code>git write-tree</code></li>
<li><code>git commit-tree</code></li>
<li><code>git rev-parse</code></li>
<li><code>git ls-files</code></li>
</ul>
<p>初始化的Git仓库:</p>
<div class="hlcode"><pre><span class="cp"># An initial git repo</span>
<span class="err">$</span> <span class="n">find</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">info</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">pack</span>
</pre></div>


<p>新建一个文件a.txt, 内容是 'hello', sha1值 ce013625030ba8dba906f756967f9e9ca394464a, 使用<code>git cat-file</code>查看散列的内容:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">echo</span> <span class="err">&#39;</span><span class="n">hello</span><span class="err">&#39;</span> <span class="o">&gt;</span> <span class="n">a</span><span class="p">.</span><span class="n">txt</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">add</span> <span class="n">a</span><span class="p">.</span><span class="n">txt</span>
<span class="err">$</span> <span class="n">find</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">ce</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">ce</span><span class="o">/</span><span class="mo">013625030</span><span class="n">ba8dba906f756967f9e9ca394464a</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">info</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span><span class="o">/</span><span class="n">pack</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">cat</span><span class="o">-</span><span class="n">file</span> <span class="o">-</span><span class="n">p</span> <span class="n">ce013625030ba8dba906f756967f9e9ca394464a</span>
<span class="n">hello</span>
</pre></div>


<p>使用<code>git ls-files</code>查看staged信息:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">ls</span><span class="o">-</span><span class="n">files</span> <span class="o">-</span><span class="n">s</span>
<span class="mi">100644</span> <span class="n">ce013625030ba8dba906f756967f9e9ca394464a</span> <span class="mi">0</span>       <span class="n">a</span><span class="p">.</span><span class="n">txt</span>
</pre></div>


<p>捕获索引状态并保存到一个树对象:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">write</span><span class="o">-</span><span class="n">tree</span>
<span class="mf">2e81171448</span><span class="n">eb9f2ee3821e3d447aa6b2fe3ddba1</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">cat</span><span class="o">-</span><span class="n">file</span> <span class="o">-</span><span class="n">p</span> <span class="mf">2e81171448</span><span class="n">eb9f2ee3821e3d447aa6b2fe3ddba1</span>
<span class="mi">100644</span> <span class="n">blob</span> <span class="n">ce013625030ba8dba906f756967f9e9ca394464a</span>    <span class="n">a</span><span class="p">.</span><span class="n">txt</span>
</pre></div>


<p>现在增加文件b.txt, 内容和a.txt一样, 可以看到, 两个使用同一个blob:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">echo</span> <span class="err">&#39;</span><span class="n">hello</span><span class="err">&#39;</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">.</span><span class="n">txt</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">add</span> <span class="n">b</span><span class="p">.</span><span class="n">txt</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">write</span><span class="o">-</span><span class="n">tree</span>
<span class="n">b5b0cccf7401633f12e0fafc6b85731251b86850</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">cat</span><span class="o">-</span><span class="n">file</span> <span class="o">-</span><span class="n">p</span> <span class="n">b5b0cccf7401633f12e0fafc6b85731251b86850</span>
<span class="mi">100644</span> <span class="n">blob</span> <span class="n">ce013625030ba8dba906f756967f9e9ca394464a</span>    <span class="n">a</span><span class="p">.</span><span class="n">txt</span>
<span class="mi">100644</span> <span class="n">blob</span> <span class="n">ce013625030ba8dba906f756967f9e9ca394464a</span>    <span class="n">b</span><span class="p">.</span><span class="n">txt</span>
</pre></div>


<p>现在改变文件a.txt内容, b.txt还是指向原来的blob:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">echo</span> <span class="err">&#39;</span><span class="n">world</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">a</span><span class="p">.</span><span class="n">txt</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">add</span> <span class="n">a</span><span class="p">.</span><span class="n">txt</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">write</span><span class="o">-</span><span class="n">tree</span>
<span class="mi">579</span><span class="n">c3877d5f450e34ea642b3a29d2d01dcf8e392</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">cat</span><span class="o">-</span><span class="n">file</span> <span class="o">-</span><span class="n">p</span> <span class="mi">579</span><span class="n">c3877d5f450e34ea642b3a29d2d01dcf8e392</span>
<span class="mi">100644</span> <span class="n">blob</span> <span class="mi">94954</span><span class="n">abda49de8615a048f8d2e64b5de848e27a1</span>    <span class="n">a</span><span class="p">.</span><span class="n">txt</span>
<span class="mi">100644</span> <span class="n">blob</span> <span class="n">ce013625030ba8dba906f756967f9e9ca394464a</span>    <span class="n">b</span><span class="p">.</span><span class="n">txt</span>
</pre></div>


<p>添加一个子目录, 里面也放一个a.txt, 内容一样:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">mkdir</span> <span class="n">subdir</span>
<span class="err">$</span> <span class="n">cp</span> <span class="n">a</span><span class="p">.</span><span class="n">txt</span> <span class="n">subdir</span><span class="o">/</span>
<span class="err">$</span> <span class="n">tree</span>
<span class="p">.</span>
<span class="err">├──</span> <span class="n">a</span><span class="p">.</span><span class="n">txt</span>
<span class="err">└──</span> <span class="n">subdir</span>
    <span class="err">└──</span> <span class="n">a</span><span class="p">.</span><span class="n">txt</span>

<span class="mi">1</span> <span class="n">directory</span><span class="p">,</span> <span class="mi">2</span> <span class="n">files</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">add</span> <span class="n">subdir</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">txt</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">ls</span><span class="o">-</span><span class="n">files</span> <span class="o">-</span><span class="n">s</span>
<span class="mi">100644</span> <span class="n">ce013625030ba8dba906f756967f9e9ca394464a</span> <span class="mi">0</span>       <span class="n">a</span><span class="p">.</span><span class="n">txt</span>
<span class="mi">100644</span> <span class="n">ce013625030ba8dba906f756967f9e9ca394464a</span> <span class="mi">0</span>       <span class="n">subdir</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">txt</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">write</span><span class="o">-</span><span class="n">tree</span>
<span class="n">ec518d6bb3cabb8e88b5458cf18d862aa0514622</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">cat</span><span class="o">-</span><span class="n">file</span> <span class="o">-</span><span class="n">p</span> <span class="n">ec518d6bb3cabb8e88b5458cf18d862aa0514622</span>
<span class="mi">100644</span> <span class="n">blob</span> <span class="n">ce013625030ba8dba906f756967f9e9ca394464a</span>    <span class="n">a</span><span class="p">.</span><span class="n">txt</span>
<span class="mo">040000</span> <span class="n">tree</span> <span class="mf">2e81171448</span><span class="n">eb9f2ee3821e3d447aa6b2fe3ddba1</span>    <span class="n">subdir</span>
</pre></div>


<p>可以看到, subdir这个tree对象的sha1 id和之前父目录是一样的.</p>
<p>现在a.txt的blob已经有了, 树对象也有了, 接着就是提交:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">echo</span> <span class="o">-</span><span class="n">n</span> <span class="err">&#39;</span><span class="n">commit</span> <span class="n">a</span> <span class="n">file</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">git</span> <span class="n">commit</span><span class="o">-</span><span class="n">tree</span> <span class="n">ec518d6bb3cabb8e88b5458cf18d862aa0514622</span>
<span class="mi">7</span><span class="n">dc4ee9984a52278b3b67480feb712e36ea5a64c</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">cat</span><span class="o">-</span><span class="n">file</span> <span class="o">-</span><span class="n">p</span> <span class="mi">7</span><span class="n">dc4ee9984a52278b3b67480feb712e36ea5a64c</span>
<span class="n">tree</span> <span class="n">ec518d6bb3cabb8e88b5458cf18d862aa0514622</span>
<span class="n">author</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">me</span><span class="err">@</span><span class="n">tankywoo</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span> <span class="mi">1431832347</span> <span class="o">+</span><span class="mi">0800</span>
<span class="n">committer</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">me</span><span class="err">@</span><span class="n">tankywoo</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span> <span class="mi">1431832347</span> <span class="o">+</span><span class="mi">0800</span>

<span class="n">commit</span> <span class="n">a</span> <span class="n">file</span><span class="o">%</span>
</pre></div>


<p><code>author</code> vs <code>committer</code>(引用 <a href="http://git-scm.com/book/ch2-3.html">Pro Git</a>)</p>
<blockquote>
<p>The author is the person who originally wrote the patch, whereas the committer is the person who last applied the patch. So, if you send in a patch to a project and one of the core members applies the patch, both of you get credit — you as the author and the core member as the committer.</p>
</blockquote>
<p>更详细的<a href="http://stackoverflow.com/a/18754896/1276501">解释</a></p>
<p>打标签:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">tag</span> <span class="o">-</span><span class="n">m</span> <span class="err">&#39;</span><span class="n">add</span> <span class="n">tag</span> <span class="n">v1</span><span class="mf">.0</span><span class="err">&#39;</span> <span class="n">v1</span><span class="mf">.0</span> <span class="mi">7</span><span class="n">dc4ee9984a52278b3b67480feb712e36ea5a64c</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">rev</span><span class="o">-</span><span class="n">parse</span> <span class="n">v1</span><span class="mf">.0</span>
<span class="mi">76</span><span class="n">a2a639a517e26a6c79fdcd09c0a5ffec97e099</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">cat</span><span class="o">-</span><span class="n">file</span> <span class="o">-</span><span class="n">p</span> <span class="n">v1</span><span class="mf">.0</span>
<span class="n">object</span> <span class="mi">7</span><span class="n">dc4ee9984a52278b3b67480feb712e36ea5a64c</span>
<span class="n">type</span> <span class="n">commit</span>
<span class="n">tag</span> <span class="n">v1</span><span class="mf">.0</span>
<span class="n">tagger</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">me</span><span class="err">@</span><span class="n">tankywoo</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span> <span class="mi">1431832535</span> <span class="o">+</span><span class="mi">0800</span>

<span class="n">add</span> <span class="n">tag</span> <span class="n">v1</span><span class="mf">.0</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">cat</span><span class="o">-</span><span class="n">file</span> <span class="o">-</span><span class="n">p</span> <span class="mi">76</span><span class="n">a2a639a517e26a6c79fdcd09c0a5ffec97e099</span>
<span class="n">object</span> <span class="mi">7</span><span class="n">dc4ee9984a52278b3b67480feb712e36ea5a64c</span>
<span class="n">type</span> <span class="n">commit</span>
<span class="n">tag</span> <span class="n">v1</span><span class="mf">.0</span>
<span class="n">tagger</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">me</span><span class="err">@</span><span class="n">tankywoo</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span> <span class="mi">1431832535</span> <span class="o">+</span><span class="mi">0800</span>

<span class="n">add</span> <span class="n">tag</span> <span class="n">v1</span><span class="mf">.0</span>
</pre></div>


<hr />
<h2 id="5">5. 文件管理和索引</h2>
<p>关于文件管理, 与其它版本管理系统类似, 不过Git在<code>工作目录(working directory)</code>与<code>版本库(repository)</code>之间, 增加了一个<code>Index(Stage)</code>层, 称为<code>索引(暂存)</code>目录. 在工作目录下编辑, 在索引中积累修改, 然后把索引中积累的修改作为一次性的变更来进行提交.</p>
<p><img alt="Git process" src="https://marklodato.github.io/visual-git-guide/basic-usage-2.svg" /></p>
<p>(图片引用 <a href="https://marklodato.github.io/visual-git-guide/index-zh-cn.html">图解Git</a>)</p>
<p><img alt="The lifecycle of the status of your files" src="https://tankywoo-wb.b0.upaiyun.com/git-5-lifecycle.png!small" /></p>
<p>(图片引用 <a href="https://git-scm.com/book/en/v2/Git-Basics-Recording-Changes-to-the-Repository">Pro Git - 2.2</a>)</p>
<blockquote>
<p>Linus Torvalds 在git mailing list里提到，如果不先理解Index的目的，就无法理解和领会Git的强大.</p>
</blockquote>
<p>Git 的Index不存放任何文件的内容，它只简单的记录准备提交的文件，当运行<code>git commit</code>时，git 会检查Index而不是工作目录.</p>
<p>Git 把文件分为三个大类: <code>已追踪(Tracked)</code>, <code>未追踪(Untracked)</code>和<code>被忽略(Ignored)</code>，其中<code>Tracked</code>又可以分为<code>暂存(Staged)</code> 和 <code>未暂存(Unstaged)</code>，在工作目录下修改Tracked的文件是Unstaged，经过<code>git add</code>后变为Staged.</p>
<p><code>git ls-files --stage</code> 可以查看stage中的文件的<code>sha1</code>值:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">ls</span><span class="o">-</span><span class="n">files</span> <span class="o">--</span><span class="n">stage</span>  <span class="err">#</span> <span class="err">或</span> <span class="n">git</span> <span class="n">ls</span><span class="o">-</span><span class="n">files</span> <span class="o">-</span><span class="n">s</span>
<span class="mi">100644</span> <span class="mi">8</span><span class="n">d0e41234f24b6da002d962a26c2495ea16a425f</span> <span class="mi">0</span>       <span class="n">fa</span>
</pre></div>


<p><code>git hash-object</code>可以计算文件的<code>sha1</code>值并输出:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">hash</span><span class="o">-</span><span class="n">object</span> <span class="n">fa</span>
<span class="mi">8</span><span class="n">d0e41234f24b6da002d962a26c2495ea16a425f</span>
</pre></div>


<p>简单的说是文件fa已经在 索引(index) 中了，本质是文件在 对象库(object store) 中，Index指向它.</p>
<p>关于 <code>--all</code> 在 <code>git add</code> 和 <code>git commit</code>中有点区别，文件必须要经过add才会被tracked，<code>git add --all</code> 会把所有tracked 和 untracked的文件都add，但是<code>git commit --all</code>只会add所有tracked的文件并提交.</p>
<p>关于<code>git rm</code>，如果tracked中的文件被修改了，则可以通过<code>git rm --cached</code>来从git库中移除，并在本地保存为untracked的，也可以通过<code>-f</code>强制删除.</p>
<p>对于被误删的文件，如果在Index中，如下:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="nx">git</span> <span class="nb">status</span>
<span class="err">#</span> <span class="k">On</span> <span class="nx">branch</span> <span class="nx">master</span>
<span class="err">#</span> <span class="nx">Changes</span> <span class="k">to</span> <span class="nx">be</span> <span class="nx">committed</span><span class="p">:</span>
<span class="err">#</span>   <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git reset HEAD &lt;file&gt;...&quot;</span> <span class="k">to</span> <span class="nx">unstage</span><span class="p">)</span>
<span class="err">#</span>
<span class="err">#</span>       <span class="nx">deleted</span><span class="p">:</span>    <span class="nx">fa</span>
<span class="err">#</span>
</pre></div>


<p>可以通过如下方式之一来返回:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">checkout</span> <span class="n">HEAD</span> <span class="o">--</span> <span class="n">fa</span>

<span class="cp"># 或者</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">reset</span> <span class="n">HEAD</span> <span class="n">fa</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">checkout</span> <span class="o">--</span> <span class="n">fa</span>
</pre></div>


<p>如果是移除被提交，则可以通过<code>git reset HEAD^</code>或rebase来取回.</p>
<p>关于<code>git mv</code>，等价于:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">mv</span> <span class="n">fa</span> <span class="n">fb</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">rm</span> <span class="n">fa</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">add</span> <span class="n">fb</span>
</pre></div>


<p>Git 把文件fa改为fb，会在<code>object store</code>中保存原始的文件内容，然后把文件名(路径名path)重新关联到这个内容:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">ls</span><span class="o">-</span><span class="n">files</span> <span class="o">--</span><span class="n">stage</span>
<span class="mi">100644</span> <span class="mi">15</span><span class="n">acaeb140c2805acdbb2d0dbdedeeea6bb73b06</span> <span class="mi">0</span>       <span class="n">fa</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">mv</span> <span class="n">fa</span> <span class="n">fb</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">ls</span><span class="o">-</span><span class="n">files</span> <span class="o">--</span><span class="n">stage</span>
<span class="mi">100644</span> <span class="mi">15</span><span class="n">acaeb140c2805acdbb2d0dbdedeeea6bb73b06</span> <span class="mi">0</span>       <span class="n">fb</span>
</pre></div>


<p>把fa改为fb后，sha1值并没变.</p>
<p>经过mv操作后，使用<code>git log fb</code>只会看到变更后的提交(包括变更的那个提交)，即关联内容并为fb文件的历史，可以通过<code>--follow</code>选项来查看关联这段内容的完整历史:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">follow</span> <span class="n">fb</span>
</pre></div>


<p>关于 <code>.gitignore</code> 文件, 简单语法:</p>
<ul>
<li>忽略空行, <code>#</code> <strong>开头</strong> 作为注释, 如果跟在其它文本后面, 则不是注释</li>
<li>简单的字符文件名匹配任何目录下的同名文件或<strong>目录</strong></li>
<li>目录名由反斜线<code>/</code>结尾, 表示只匹配同名的目录, 不匹配文件和软链接</li>
<li><code>*</code>作为通配符, 类似shell</li>
<li>感叹号<code>!</code>表示对改行其余部分的模式取反</li>
</ul>
<p>Git版本库中任何目录下都可以有.gitignore文件, 且只影响当前目录及子目录. 作用规则是<strong>级联</strong>的, 可以覆盖父级以上的规则.</p>
<p>另外Git有多个地方可以影响ignore文件, 所以有优先级关系(从高到低):</p>
<ul>
<li>命令行中指定的模式</li>
<li>当前目录下.gitignore文件中的模式</li>
<li>父级以上目录中.gitignore文件中的模式</li>
<li><code>.git/info/exclude</code>文件中的模式</li>
<li>环境配置<code>core.excludedfile</code>指定文件中的模式</li>
</ul>
<p>A Detailed View of Git’s Object Model and Files 一节对 Git中对象模型和文件的详细视图, 把一次从 干净-&gt;编辑-&gt;add-&gt;commit 的原理图画出来了, 讲得非常好:</p>
<p>Figure 5-1. Initial files and objects:</p>
<p><img alt="Figure 5-1. Initial files and objects" src="https://tankywoo-wb.b0.upaiyun.com/git-5-1.png!small" /></p>
<p>Figure 5-2. After editing file1:</p>
<p><img alt="Figure 5-2. After editing file1" src="https://tankywoo-wb.b0.upaiyun.com/git-5-2.png!small" /></p>
<p>Figure 5-3. After git add:</p>
<p><img alt="Figure 5-3. After git add" src="https://tankywoo-wb.b0.upaiyun.com/git-5-3.png!small" /></p>
<p>Figure 5-4. After git commit:</p>
<p><img alt="Figure 5-4. After git commit" src="https://tankywoo-wb.b0.upaiyun.com/git-5-4.png!small" /></p>
<p>关于索引, 更多可以参考:</p>
<ul>
<li><a href="http://www.worldhello.net/2010/11/30/2166.html">Git权威指南</a></li>
<li><a href="http://gitbook.liuhui998.com/7_4.html">Git Community Book</a></li>
<li><a href="http://www.gitguys.com/topics/whats-the-deal-with-the-git-index/?lang=zh">GitGuys - 什么是Git Index?</a></li>
<li><a href="https://marklodato.github.io/visual-git-guide/index-zh-cn.html">图解Git</a></li>
<li><a href="http://rogerdudler.github.io/git-guide/index.zh.html">git - 简明指南</a></li>
</ul>
<hr />
<h2 id="6">6. 提交</h2>
<p>当提交时, Git会记录索引的快照并把快照放进对象库.</p>
<p>Git可以通过显示引用(explicit ref)或隐式引用(implied ref)来表示提交. 散列id(sha1)是显示引用, HEAD等是隐式引用.</p>
<p>引用(ref)是一个sha1散列值, 指向Git对象库中的对象.</p>
<p>符号引用(symref) 是一个指向引用的引用(指针), 间接的指向git对象. 有点类似C语言里指针的指针? 和Linux的软链接(soft link)也有点类似?</p>
<p>本地特性分支名, 远程跟踪分支名, 标签名都是引用.</p>
<p>每一个<strike>符号</strike>引用都有一个以 refs/ 开始的明确名称, 并且都分层存储在版本库的<code>.git/refs/</code> 目录中. 基本分为三种:</p>
<ul>
<li>refs/heads/<ref> 代表本地分支</li>
<li>refs/remotes/<ref> 代表远程跟踪分支</li>
<li>refs/tags/<ref> 代表标签</li>
</ul>
<p><strong>注</strong>(2015-07-19更新):</p>
<p>书上说:</p>
<blockquote>
<p>Each symbolic ref has an explicit, full name that begins with refs/ and each is stored hierarchically within the repository in the .git/refs/ directory.</p>
</blockquote>
<p>我查了文档, 并且看了<code>git symbolic-ref</code>的man手册, 发现这里的解释是<strong>错误</strong>的</p>
<p>首先, 关于master, 即 .git/refs/heads/master:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">more</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
<span class="n">f35f166562045569095169d340fec0d16eaef73b</span>
</pre></div>


<p>存储的也是sha1 id, 所以它不是一个符号引用, 而只是一个引用.</p>
<p>另外用<code>git symbolic-ref</code>也可以看到说这不是一个符号引用:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">symbolic</span><span class="o">-</span><span class="n">ref</span> <span class="n">master</span>
<span class="nl">fatal:</span> <span class="n">ref</span> <span class="n">master</span> <span class="n">is</span> <span class="n">not</span> <span class="n">a</span> <span class="n">symbolic</span> <span class="n">ref</span>
</pre></div>


<p>那么, 哪些是符号引用? 暂时只知道默认的有HEAD:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">symbolic</span><span class="o">-</span><span class="n">ref</span> <span class="n">HEAD</span>
<span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>

<span class="err">$</span> <span class="n">more</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">HEAD</span>
<span class="nl">ref:</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
</pre></div>


<p>接着, 符号引用有什么特征? 还是<code>git symbolic-ref</code>的man手册, 写的很清楚:</p>
<div class="hlcode"><pre><span class="n">A</span> <span class="n">symbolic</span> <span class="n">ref</span> <span class="n">is</span> <span class="n">a</span> <span class="n">regular</span> <span class="n">file</span> <span class="n">that</span> <span class="n">stores</span> <span class="n">a</span> <span class="n">string</span> <span class="n">that</span> <span class="n">begins</span> <span class="n">with</span> <span class="err">`</span><span class="n">ref</span><span class="o">:</span> <span class="n">refs</span><span class="o">/</span><span class="err">`</span><span class="p">.</span> <span class="n">For</span> <span class="n">example</span><span class="p">,</span> <span class="n">your</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">HEAD</span> <span class="n">is</span> <span class="n">a</span> <span class="n">regular</span> <span class="n">file</span> <span class="n">whose</span> <span class="n">contents</span> <span class="n">is</span> <span class="err">`</span><span class="n">ref</span><span class="o">:</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span><span class="err">`</span><span class="p">.</span>
</pre></div>


<p>很显然, HEAD符合这个特征.</p>
<p>符号引用也可以自己创建, 还是用上面的命令:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">symbolic</span><span class="o">-</span><span class="n">ref</span> <span class="n">TANKYWOO</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">rev</span><span class="o">-</span><span class="n">parse</span> <span class="n">TANKYWOO</span>
<span class="n">f35f166562045569095169d340fec0d16eaef73b</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">rev</span><span class="o">-</span><span class="n">parse</span> <span class="n">master</span>
<span class="n">f35f166562045569095169d340fec0d16eaef73b</span>
<span class="err">$</span> <span class="n">more</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">TANKYWOO</span>
<span class="nl">ref:</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">symbolic</span><span class="o">-</span><span class="n">ref</span> <span class="n">TANKYWOO</span>
<span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
</pre></div>


<p>(2015-07-19更新 结束)</p>
<p>比如本地分支dev, 就是 refs/heads/dev 的缩写:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">show</span> <span class="n">dev</span>
<span class="n">commit</span> <span class="n">e31b74d259b83af0f69683b9b12a29ebb3946748</span>
<span class="nl">Merge:</span> <span class="mf">12e3223</span> <span class="mi">5488</span><span class="n">c82</span>
<span class="nl">Author:</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">wtq1990</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="nl">Date:</span>   <span class="n">Fri</span> <span class="n">Apr</span> <span class="mi">10</span> <span class="mi">19</span><span class="o">:</span><span class="mi">11</span><span class="o">:</span><span class="mi">27</span> <span class="mi">2015</span> <span class="o">+</span><span class="mi">0800</span>

    <span class="n">Merge</span> <span class="n">branch</span> <span class="err">&#39;</span><span class="n">project</span><span class="o">-</span><span class="n">tools</span><span class="err">&#39;</span> <span class="n">into</span> <span class="n">dev</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">show</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">dev</span>
<span class="n">commit</span> <span class="n">e31b74d259b83af0f69683b9b12a29ebb3946748</span>
<span class="nl">Merge:</span> <span class="mf">12e3223</span> <span class="mi">5488</span><span class="n">c82</span>
<span class="nl">Author:</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">wtq1990</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="nl">Date:</span>   <span class="n">Fri</span> <span class="n">Apr</span> <span class="mi">10</span> <span class="mi">19</span><span class="o">:</span><span class="mi">11</span><span class="o">:</span><span class="mi">27</span> <span class="mi">2015</span> <span class="o">+</span><span class="mi">0800</span>

    <span class="n">Merge</span> <span class="n">branch</span> <span class="err">&#39;</span><span class="n">project</span><span class="o">-</span><span class="n">tools</span><span class="err">&#39;</span> <span class="n">into</span> <span class="n">dev</span>

<span class="err">$</span> <span class="n">more</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">dev</span>
<span class="n">e31b74d259b83af0f69683b9b12a29ebb3946748</span>
</pre></div>


<p>Git 有几个特殊<strike>符号</strike>引用(除了HEAD, 其余都不是符号引用):</p>
<ul>
<li><code>HEAD</code></li>
<li><code>ORIG_HEAD</code></li>
<li><code>FETCH_HEAD</code></li>
<li><code>MERGE_HEAD</code></li>
</ul>
<p><code>HEAD</code>: <code>.git/HEAD</code>, 总是指向当前分支的最后一次提交, 当分支改变，HEAD也会变</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">more</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">HEAD</span>
<span class="nl">ref:</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
</pre></div>


<p><code>ORIG_HEAD</code>: <code>.git/ORIG_HEAD</code>, 一些操作, 如<code>merge</code>或<code>reset</code>, 会记录操前的commit(HEAD). 作为一个保护措施，使操作可以回溯.</p>
<p>比如最近三个commits 以及 此时的ORIG_HEAD(存储的是之前某一个的commit id):</p>
<div class="hlcode"><pre><span class="o">*</span> <span class="n">d46546a</span> <span class="o">-</span> <span class="p">(</span><span class="n">HEAD</span><span class="p">,</span> <span class="n">master</span><span class="p">)</span> <span class="n">update</span> <span class="n">d</span> <span class="p">(</span><span class="mi">42</span> <span class="n">seconds</span> <span class="n">ago</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Tanky</span> <span class="n">Woo</span><span class="o">&gt;</span>
<span class="o">*</span> <span class="mi">8</span><span class="n">ed2d79</span> <span class="o">-</span> <span class="n">update</span> <span class="n">f</span> <span class="p">(</span><span class="mi">76</span> <span class="n">seconds</span> <span class="n">ago</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Tanky</span> <span class="n">Woo</span><span class="o">&gt;</span>
<span class="o">*</span> <span class="mi">75</span><span class="n">b09c2</span> <span class="o">-</span> <span class="p">(</span><span class="n">tag</span><span class="o">:</span> <span class="n">v0</span><span class="mf">.1</span><span class="p">)</span> <span class="n">Merge</span> <span class="n">branch</span> <span class="err">&#39;</span><span class="n">dev</span><span class="err">&#39;</span> <span class="p">(</span><span class="mi">3</span> <span class="n">days</span> <span class="n">ago</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Tanky</span> <span class="n">Woo</span><span class="o">&gt;</span>

<span class="err">$</span> <span class="n">more</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">ORIG_HEAD</span>
<span class="mo">015</span><span class="n">b5b99f5c9973e840f29c9f6e6b936c99b92a5</span>
</pre></div>


<p>做一次reset操作:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">soft</span> <span class="n">HEAD</span><span class="o">^</span>
</pre></div>


<p>查看<code>ORIG_HEAD</code>, 会指向之前的HEAD:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">more</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">ORIG_HEAD</span>
<span class="n">d46546a5192b7e1c834947b612e3401a6f7729c7</span>
</pre></div>


<p>这样就可以回溯到reset之前的版本:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reset</span> <span class="n">ORIG_HEAD</span>
</pre></div>


<p>然后 <code>ORIG_HEAD</code> 又指向 @8ed2d79 这个id</p>
<p><code>HEAD</code> vs <code>ORIG_HEAD</code> <a href="http://stackoverflow.com/questions/964876/head-and-orig-head-in-git">HEAD and ORIG_HEAD in Git</a></p>
<p><code>FETCH_HEAD</code>: <code>.git/FETCH_HEAD</code>, 当使用远程库时, git fetch 命令将所有抓取分支的头记录到这个文件中, 是最近fetch的分支HEAD的简写.</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">fetch</span> <span class="n">origin</span>
<span class="err">$</span> <span class="n">more</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">FETCH_HEAD</span>
<span class="n">f35f166562045569095169d340fec0d16eaef73b</span>                <span class="n">branch</span> <span class="err">&#39;</span><span class="n">master</span><span class="err">&#39;</span> <span class="n">of</span> <span class="n">https</span><span class="o">:</span><span class="c1">//example.com/tankywoo/git-test-symref</span>
</pre></div>


<p><code>MERGE_HEAD</code>: 当一个合并操作正在进行时, 其它分支的头暂时记录在 <code>MERGE_HEAD</code> 中. 即是正在合并进HEAD的提交.</p>
<p><code>git symbolic-ref</code> 操作符号引用:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">symbolic</span><span class="o">-</span><span class="n">ref</span> <span class="n">HEAD</span>
<span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
</pre></div>


<p>详细可以参考<a href="http://git-scm.com/book/en/Git-Internals-Git-References">progit-9.3</a></p>
<p>sha1 id是绝对提交名, 通过<code>~</code>和<code>^</code>则可以代表相对提交名.</p>
<ul>
<li><code>^ (caret)</code> 同一代提交中, 用来选择不同的父提交(比如合并时有多个父提交)</li>
<li><code>~ (tilde)</code> 某个提交的父提交或更上一/N代提交</li>
</ul>
<p>使用前面讲到的<code>git show-branch</code>可以看到每个提交的相对提交名.</p>
<p>例子:</p>
<div class="hlcode"><pre><span class="o">*</span>   <span class="mi">75</span><span class="n">b09c2</span> <span class="o">-</span> <span class="p">(</span><span class="n">HEAD</span><span class="p">,</span> <span class="n">master</span><span class="p">)</span> <span class="n">Merge</span> <span class="n">branch</span> <span class="err">&#39;</span><span class="n">dev</span><span class="err">&#39;</span> <span class="p">(</span><span class="mi">4</span> <span class="n">seconds</span> <span class="n">ago</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Tanky</span> <span class="n">Woo</span><span class="o">&gt;</span>
<span class="o">|</span>\
<span class="o">|</span> <span class="o">*</span> <span class="mi">0</span><span class="n">aab100</span> <span class="o">-</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="n">Add</span> <span class="n">d</span> <span class="p">(</span><span class="mi">26</span> <span class="n">seconds</span> <span class="n">ago</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Tanky</span> <span class="n">Woo</span><span class="o">&gt;</span>
<span class="o">|</span> <span class="o">*</span> <span class="mi">6</span><span class="n">a9379e</span> <span class="o">-</span> <span class="n">Add</span> <span class="n">c</span> <span class="p">(</span><span class="mi">31</span> <span class="n">seconds</span> <span class="n">ago</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Tanky</span> <span class="n">Woo</span><span class="o">&gt;</span>
<span class="o">*</span> <span class="o">|</span> <span class="mo">015</span><span class="n">b5b9</span> <span class="o">-</span> <span class="n">Add</span> <span class="n">f</span> <span class="p">(</span><span class="mi">14</span> <span class="n">seconds</span> <span class="n">ago</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Tanky</span> <span class="n">Woo</span><span class="o">&gt;</span>
<span class="o">|/</span>
<span class="o">*</span> <span class="mi">545851</span><span class="n">d</span> <span class="o">-</span> <span class="n">Add</span> <span class="n">b</span> <span class="p">(</span><span class="mi">59</span> <span class="n">seconds</span> <span class="n">ago</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Tanky</span> <span class="n">Woo</span><span class="o">&gt;</span>
<span class="o">*</span> <span class="mi">1509</span><span class="n">ece</span> <span class="o">-</span> <span class="n">Add</span> <span class="n">a</span> <span class="p">(</span><span class="mi">80</span> <span class="n">seconds</span> <span class="n">ago</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Tanky</span> <span class="n">Woo</span><span class="o">&gt;</span>
</pre></div>


<p>第一个父提交:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="n">pretty</span><span class="o">=</span><span class="n">oneline</span> <span class="o">--</span><span class="n">abbrev</span><span class="o">-</span><span class="n">commit</span> <span class="o">-</span><span class="n">p</span> <span class="n">master</span><span class="o">^</span><span class="mi">1</span>
<span class="mo">015</span><span class="n">b5b9</span> <span class="n">Add</span> <span class="n">f</span>
</pre></div>


<p>第二个父提交, 这是从dev分支合并进master的分支:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="n">pretty</span><span class="o">=</span><span class="n">oneline</span> <span class="o">--</span><span class="n">abbrev</span><span class="o">-</span><span class="n">commit</span> <span class="o">-</span><span class="n">p</span> <span class="n">master</span><span class="o">^</span><span class="mi">2</span>
<span class="mi">0</span><span class="n">aab100</span> <span class="n">Add</span> <span class="n">d</span>
</pre></div>


<p>使用波浪号(~):</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="n">pretty</span><span class="o">=</span><span class="n">oneline</span> <span class="o">--</span><span class="n">abbrev</span><span class="o">-</span><span class="n">commit</span> <span class="o">-</span><span class="n">p</span> <span class="n">master</span><span class="o">~</span><span class="mi">1</span>
<span class="mo">015</span><span class="n">b5b9</span> <span class="n">Add</span> <span class="n">f</span>
</pre></div>


<p><code>master^1</code> 等价于 <code>master~1</code></p>
<p>组合使用:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="n">pretty</span><span class="o">=</span><span class="n">oneline</span> <span class="o">--</span><span class="n">abbrev</span><span class="o">-</span><span class="n">commit</span> <span class="o">-</span><span class="n">p</span> <span class="n">master</span><span class="o">^</span><span class="mi">2</span><span class="o">~</span><span class="mi">1</span>
<span class="mi">6</span><span class="n">a9379e</span> <span class="n">Add</span> <span class="n">c</span>
</pre></div>


<h3 id="_3">查看提交历史</h3>
<p><code>git log</code> 默认就是 <code>git log HEAD</code></p>
<p>使用<code>-p/--patch</code> 可以查看提交的修改补丁:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span><span class="n">p</span> <span class="n">HEAD</span>
</pre></div>


<p>这个等价于:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">show</span> <span class="n">HEAD</span>
</pre></div>


<p><code>git show</code> 还可以查看某个文件的blob内容:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="n">fa</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">fa</span> <span class="n">b</span><span class="o">/</span><span class="n">fa</span>
<span class="n">index</span> <span class="mi">89</span><span class="n">b24ec</span><span class="p">.</span><span class="mf">.7</span><span class="n">bba8c8</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">fa</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">fa</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="err">@@</span>
 <span class="n">line</span> <span class="mi">1</span>
<span class="o">+</span><span class="n">line</span> <span class="mi">2</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">show</span> <span class="o">:</span><span class="n">fa</span>
<span class="n">line</span> <span class="mi">1</span>
</pre></div>


<p>fa在历史库中只有line 1这一行, 在unstaged中增加了line 2.</p>
<p>还可以查看远程追踪分支中某文件的blob内容, 如:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">show</span> <span class="n">origin</span><span class="o">/</span><span class="n">master</span><span class="o">:</span><span class="n">setup</span><span class="p">.</span><span class="n">py</span>
</pre></div>


<p>使用<code>git log &lt;start&gt;..&lt;end&gt;</code> <strong>两个dot</strong> 语法来查看某一段历史, 表示 "结束" 的提交可到达 且 "开始" 的提交不可到达的一组提交. 如:</p>
<div class="hlcode"><pre><span class="cp"># 查看master~11, master~10, 但是不包括 master~12</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="n">master</span><span class="o">~</span><span class="mf">12.</span><span class="p">.</span><span class="n">master</span><span class="o">~</span><span class="mi">10</span>
</pre></div>


<p>如图:</p>
<p><img alt="Figure 6-9. Interpreting ranges as set subtraction" src="https://tankywoo-wb.b0.upaiyun.com/git-6-9.png!small" /></p>
<p>实际也就是:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="o">^</span><span class="n">X</span> <span class="n">Y</span>
</pre></div>


<p><strong>TODO</strong> 这块看图6-11, 6-12, 6-13</p>
<p><code>&lt;start&gt;..&lt;end&gt;</code> 的范围表示集合的减法运算, 而 <code>&lt;A&gt;...&lt;B&gt;</code> <strong>三个dot</strong> 表示A和B的对称差(symmetric difference), 也就是 A或B可达 且又 不同时在 A和B的并集 中.</p>
<p>比如 dev 是从master的init这个提交衍生出来的, 随后master和dev各增加一个提交:</p>
<div class="hlcode"><pre><span class="cp"># master: init -&gt; add fc</span>
<span class="cp"># dev:  init -&gt; add fb</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="n">master</span><span class="p">...</span><span class="n">dev</span> <span class="o">--</span><span class="n">oneline</span>
<span class="mi">52</span><span class="n">bdb27</span> <span class="n">add</span> <span class="n">fc</span>
<span class="mi">20</span><span class="n">d2444</span> <span class="n">add</span> <span class="n">fb</span>
</pre></div>


<p>下面这个命令效果是一致(<strong>TODO</strong>):</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">rev</span><span class="o">-</span><span class="n">list</span> <span class="o">--</span><span class="n">abbrev</span><span class="o">-</span><span class="n">commit</span> <span class="n">master</span><span class="p">...</span><span class="n">dev</span> <span class="o">--</span><span class="n">not</span> <span class="err">$</span><span class="p">(</span><span class="n">git</span> <span class="n">merge</span><span class="o">-</span><span class="n">base</span> <span class="o">--</span><span class="n">all</span> <span class="n">master</span> <span class="n">dev</span><span class="p">)</span>
<span class="mi">52</span><span class="n">bdb27</span>
<span class="mi">20</span><span class="n">d2444</span>
</pre></div>


<h3 id="_4">查找提交</h3>
<p><code>git bisect</code> 二分法查找. 一般用于查找某次坏提交造成的问题.</p>
<p><code>git blame</code> 用于查看一个文件中的没一行最后是最提交以及commit id:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">blame</span> <span class="n">CHANGELOG</span><span class="p">.</span><span class="n">rst</span>
<span class="mi">7</span><span class="n">a6a703b</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2015</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">04</span> <span class="mi">11</span><span class="o">:</span><span class="mi">47</span><span class="o">:</span><span class="mi">40</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">11</span><span class="p">)</span> <span class="n">v1</span><span class="mf">.3</span> <span class="p">(</span><span class="mi">2015</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">04</span><span class="p">)</span>
<span class="mi">7</span><span class="n">a6a703b</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2015</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">04</span> <span class="mi">11</span><span class="o">:</span><span class="mi">47</span><span class="o">:</span><span class="mi">40</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">12</span><span class="p">)</span> <span class="o">===================</span>
<span class="mi">7</span><span class="n">a6a703b</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2015</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">04</span> <span class="mi">11</span><span class="o">:</span><span class="mi">47</span><span class="o">:</span><span class="mi">40</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">13</span><span class="p">)</span>
<span class="mi">7</span><span class="n">a6a703b</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2015</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">04</span> <span class="mi">11</span><span class="o">:</span><span class="mi">47</span><span class="o">:</span><span class="mi">40</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">14</span><span class="p">)</span> <span class="mf">1.</span> <span class="n">Add</span> <span class="err">`</span><span class="n">site</span><span class="p">.</span><span class="n">time</span><span class="err">`</span> <span class="n">variable</span><span class="p">,</span> <span class="n">the</span> <span class="n">generated</span> <span class="n">time</span><span class="p">.</span>
<span class="mi">7</span><span class="n">a6a703b</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2015</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">04</span> <span class="mi">11</span><span class="o">:</span><span class="mi">47</span><span class="o">:</span><span class="mi">40</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">15</span><span class="p">)</span> <span class="mf">2.</span> <span class="n">Improve</span> <span class="n">encoding</span>
<span class="mi">7</span><span class="n">a6a703b</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2015</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">04</span> <span class="mi">11</span><span class="o">:</span><span class="mi">47</span><span class="o">:</span><span class="mi">40</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">16</span><span class="p">)</span> <span class="mf">3.</span> <span class="n">Add</span> <span class="err">`</span><span class="o">--</span><span class="n">update</span><span class="o">-</span><span class="n">them</span><span class="err">`</span> <span class="n">when</span> <span class="n">generate</span> <span class="n">to</span> <span class="n">improve</span> <span class="n">generation</span> <span class="n">speed</span>
<span class="mi">7</span><span class="n">a6a703b</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2015</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">04</span> <span class="mi">11</span><span class="o">:</span><span class="mi">47</span><span class="o">:</span><span class="mi">40</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">17</span><span class="p">)</span> <span class="mf">4.</span> <span class="n">Fix</span> <span class="err">#</span><span class="mi">36</span><span class="p">,</span> <span class="n">add</span> <span class="n">attach</span> <span class="n">directory</span> <span class="n">to</span> <span class="n">put</span> <span class="n">attachments</span><span class="p">.</span>
<span class="mi">7</span><span class="n">a6a703b</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2015</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">04</span> <span class="mi">11</span><span class="o">:</span><span class="mi">47</span><span class="o">:</span><span class="mi">40</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">18</span><span class="p">)</span> <span class="mf">5.</span> <span class="n">Fix</span> <span class="err">#</span><span class="mi">33</span><span class="p">,</span> <span class="n">only</span> <span class="n">show</span> <span class="n">color</span> <span class="n">logging</span> <span class="n">message</span> <span class="n">on</span> <span class="n">Linux</span><span class="o">/</span><span class="n">MacOS</span>
<span class="mi">7</span><span class="n">a6a703b</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2015</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">04</span> <span class="mi">11</span><span class="o">:</span><span class="mi">47</span><span class="o">:</span><span class="mi">40</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">19</span><span class="p">)</span>
<span class="mi">7</span><span class="n">a6a703b</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2015</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">04</span> <span class="mi">11</span><span class="o">:</span><span class="mi">47</span><span class="o">:</span><span class="mi">40</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">20</span><span class="p">)</span>
<span class="mi">211</span><span class="n">a6669</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">23</span> <span class="mi">12</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">59</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">21</span><span class="p">)</span> <span class="n">v1</span><span class="mf">.2.4</span> <span class="p">(</span><span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">23</span><span class="p">)</span>
<span class="mi">211</span><span class="n">a6669</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">23</span> <span class="mi">12</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">59</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">22</span><span class="p">)</span> <span class="o">===================</span>
<span class="mi">211</span><span class="n">a6669</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">23</span> <span class="mi">12</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">59</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">23</span><span class="p">)</span>
<span class="mi">211</span><span class="n">a6669</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">23</span> <span class="mi">12</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">59</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">24</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fix</span> <span class="err">#</span><span class="mi">31</span> <span class="n">encode</span><span class="o">/</span><span class="n">decode</span> <span class="n">problems</span>
<span class="mi">211</span><span class="n">a6669</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">23</span> <span class="mi">12</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">59</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">25</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fix</span> <span class="n">image</span> <span class="n">overflow</span> <span class="n">in</span> <span class="n">simple</span> <span class="n">themes</span>
<span class="mi">211</span><span class="n">a6669</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">23</span> <span class="mi">12</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">59</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">26</span><span class="p">)</span>
<span class="mi">211</span><span class="n">a6669</span> <span class="p">(</span><span class="n">Tanky</span> <span class="n">Woo</span>         <span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">23</span> <span class="mi">12</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mi">59</span> <span class="o">+</span><span class="mi">0800</span>  <span class="mi">27</span><span class="p">)</span>
</pre></div>


<p><code>git log -S</code> 用于根据给定的关键字搜索出现在历史差异中的提交, 也成为pickaxe</p>
<p>但是需要注意: 如果某个提交 添加 和 删除 相同数量含关键词的行, 则这个提交不会被查找出来; 提交必须有添加和删除数量上的变化才能计数.</p>
<p>如:</p>
<div class="hlcode"><pre><span class="n">line</span> <span class="mi">1</span>       <span class="n">line</span> <span class="mi">1</span>
<span class="n">row</span>  <span class="mi">2</span>   <span class="o">-&gt;</span>  <span class="n">line</span> <span class="mi">3</span>
<span class="n">line</span> <span class="mi">3</span>       <span class="n">row</span>  <span class="mi">3</span>
</pre></div>


<p>则无法搜出这次提交.</p>
<h2 id="7">7. 分支</h2>
<p>为了支持可扩展和分类组织, 可以创建一个带层次的分支名, 类似于Unix的路径名, 如</p>
<div class="hlcode"><pre><span class="cp"># fix bug的分支集</span>
<span class="n">bug</span><span class="o">/</span><span class="n">pr</span><span class="o">-</span><span class="mi">1</span>
<span class="n">bug</span><span class="o">/</span><span class="n">pr</span><span class="o">-</span><span class="mi">2</span>

<span class="cp"># 特性分支集</span>
<span class="n">feature</span><span class="o">/</span><span class="n">smt</span><span class="o">-</span><span class="mi">1</span>
<span class="n">feature</span><span class="o">/</span><span class="n">smt</span><span class="o">-</span><span class="mi">2</span>
</pre></div>


<p>这样也例子筛选分支:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">show</span><span class="o">-</span><span class="n">branch</span> <span class="err">&#39;</span><span class="n">bug</span><span class="o">/*</span><span class="err">&#39;</span>
</pre></div>


<p>分支名的一些限制:</p>
<ul>
<li>不能以斜线<code>/</code>结尾</li>
<li>不能以减号<code>-</code>开头</li>
<li>斜线分隔的分支名不能以点<code>.</code>开头, 如 feature/.new</li>
<li>分支名任何地方不能包含两个连续的点<code>..</code></li>
<li>不能包含任何空格和空白字符</li>
<li>不能包含在Git中有特殊含义的字符, 如<code>~</code>, <code>^</code>, <code>:</code>, <code>?</code>, <code>*</code>, <code>[</code></li>
<li>ascii控制字符, 即小于<code>\040</code>的字符以及DEL符<code>\178</code></li>
</ul>
<p>使用<code>git merge-base</code> 可以找到两个点的共同祖先, 如master和dev分支:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">merge</span><span class="o">-</span><span class="n">base</span> <span class="n">master</span> <span class="n">dev</span>
</pre></div>


<p>新建分支时, 默认是从当前分支的最近一个点衍生出新分支, 也可以指定分支或某个sha1 id:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">branch</span> <span class="n">feature</span><span class="o">/</span><span class="n">new</span> <span class="n">master</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">branch</span> <span class="n">feature</span><span class="o">/</span><span class="n">new</span> <span class="mi">7</span><span class="n">a6a703b</span>
</pre></div>


<p>上面命令只新建, 不切换分支, <code>git checkout -b xxx</code>是新建且切换.</p>
<p><code>git show-branch</code> 和 <code>git branch</code>的参数类似, 支持<code>-r</code> (远程分支), <code>-a</code> (所有分支).</p>
<p>关于<code>git show-branch</code>输出的解释, 之前几章多次用到这个命令, 这里终于有详细的解释了:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">show</span><span class="o">-</span><span class="n">branch</span> <span class="n">master</span> <span class="n">dev</span> <span class="n">category</span><span class="o">-</span><span class="n">index</span>
<span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">Release</span> <span class="n">v1</span><span class="mf">.3</span>
 <span class="o">!</span> <span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="n">Merge</span> <span class="n">branch</span> <span class="err">&#39;</span><span class="n">project</span><span class="o">-</span><span class="n">tools</span><span class="err">&#39;</span> <span class="n">into</span> <span class="n">dev</span>
  <span class="o">!</span> <span class="p">[</span><span class="n">category</span><span class="o">-</span><span class="n">index</span><span class="p">]</span> <span class="n">Merge</span> <span class="n">branch</span> <span class="err">&#39;</span><span class="n">project</span><span class="o">-</span><span class="n">tools</span><span class="err">&#39;</span> <span class="n">into</span> <span class="n">dev</span>
<span class="o">---</span>
 <span class="o">--</span> <span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="n">Merge</span> <span class="n">branch</span> <span class="err">&#39;</span><span class="n">project</span><span class="o">-</span><span class="n">tools</span><span class="err">&#39;</span> <span class="n">into</span> <span class="n">dev</span>
 <span class="o">++</span> <span class="p">[</span><span class="n">dev</span><span class="o">^</span><span class="mi">2</span><span class="p">]</span> <span class="n">Makefile</span> <span class="n">add</span> <span class="n">tox</span> <span class="n">and</span> <span class="n">covhtml</span> <span class="n">section</span>
 <span class="o">++</span> <span class="p">[</span><span class="n">dev</span><span class="o">^</span><span class="mi">2</span><span class="o">^</span><span class="p">]</span> <span class="n">Update</span> <span class="n">Makefile</span> <span class="n">clean</span> <span class="n">section</span>
 <span class="o">++</span> <span class="p">[</span><span class="n">dev</span><span class="o">^</span><span class="mi">2</span><span class="o">~</span><span class="mi">2</span><span class="p">]</span> <span class="n">Add</span> <span class="n">arguments</span> <span class="k">for</span> <span class="err">`</span><span class="n">nosetests</span><span class="err">`</span> <span class="n">command</span>
 <span class="o">++</span> <span class="p">[</span><span class="n">dev</span><span class="o">~</span><span class="mi">10</span><span class="p">]</span> <span class="n">rename</span> <span class="n">class</span> <span class="n">InitSite</span> <span class="n">to</span> <span class="n">Initiator</span> <span class="n">and</span> <span class="n">refactor</span>
 <span class="o">++</span> <span class="p">[</span><span class="n">dev</span><span class="o">~</span><span class="mi">11</span><span class="p">]</span> <span class="n">rename</span> <span class="n">initsite</span><span class="p">.</span><span class="n">py</span> <span class="n">to</span> <span class="n">initiator</span><span class="p">.</span><span class="n">py</span>
 <span class="o">--</span> <span class="p">[</span><span class="n">dev</span><span class="o">~</span><span class="mi">12</span><span class="p">]</span> <span class="n">Merge</span> <span class="n">branch</span> <span class="err">&#39;</span><span class="n">support</span><span class="o">-</span><span class="n">draft</span><span class="err">&#39;</span> <span class="n">into</span> <span class="n">dev</span>
 <span class="o">++</span> <span class="p">[</span><span class="n">dev</span><span class="o">~</span><span class="mi">12</span><span class="o">^</span><span class="mi">2</span><span class="p">]</span> <span class="n">Add</span> <span class="n">tester</span> <span class="k">for</span> <span class="n">draft</span>
 <span class="o">++</span> <span class="p">[</span><span class="n">dev</span><span class="o">~</span><span class="mi">13</span><span class="p">]</span> <span class="n">Add</span> <span class="n">tag</span> <span class="n">after</span> <span class="n">release</span>
<span class="o">*++</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">Release</span> <span class="n">v1</span><span class="mf">.3</span>
</pre></div>


<p>默认情况下(不带参数), 会显示所有的本地分支,  我这里为了方便, 只显示3个分支, 且删除了中间很多提交.</p>
<p>输出被一排破折号分为两部分, 破折号长度与分支数有关.</p>
<p>破折号上方显示分支名, 每个分支名一行:</p>
<ul>
<li>括号内是分支名</li>
<li>分支名后面是此分支最近的一次提交信息</li>
<li>分支名前面, <code>*</code> 表示当前分支; <code>!</code> 表示其它分支</li>
<li>每个分支一列, 后面讲到</li>
</ul>
<p>破折号下面是提交信息:</p>
<ul>
<li>起始的<code>+</code>表示提交在一个分支中, <code>*</code>突出表示当前分支的提交, <code>-</code> 表示是一个合并</li>
<li>中间显示的是每个sha1 id的相对引用, 这个在前面介绍过, 也可以用<code>--sha1-name</code>显示sha1 id.</li>
<li>后面显示相应提交的commit message</li>
</ul>
<p>列表会显示到所有分支(活指定的所有分支)的公共祖先那个点, 也可以加<code>--more</code>来多显示一些commit.</p>
<p>关于checkout切换分支有冲突的情况, 比如某个文件同一块地方在两个分支都有改变, 默认无法切换, 除非<code>-f</code>强制切换, 一般的解决方法:</p>
<ul>
<li>git stash 暂存</li>
<li>git checkout -m 做一个合并</li>
</ul>
<p>试了下第二种方法, 比较麻烦, 一般习惯还是用stash</p>
<h2 id="8-diff">8. Diff</h2>
<p>Unix/Linux 中的 <code>diff</code> 命令:</p>
<ul>
<li><code>-u</code> 产生一个合并格式的差异(unified diff)</li>
<li><code>-r</code> 遍历整个目录</li>
<li><code>---</code> 表示原始文件, <code>+++</code> 表示新文件</li>
<li><code>@@ -1,2 +1 @@</code>部分, -表示原始文件, 1表示第1行, 4表示连续4行, 即第1行开始连续4行; +表示新文件, 1表示第一行, 后面没有指定连续行表示默认的1行</li>
</ul>
<!-- -->

<div class="hlcode"><pre><span class="err">$</span> <span class="n">diff</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">r</span> <span class="n">dir1</span> <span class="n">dir2</span>
<span class="n">diff</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">r</span> <span class="n">dir1</span><span class="o">/</span><span class="n">fa</span> <span class="n">dir2</span><span class="o">/</span><span class="n">fa</span>
<span class="o">---</span> <span class="n">dir1</span><span class="o">/</span><span class="n">fa</span>     <span class="mi">2015</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">24</span> <span class="mi">12</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mf">11.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="o">+++</span> <span class="n">dir2</span><span class="o">/</span><span class="n">fa</span>     <span class="mi">2015</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">24</span> <span class="mi">12</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mf">54.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span> <span class="err">@@</span>
<span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">fa</span>
<span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">fa</span>
<span class="o">+</span><span class="mi">2</span><span class="o">-</span><span class="n">fa</span>
<span class="n">diff</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">r</span> <span class="n">dir1</span><span class="o">/</span><span class="n">sub_dir</span><span class="o">/</span><span class="n">fb</span> <span class="n">dir2</span><span class="o">/</span><span class="n">sub_dir</span><span class="o">/</span><span class="n">fb</span>
<span class="o">---</span> <span class="n">dir1</span><span class="o">/</span><span class="n">sub_dir</span><span class="o">/</span><span class="n">fb</span>     <span class="mi">2015</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">24</span> <span class="mi">12</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mf">37.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="o">+++</span> <span class="n">dir2</span><span class="o">/</span><span class="n">sub_dir</span><span class="o">/</span><span class="n">fb</span>     <span class="mi">2015</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">24</span> <span class="mi">12</span><span class="o">:</span><span class="mi">11</span><span class="o">:</span><span class="mf">02.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span><span class="mi">1</span> <span class="err">@@</span>
<span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">fb</span>
<span class="o">+</span><span class="mi">2</span><span class="o">-</span><span class="n">fb</span>
</pre></div>


<p><code>git diff</code>的效果类似<code>diff -u -r dir1 dir2</code></p>
<p>四种基本比较:</p>
<ul>
<li><code>git diff</code>: 工作目录和索引之间的差异</li>
<li><code>git diff &lt;commit&gt;</code>: 工作目录与给定commit之间的差异</li>
<li><code>git diff --cached &lt;commit&gt;</code>: 索引与给定提交之间的差异, 默认是HEAD. 1.6.1版本后可以用<code>--staged</code>代替<code>--cached</code></li>
<li><code>git diff &lt;commit1&gt; &lt;commit2&gt;</code> : 两个commit之间的差异</li>
</ul>
<p>还有一些常用的选项:</p>
<ul>
<li><code>-M</code>: 针对重命名(rename, <code>git mv &lt;file1&gt; &lt;file2&gt;</code>), 只显示简单的结果, 而不是显示先删除再添加的内容</li>
<li><code>-w/--ignore-all-space</code>: 忽略空白字符</li>
<li><code>--stat</code>: 显示一个统计结果, 多少行发生变化, 添加多少, 删除多少</li>
</ul>
<!-- -->

<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">mv</span> <span class="n">log</span><span class="p">.</span><span class="n">py</span> <span class="n">log2</span><span class="p">.</span><span class="n">py</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="o">--</span><span class="n">cached</span> <span class="o">-</span><span class="n">M</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">simiki</span><span class="o">/</span><span class="n">log</span><span class="p">.</span><span class="n">py</span> <span class="n">b</span><span class="o">/</span><span class="n">simiki</span><span class="o">/</span><span class="n">log2</span><span class="p">.</span><span class="n">py</span>
<span class="n">similarity</span> <span class="n">index</span> <span class="mi">100</span><span class="o">%</span>
<span class="n">rename</span> <span class="n">from</span> <span class="n">simiki</span><span class="o">/</span><span class="n">log</span><span class="p">.</span><span class="n">py</span>
<span class="n">rename</span> <span class="n">to</span> <span class="n">simiki</span><span class="o">/</span><span class="n">log2</span><span class="p">.</span><span class="n">py</span>
</pre></div>


<p>关于git diff中的提交范围, 和git log是不一样的, 首先明确两点:</p>
<ul>
<li>git diff不关心文件的历史，也不关心分支</li>
<li>git log关注一个文件是如何变味另外一个(历史).</li>
</ul>
<p>另外以下两个是等价的:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="n">master</span><span class="p">..</span><span class="n">dev</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="n">master</span> <span class="n">dev</span>
</pre></div>


<p>如这个历史数:</p>
<div class="hlcode"><pre>      <span class="n">A</span><span class="o">---</span><span class="n">B</span><span class="o">---</span><span class="n">C</span> <span class="n">topic</span>
     <span class="o">/</span>
<span class="n">D</span><span class="o">---</span><span class="n">E</span><span class="o">---</span><span class="n">F</span><span class="o">---</span><span class="n">G</span> <span class="n">master</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="n">master</span><span class="p">..</span><span class="n">topic</span>    <span class="err">#</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">G</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="n">master</span><span class="p">...</span><span class="n">topic</span>   <span class="err">#</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span>
</pre></div>


<p>这块网上有几篇讲得不错的:</p>
<ul>
<li><a href="https://matthew-brett.github.io/pydagogue/git_diff_dots.html">dots in diff</a>, <a href="https://matthew-brett.github.io/pydagogue/git_log_dots.html#git-log-dots">dots in log</a> 不过这里有个错误, <code>git log master topic</code>和<code>git log master..topic</code>是不等价的</li>
<li><a href="https://wincent.com/wiki/Git_%22range%22_or_%22dot%22_syntax">Git "range" or "dot" syntax</a></li>
<li><a href="http://stackoverflow.com/questions/7251477/what-are-the-differences-between-double-dot-and-triple-dot-in-git-dif">What are the differences between double-dot “..” and triple-dot “…” in Git diff commit ranges?</a> 一图胜千言</li>
</ul>
<p>git diff 还可以限制路径:</p>
<div class="hlcode"><pre><span class="err">#</span> <span class="err">限制在某个目录下</span>
<span class="nx">git</span> <span class="nx">diff</span> <span class="o">&lt;</span><span class="nx">some_directory</span><span class="o">&gt;</span>

<span class="err">#</span> <span class="err">现在在某个文件中</span>
<span class="nx">git</span> <span class="nx">diff</span> <span class="o">&lt;</span><span class="nx">some_file</span><span class="o">&gt;</span>
</pre></div>


<p>如<code>-S</code>在git log中, <code>git diff</code>也有-S参数:</p>
<div class="hlcode"><pre><span class="cp"># 在master分支最近50个提交中搜索包含指定字符串的变更</span>
<span class="n">git</span> <span class="n">diff</span> <span class="o">-</span><span class="n">S</span> <span class="s">&quot;octopus&quot;</span> <span class="n">master</span><span class="o">~</span><span class="mi">50</span>
</pre></div>


<h2 id="9">9. 合并</h2>
<p>Git支持同时合并三个、四个或多个分支. 但是大多数情况下, 一次合并只结合两个分支.</p>
<blockquote>
<p>作为一般规则, 每次合并都从干净的工作目录和索引开始, 那么Git的操作会变得容易很多</p>
</blockquote>
<p>关于合并冲突的详解:</p>
<p>配置好环境:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">show</span><span class="o">-</span><span class="n">branch</span>
<span class="o">!</span> <span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="n">one</span> <span class="n">world</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">all</span> <span class="n">worlds</span>
<span class="o">--</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">all</span> <span class="n">worlds</span>
<span class="o">+</span>  <span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="n">one</span> <span class="n">world</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">master</span><span class="o">^</span><span class="p">]</span> <span class="n">init</span>
</pre></div>


<p>两个分支, 一个文件hello</p>
<p>master分支和alt分支基于一个初始提交, 第二个提交分别是:</p>
<p>master:</p>
<div class="hlcode"><pre> <span class="n">hello</span>
<span class="o">+</span><span class="n">worlds</span>
<span class="o">+</span><span class="n">Yay</span><span class="o">!</span>
</pre></div>


<p>alt:</p>
<div class="hlcode"><pre> <span class="n">hello</span>
<span class="o">+</span><span class="n">world</span>
<span class="o">+</span><span class="n">Yay</span><span class="o">!</span>
</pre></div>


<p>master上合并alt, 产生冲突:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="nx">git</span> <span class="nb">merge</span> <span class="nx">alt</span>
<span class="nx">Auto</span><span class="na">-merging</span> <span class="nx">hello</span>
<span class="nx">CONFLICT</span> <span class="p">(</span><span class="nb">content</span><span class="p">):</span> <span class="nb">Merge</span> <span class="n">conflict</span> <span class="k">in</span> <span class="nx">hello</span>
<span class="nx">Automatic</span> <span class="nb">merge</span> <span class="nx">failed</span><span class="p">;</span> <span class="nx">fix</span> <span class="nx">conflicts</span> <span class="ow">and</span> <span class="nx">then</span> <span class="nx">commit</span> <span class="nx">the</span> <span class="nx">result.</span>

<span class="err">$</span> <span class="nx">git</span> <span class="nb">status</span>
<span class="k">On</span> <span class="nx">branch</span> <span class="nx">master</span>
<span class="nx">You</span> <span class="nx">have</span> <span class="nx">unmerged</span> <span class="nx">paths.</span>
  <span class="p">(</span><span class="nx">fix</span> <span class="nx">conflicts</span> <span class="ow">and</span> <span class="nb">run</span> <span class="s2">&quot;git commit&quot;</span><span class="p">)</span>

<span class="nx">Unmerged</span> <span class="nx">paths</span><span class="p">:</span>
  <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git add &lt;file&gt;...&quot;</span> <span class="k">to</span> <span class="nx">mark</span> <span class="nx">resolution</span><span class="p">)</span>

        <span class="nx">both</span> <span class="nx">modified</span><span class="p">:</span>   <span class="nx">hello</span>

<span class="nx">no</span> <span class="nx">changes</span> <span class="nx">added</span> <span class="k">to</span> <span class="nx">commit</span> <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git add&quot;</span> <span class="ow">and</span><span class="p">/</span><span class="nb">or</span> <span class="s2">&quot;git commit -a&quot;</span><span class="p">)</span>

<span class="err">$</span> <span class="nx">cat</span> <span class="nx">hello</span>
<span class="nx">hello</span>
<span class="o">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="nb">HEAD</span>
<span class="nx">worlds</span>
<span class="o">=======</span>
<span class="nx">world</span>
<span class="o">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="nx">alt</span>
<span class="nx">Yay</span><span class="o">!</span>
</pre></div>


<p>现在hello这个文件的状态是<code>unmerged</code>. Git在处理合并冲突时, 会对冲突的文件标记为<code>冲突的(conflicted)</code>或<code>未合并的(unmerged)</code>.</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="n">hello</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">cc</span> <span class="n">hello</span>
<span class="n">index</span> <span class="n">e63164d</span><span class="p">,</span><span class="mi">562080</span><span class="n">a</span><span class="p">.</span><span class="mf">.0000000</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="err">@@@</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@@</span>
  <span class="n">hello</span>
<span class="o">++&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
 <span class="o">+</span><span class="n">worlds</span>
<span class="o">++=======</span>
<span class="o">+</span> <span class="n">world</span>
<span class="o">++&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="n">alt</span>
  <span class="n">Yay</span><span class="o">!</span>
</pre></div>


<p>对于有冲突的文件,<code>git diff</code>会比较特殊, 之前说的默认情况下是比较当前工作目录与索引的差异, 这里显示的是两个服版本作的差异, 第一个是HEAD版本, 第二个是alt版本, 第二个又称<code>MERGE_HEAD</code>.</p>
<p>另外这里的+-号不再是一列了, 而是两列, 第一列表示相对当前版本的修改, 第二列是相对另一个版本的修改. 这个输出有点类似<code>show-branch</code>的结果.</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="n">HEAD</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="n">index</span> <span class="n">e63164d</span><span class="p">.</span><span class="mf">.1f2f</span><span class="mi">61</span><span class="n">c</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
 <span class="n">hello</span>
<span class="o">+&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
 <span class="n">worlds</span>
<span class="o">+=======</span>
<span class="o">+</span><span class="n">world</span>
<span class="o">+&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="n">alt</span>
 <span class="n">Yay</span><span class="o">!</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="o">--</span><span class="n">ours</span>
<span class="o">*</span> <span class="n">Unmerged</span> <span class="n">path</span> <span class="n">hello</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="n">index</span> <span class="n">e63164d</span><span class="p">.</span><span class="mf">.1f2f</span><span class="mi">61</span><span class="n">c</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
 <span class="n">hello</span>
<span class="o">+&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
 <span class="n">worlds</span>
<span class="o">+=======</span>
<span class="o">+</span><span class="n">world</span>
<span class="o">+&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="n">alt</span>
 <span class="n">Yay</span><span class="o">!</span>
</pre></div>


<p>这种就是正常的HEAD和工作目录的diff. <code>git diff HEAD</code> 等价于 <code>git diff --ours</code></p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="n">MERGE_HEAD</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="n">index</span> <span class="mi">562080</span><span class="n">a</span><span class="p">.</span><span class="mf">.1f2f</span><span class="mi">61</span><span class="n">c</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
 <span class="n">hello</span>
<span class="o">+&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
<span class="o">+</span><span class="n">worlds</span>
<span class="o">+=======</span>
 <span class="n">world</span>
<span class="o">+&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="n">alt</span>
 <span class="n">Yay</span><span class="o">!</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="o">--</span><span class="n">theirs</span>
<span class="o">*</span> <span class="n">Unmerged</span> <span class="n">path</span> <span class="n">hello</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="n">index</span> <span class="mi">562080</span><span class="n">a</span><span class="p">.</span><span class="mf">.1f2f</span><span class="mi">61</span><span class="n">c</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
 <span class="n">hello</span>
<span class="o">+&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
<span class="o">+</span><span class="n">worlds</span>
<span class="o">+=======</span>
 <span class="n">world</span>
<span class="o">+&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="n">alt</span>
 <span class="n">Yay</span><span class="o">!</span>
</pre></div>


<p><code>git diff MERGE_HEAD</code> 等价于 <code>git diff --theirs</code></p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="err">$</span><span class="p">(</span><span class="n">git</span> <span class="n">merge</span><span class="o">-</span><span class="n">base</span> <span class="n">HEAD</span> <span class="n">MERGE_HEAD</span><span class="p">)</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="n">index</span> <span class="n">ce01362</span><span class="p">.</span><span class="mf">.1f2f</span><span class="mi">61</span><span class="n">c</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
 <span class="n">hello</span>
<span class="o">+&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
<span class="o">+</span><span class="n">worlds</span>
<span class="o">+=======</span>
<span class="o">+</span><span class="n">world</span>
<span class="o">+&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="n">alt</span>
<span class="o">+</span><span class="n">Yay</span><span class="o">!</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="o">--</span><span class="n">base</span>
<span class="o">*</span> <span class="n">Unmerged</span> <span class="n">path</span> <span class="n">hello</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="n">index</span> <span class="n">ce01362</span><span class="p">.</span><span class="mf">.1f2f</span><span class="mi">61</span><span class="n">c</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span>
 <span class="n">hello</span>
<span class="o">+&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
<span class="o">+</span><span class="n">worlds</span>
<span class="o">+=======</span>
<span class="o">+</span><span class="n">world</span>
<span class="o">+&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="n">alt</span>
<span class="o">+</span><span class="n">Yay</span><span class="o">!</span>
</pre></div>


<p><code>merge-base</code>会显示两个版本的公共祖先. 上面两条命令也是等价</p>
<p>接着做一些改动, 处理冲突, 删除三方合并标记线, 但是先不add, 还是保留unmerged状态:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">more</span> <span class="n">hello</span>
<span class="n">hello</span>
<span class="n">worlds</span> <span class="n">xxx</span>          <span class="err">#</span> <span class="err">随便添加些字符</span>
<span class="n">Yay</span><span class="o">!</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">diff</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">cc</span> <span class="n">hello</span>
<span class="n">index</span> <span class="n">e63164d</span><span class="p">,</span><span class="mi">562080</span><span class="n">a</span><span class="p">.</span><span class="mf">.0000000</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="err">@@@</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="err">@@@</span>
  <span class="n">hello</span>
<span class="o">-</span> <span class="n">worlds</span>
 <span class="o">-</span><span class="n">world</span>
<span class="o">++</span><span class="n">worlds</span> <span class="n">xxx</span>
  <span class="n">Yay</span><span class="o">!</span>

<span class="err">$</span> <span class="n">more</span> <span class="n">hello</span>
<span class="n">hello</span>
<span class="n">worlds</span>  <span class="err">#</span> <span class="err">使用</span> <span class="o">--</span><span class="n">ours</span><span class="err">版本</span>
<span class="n">Yay</span><span class="o">!</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">diff</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">cc</span> <span class="n">hello</span>
<span class="n">index</span> <span class="n">e63164d</span><span class="p">,</span><span class="mi">562080</span><span class="n">a</span><span class="p">.</span><span class="mf">.0000000</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>

<span class="err">$</span> <span class="n">more</span> <span class="n">hello</span>
<span class="n">hello</span>
<span class="n">world</span>  <span class="err">#</span> <span class="err">使用</span> <span class="o">--</span><span class="n">theirs</span><span class="err">版本</span>
<span class="n">Yay</span><span class="o">!</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">diff</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">cc</span> <span class="n">hello</span>
<span class="n">index</span> <span class="n">e63164d</span><span class="p">,</span><span class="mi">562080</span><span class="n">a</span><span class="p">.</span><span class="mf">.0000000</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
</pre></div>


<p>后两者都没有diff, 这是git diff又一个特殊的地方: 对于有冲突的文件, git diff只显示真正有冲突的部分, 如果只有一边有变化, 这部分就不显示.</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">add</span> <span class="n">hello</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">status</span>
<span class="n">On</span> <span class="n">branch</span> <span class="n">master</span>
<span class="n">All</span> <span class="n">conflicts</span> <span class="n">fixed</span> <span class="n">but</span> <span class="n">you</span> <span class="n">are</span> <span class="n">still</span> <span class="n">merging</span><span class="p">.</span>
  <span class="p">(</span><span class="n">use</span> <span class="s">&quot;git commit&quot;</span> <span class="n">to</span> <span class="n">conclude</span> <span class="n">merge</span><span class="p">)</span>

<span class="n">Changes</span> <span class="n">to</span> <span class="n">be</span> <span class="n">committed</span><span class="o">:</span>

        <span class="nl">modified:</span>   <span class="n">hello</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="o">--</span><span class="n">cached</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="n">index</span> <span class="n">e63164d</span><span class="p">.</span><span class="mf">.562080</span><span class="n">a</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="err">@@</span>
 <span class="n">hello</span>
<span class="o">-</span><span class="n">worlds</span>
<span class="o">+</span><span class="n">world</span>
 <span class="n">Yay</span><span class="o">!</span>
</pre></div>


<p>如果解决冲突并add后, 就可以看到实际diff了.</p>
<p>在解决冲突的过程中, 可以使用git log快速找到变更的地方:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">merge</span> <span class="o">--</span><span class="n">left</span><span class="o">-</span><span class="n">right</span> <span class="o">-</span><span class="n">p</span>
<span class="n">commit</span> <span class="o">&lt;</span> <span class="mi">944</span><span class="n">b769511d84455382a53c947f262db97dcbb09</span>
<span class="nl">Author:</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">wtq1990</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="nl">Date:</span>   <span class="n">Tue</span> <span class="n">Jun</span> <span class="mi">30</span> <span class="mi">22</span><span class="o">:</span><span class="mi">11</span><span class="o">:</span><span class="mi">42</span> <span class="mi">2015</span> <span class="o">+</span><span class="mi">0800</span>

    <span class="n">add</span> <span class="n">master</span>

<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="n">index</span> <span class="n">ce01362</span><span class="p">..</span><span class="n">e63164d</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="err">@@</span>
 <span class="n">hello</span>
<span class="o">+</span><span class="n">worlds</span>
<span class="o">+</span><span class="n">Yay</span><span class="o">!</span>

<span class="n">commit</span> <span class="o">&gt;</span> <span class="mf">4e2</span><span class="n">d91547b64b9ee2f26de286175819502d8c262</span>
<span class="nl">Author:</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">wtq1990</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="nl">Date:</span>   <span class="n">Tue</span> <span class="n">Jun</span> <span class="mi">30</span> <span class="mi">09</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mo">05</span> <span class="mi">2015</span> <span class="o">+</span><span class="mi">0800</span>

    <span class="n">one</span> <span class="n">world</span>

<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="n">index</span> <span class="n">ce01362</span><span class="p">.</span><span class="mf">.562080</span><span class="n">a</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">hello</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">hello</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="err">@@</span>
 <span class="n">hello</span>
<span class="o">+</span><span class="n">world</span>
<span class="o">+</span><span class="n">Yay</span><span class="o">!</span>
</pre></div>


<p><code>--merge</code>会使用<code>MERGE_HEAD</code>来找到两者的差异.</p>
<p><code>git ls-files -u</code> 可以查看工作树中未合并的文件:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">ls</span><span class="o">-</span><span class="n">files</span> <span class="o">-</span><span class="n">u</span>
<span class="mi">100644</span> <span class="n">ce013625030ba8dba906f756967f9e9ca394464a</span> <span class="mi">1</span>       <span class="n">hello</span>
<span class="mi">100644</span> <span class="n">e63164d9518b1e6caf28f455ac86c8246f78ab70</span> <span class="mi">2</span>       <span class="n">hello</span>
<span class="mi">100644</span> <span class="mi">562080</span><span class="n">a4c6518e1bf67a9f58a32a67bff72d4f00</span> <span class="mi">3</span>       <span class="n">hello</span>
</pre></div>


<p>分别是1. base, 2. ours, 3. theirs</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">cat</span><span class="o">-</span><span class="n">file</span> <span class="o">-</span><span class="n">p</span> <span class="n">ce013625030ba8dba906f756967f9e9ca394464a</span>
<span class="n">hello</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">cat</span><span class="o">-</span><span class="n">file</span> <span class="o">-</span><span class="n">p</span> <span class="n">e63164d9518b1e6caf28f455ac86c8246f78ab70</span>
<span class="n">hello</span>
<span class="n">worlds</span>
<span class="n">Yay</span><span class="o">!</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">cat</span><span class="o">-</span><span class="n">file</span> <span class="o">-</span><span class="n">p</span> <span class="mi">562080</span><span class="n">a4c6518e1bf67a9f58a32a67bff72d4f00</span>
<span class="n">hello</span>
<span class="n">world</span>
<span class="n">Yay</span><span class="o">!</span>
</pre></div>


<p>git diff支持在这两个版本之间互相diff:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">diff</span> <span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="n">hello</span> <span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="n">hello</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/:</span><span class="mi">1</span><span class="o">:</span><span class="n">hello</span> <span class="n">b</span><span class="o">/:</span><span class="mi">3</span><span class="o">:</span><span class="n">hello</span>
<span class="n">index</span> <span class="n">ce01362</span><span class="p">.</span><span class="mf">.562080</span><span class="n">a</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/:</span><span class="mi">1</span><span class="o">:</span><span class="n">hello</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/:</span><span class="mi">3</span><span class="o">:</span><span class="n">hello</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="err">@@</span>
 <span class="n">hello</span>
<span class="o">+</span><span class="n">world</span>
<span class="o">+</span><span class="n">Yay</span><span class="o">!</span>
</pre></div>


<p>合并冲突的回退. 如果在冲突过程中想要回退, 可以:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="n">HEAD</span>
</pre></div>


<p>如果在冲突解决后想到放弃, 回退(或终止), 可以:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="n">ORIG_HEAD</span>
</pre></div>


<p>如果在解决冲突时解决方案失败, 比如弄得非常乱, 想重新回到冲突的原始状态, 重新解决, 可以:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">checkout</span> <span class="o">-</span><span class="n">m</span>
</pre></div>


<p>交叉合并(criss-cross merge), 是指修改在分支间来回合并.</p>
<p>TODO 给出例子</p>
<p>Degenerate merge(退化合并)(中文翻译真蛋疼, 还是原词好理解一些), 就是指merge后不引入一个合并提交:</p>
<ul>
<li>已经是最新的(already up-to-date)</li>
<li>快进合并 (fast-forward)</li>
</ul>
<p>关于合并的策略, 用<code>-s</code>参数指定. 有5种(man git-merge, 见<code>MERGE STRATEGIES</code>一节):</p>
<ul>
<li>resolve (解决)</li>
<li>recursive (递归)</li>
<li>octopusd (章鱼)</li>
<li>ours (我们的)</li>
<li>subtree (子树)</li>
</ul>
<p>resolve 曾经是Git的默认策略, 现已改为recursive. 处理针对两个分支合并的情况, 定义两个分支的共同祖先, 然后进行三路合并(3-way merge algorithm)</p>
<p>recursive 是默认的策略. 和resolve类似, 也是针对两个分支合并的情况. 可以处理多个共同祖先的情况, 进行三路合并. 在Linux的开发历史上, 此策略证明会比resolve导致更少的冲突而没有故障. 此策略还有很多策略选项, 用<code>-X</code>来指定, 常用的有<code>ours</code>和<code>theirs</code>.</p>
<p>octopusd 针对合并两个分支以上的情况. 当超过两个分支以上合并时, 这个是默认策略</p>
<p>ours 可以合并任意数量的分支. 但它实际是丢弃了其它分支的修改, 只使用当前分支的修改. 结果是和当前HEAD一样, 只是会标记其它分支也是父提交. 注意这个和recursive的-X ours策略选项不一样.</p>
<p>subtree 这个不理解 TODO</p>
<p>关于策略ours和recuresive的策略选项ours, theirs, 在我之前的博客有总结到: <a href="http://blog.tankywoo.com/git/2014/05/20/git-merge-strategy-ours-and-theirs.html">Git merge strategy - ours and theirs</a></p>
<p>用到现在, 策略这块基本就是用的默认策略, 其它复杂的情况还没用过, 也没有更多的体会...</p>
<h2 id="10">10. 更改提交</h2>
<p>更改历史的哲学 TODO</p>
<p>一般原则, 只要没有其它开发人员获取到你的版本库副本, 那么可以任意的修改历史. 但是如果已经被他人同步过, 则不应该重写或修改历史. 不然对其他人来说是个灾难 :(</p>
<p>最常用的改写历史的应该是:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">commit</span> <span class="o">--</span><span class="n">amend</span>
</pre></div>


<p>经常用这个来修改最后一次提交, 或其提交日志, 提交作者等.</p>
<p>其次就是reset操作, 调整HEAD引用指向给定的提交.</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reset</span>
</pre></div>


<p>它有三个选项:</p>
<ul>
<li>--sotf</li>
<li>--mixed (默认方式)</li>
<li>--hard</li>
</ul>
<p><code>--soft</code>软重置, 是副作用最小的, 只变化了HEAD引用, 比如:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">soft</span> <span class="n">HEAD</span><span class="o">^</span>
</pre></div>


<p>会重置到上一次提交, 并把最后一次提交的修改移到索引, 原先索引和未暂存的内容不会有影响</p>
<p><code>--mixed</code> 副作用中等. 会影响索引的内容. 比如:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reset</span> <span class="n">HEAD</span><span class="o">^</span>
</pre></div>


<p>会重置到上一次提交, 并把最后一次提交的修改移到未暂存区, 且如果索引原先有修改, 也会被移到未暂存区.</p>
<p><code>--hard</code>是杀伤力最大的. 影响到了工作目录的内容. 如:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="n">HEAD</span><span class="o">^</span>
</pre></div>


<p>会重置到上一次提交, 并把最后一次提交的修改删除, 且如果索引和暂存区原来有修改, 都会删除.</p>
<p>前阵子在这里吃了一个大亏, wiki库有些修改积压了一阵子, 没提交(甚至都没add到索引, 不然还可以通过reflog找回...), 一个误操作用了--hard, 一夜回到解放前...</p>
<p>另外, 这里有一个有用的引用<code>ORIG_HEAD</code>, 在git reset时, git会把原始的HEAD存到ORIG_HEAD, 这样如果误操作后想返回到原来的版本, 可以:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="n">ORIG_HEAD</span>
</pre></div>


<p>接着是<code>cherry-pick</code>, 将指定的commit应用到当前分支.</p>
<p>比如开发分支dev有个修复bug的提交dev~2, 现在需要临时引入到master分支应用上, 就可以用cherry-pick来操作:</p>
<div class="hlcode"><pre><span class="cp"># 当前在master分支上</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">cherry</span><span class="o">-</span><span class="n">pick</span> <span class="n">dev</span><span class="o">~</span><span class="mi">2</span>
</pre></div>


<p>cherry-pick还可以重建一系列提交, 比如一个分支的某两个提交想互换顺序, 可以引入一个新分支, 通过cherry-pick按预计顺序引入到新分支.</p>
<p><code>revert</code> 和 cherry-pick 类似, 不过它的作用是应用指定提交的逆过程. 一般用于修复某个有问题的提交, 通过撤销来修复.</p>
<p>比如master分支上的某个提交master~3的修改有问题, 现在想撤销, 如果是线上公布的分支, 不建议rebase, 可以通过revert撤销:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">revert</span> <span class="n">master</span><span class="o">~</span><span class="mi">3</span>
</pre></div>


<p>这是引入一个新的提交, 是master~3的逆修改, 添加的就删除, 删除的就添加.</p>
<p><code>rebase</code>(中文"变基", 很操蛋的翻译) 是用来改变一串提交以什么为基础.</p>
<blockquote>
<p>Forward-port(向前移植) local commits to the updated upstream head</p>
</blockquote>
<p>常见的调用git rebase的两个命令(简化了来自man git-rebase的语法):</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="nx">git</span> <span class="nx">rebase</span> <span class="err">[</span><span class="na">-i</span> <span class="o">|</span> <span class="o">--</span><span class="nx">interactive</span><span class="cp">]</span> <span class="cp">[</span><span class="nx">options</span><span class="cp">]</span> <span class="cp">[</span><span class="o">--</span><span class="nx">onto</span> <span class="o">&lt;</span><span class="nx">newbase</span><span class="o">&gt;</span><span class="cp">]</span> <span class="cp">[</span><span class="o">&lt;</span><span class="nx">upstream</span><span class="o">&gt;</span> <span class="err">[</span><span class="o">&lt;</span><span class="nx">branch</span><span class="o">&gt;</span><span class="cp">]</span>]
$ git rebase --continue | --skip | --abort | --edit-todo
</pre></div>


<p>首先最常用的功能, 是保持当前开发分支相对另一个分支是最新的.</p>
<p>比如一个多人协作的仓库, master分支是公共分支, 个人分支mydev, 如果mydev因一些事情耽搁几天, 这是master有了一些新提交, mydev需要用到, 可以将mydev移到master上最新的点分叉出来, 这样也可以保证分支图不会拉的太长, 简单步骤就是:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">checkout</span> <span class="n">mydev</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">rebase</span> <span class="n">master</span>
</pre></div>


<p>或者:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">rebase</span> <span class="n">master</span> <span class="n">mydev</span>
</pre></div>


<p>这也是上面第一条命令的语法, 最少需要指定某个上游, 基于此上游迁移. 默认是对当前分支做迁移</p>
<p>如, 原始的提交DAG图是:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">graph</span> <span class="o">--</span><span class="n">branches</span> <span class="o">--</span><span class="n">all</span> <span class="o">--</span><span class="n">decorate</span> <span class="o">--</span><span class="n">oneline</span>
<span class="o">*</span> <span class="mf">00698e1</span> <span class="p">(</span><span class="n">HEAD</span><span class="p">,</span> <span class="n">master</span><span class="p">)</span> <span class="n">update</span> <span class="n">master_file</span>
<span class="o">*</span> <span class="n">d07ac54</span> <span class="n">add</span> <span class="n">master_file</span>
<span class="o">|</span> <span class="o">*</span> <span class="mf">07e33</span><span class="n">e5</span> <span class="p">(</span><span class="n">mydev</span><span class="p">)</span> <span class="n">update</span> <span class="n">mydev_file</span>
<span class="o">|</span> <span class="o">*</span> <span class="n">dceb4d8</span> <span class="n">add</span> <span class="n">mydev_file</span>
<span class="o">|/</span>
<span class="o">*</span> <span class="n">a8923b3</span> <span class="n">master</span> <span class="mi">1</span>
<span class="o">*</span> <span class="mi">942</span><span class="n">c6af</span> <span class="n">init</span>
</pre></div>


<p>现在我要将mydev分支移从d07ac54分叉, 作了rebase后:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">rebase</span> <span class="n">master</span><span class="o">~</span><span class="mi">1</span> <span class="n">mydev</span>
<span class="n">First</span><span class="p">,</span> <span class="n">rewinding</span> <span class="n">head</span> <span class="n">to</span> <span class="n">replay</span> <span class="n">your</span> <span class="n">work</span> <span class="n">on</span> <span class="n">top</span> <span class="n">of</span> <span class="n">it</span><span class="p">...</span>
<span class="nl">Applying:</span> <span class="n">add</span> <span class="n">mydev_file</span>
<span class="nl">Applying:</span> <span class="n">update</span> <span class="n">mydev_file</span>

<span class="p">(</span><span class="n">mydev</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">graph</span> <span class="o">--</span><span class="n">branches</span> <span class="o">--</span><span class="n">all</span> <span class="o">--</span><span class="n">decorate</span> <span class="o">--</span><span class="n">oneline</span>
<span class="o">*</span> <span class="mi">8756814</span> <span class="p">(</span><span class="n">HEAD</span><span class="p">,</span> <span class="n">mydev</span><span class="p">)</span> <span class="n">update</span> <span class="n">mydev_file</span>
<span class="o">*</span> <span class="n">d88bae4</span> <span class="n">add</span> <span class="n">mydev_file</span>
<span class="o">|</span> <span class="o">*</span> <span class="mf">00698e1</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="n">update</span> <span class="n">master_file</span>
<span class="o">|/</span>
<span class="o">*</span> <span class="n">d07ac54</span> <span class="n">add</span> <span class="n">master_file</span>
<span class="o">*</span> <span class="n">a8923b3</span> <span class="n">master</span> <span class="mi">1</span>
<span class="o">*</span> <span class="mi">942</span><span class="n">c6af</span> <span class="n">init</span>
</pre></div>


<p>现在8756814 和d88bae4是mydev分支的两个提交, 和以前的sha-1 id不同了, 因为基于的历史树不一样.</p>
<p>注意指定branch后, 执行rebase后会checkout到那个分支.</p>
<p>通过<code>--onto</code>参数, 可以把一条分支上的开发线整个移到另一个分支:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">another_dev</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">graph</span> <span class="o">--</span><span class="n">branches</span> <span class="o">--</span><span class="n">all</span> <span class="o">--</span><span class="n">decorate</span> <span class="o">--</span><span class="n">oneline</span>
<span class="o">*</span> <span class="mi">9</span><span class="n">b81f22</span> <span class="p">(</span><span class="n">HEAD</span><span class="p">,</span> <span class="n">another_dev</span><span class="p">)</span> <span class="n">update</span> <span class="n">another_dev_file</span>
<span class="o">*</span> <span class="n">e32f75f</span> <span class="n">add</span> <span class="n">another_dev_file</span>
<span class="o">|</span> <span class="o">*</span> <span class="mf">00698e1</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="n">update</span> <span class="n">master_file</span>
<span class="o">|</span> <span class="o">*</span> <span class="n">d07ac54</span> <span class="n">add</span> <span class="n">master_file</span>
<span class="o">|</span> <span class="o">|</span> <span class="o">*</span> <span class="mf">07e33</span><span class="n">e5</span> <span class="p">(</span><span class="n">mydev</span><span class="p">)</span> <span class="n">update</span> <span class="n">mydev_file</span>
<span class="o">|</span> <span class="o">|/</span>
<span class="o">|/|</span>
<span class="o">*</span> <span class="o">|</span> <span class="n">dceb4d8</span> <span class="n">add</span> <span class="n">mydev_file</span>
<span class="o">|/</span>
<span class="o">*</span> <span class="n">a8923b3</span> <span class="n">master</span> <span class="mi">1</span>
<span class="o">*</span> <span class="mi">942</span><span class="n">c6af</span> <span class="n">init</span>

<span class="p">(</span><span class="n">another_dev</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">rebase</span> <span class="n">master</span>
<span class="n">First</span><span class="p">,</span> <span class="n">rewinding</span> <span class="n">head</span> <span class="n">to</span> <span class="n">replay</span> <span class="n">your</span> <span class="n">work</span> <span class="n">on</span> <span class="n">top</span> <span class="n">of</span> <span class="n">it</span><span class="p">...</span>
<span class="nl">Applying:</span> <span class="n">add</span> <span class="n">mydev_file</span>
<span class="nl">Applying:</span> <span class="n">add</span> <span class="n">another_dev_file</span>
<span class="nl">Applying:</span> <span class="n">update</span> <span class="n">another_dev_file</span>

<span class="p">(</span><span class="n">another_dev</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">graph</span> <span class="o">--</span><span class="n">branches</span><span class="o">=</span><span class="err">&#39;</span><span class="o">*</span><span class="n">dev</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">all</span> <span class="o">--</span><span class="n">decorate</span> <span class="o">--</span><span class="n">oneline</span>
<span class="o">*</span> <span class="n">d632eb3</span> <span class="p">(</span><span class="n">HEAD</span><span class="p">,</span> <span class="n">another_dev</span><span class="p">)</span> <span class="n">update</span> <span class="n">another_dev_file</span>
<span class="o">*</span> <span class="mi">824</span><span class="n">c829</span> <span class="n">add</span> <span class="n">another_dev_file</span>
<span class="o">*</span> <span class="mf">98f</span><span class="mi">4</span><span class="n">d44</span> <span class="n">add</span> <span class="n">mydev_file</span>
<span class="o">*</span> <span class="mf">00698e1</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="n">update</span> <span class="n">master_file</span>
<span class="o">*</span> <span class="n">d07ac54</span> <span class="n">add</span> <span class="n">master_file</span>
<span class="o">|</span> <span class="o">*</span> <span class="mf">07e33</span><span class="n">e5</span> <span class="p">(</span><span class="n">mydev</span><span class="p">)</span> <span class="n">update</span> <span class="n">mydev_file</span>
<span class="o">|</span> <span class="o">*</span> <span class="n">dceb4d8</span> <span class="n">add</span> <span class="n">mydev_file</span>
<span class="o">|/</span>
<span class="o">*</span> <span class="n">a8923b3</span> <span class="n">master</span> <span class="mi">1</span>
<span class="o">*</span> <span class="mi">942</span><span class="n">c6af</span> <span class="n">init</span>
</pre></div>


<p>经过常规的rebase后, 可以看到, 原先在mydev上的两个提交现在有了两次. 改为--onto方式:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">another_dev</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">rebase</span> <span class="o">--</span><span class="n">onto</span> <span class="n">master</span> <span class="n">mydev</span><span class="o">~</span><span class="mi">1</span> <span class="n">another_dev</span>
<span class="n">First</span><span class="p">,</span> <span class="n">rewinding</span> <span class="n">head</span> <span class="n">to</span> <span class="n">replay</span> <span class="n">your</span> <span class="n">work</span> <span class="n">on</span> <span class="n">top</span> <span class="n">of</span> <span class="n">it</span><span class="p">...</span>
<span class="nl">Applying:</span> <span class="n">add</span> <span class="n">another_dev_file</span>
<span class="nl">Applying:</span> <span class="n">update</span> <span class="n">another_dev_file</span>

<span class="p">(</span><span class="n">another_dev</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">pager</span> <span class="n">log</span> <span class="o">--</span><span class="n">graph</span> <span class="o">--</span><span class="n">branches</span><span class="o">=</span><span class="err">&#39;</span><span class="o">*</span><span class="n">dev</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">all</span> <span class="o">--</span><span class="n">decorate</span> <span class="o">--</span><span class="n">oneline</span>
<span class="o">*</span> <span class="mf">6e661</span><span class="n">ce</span> <span class="p">(</span><span class="n">HEAD</span><span class="p">,</span> <span class="n">another_dev</span><span class="p">)</span> <span class="n">update</span> <span class="n">another_dev_file</span>
<span class="o">*</span> <span class="mi">870</span><span class="n">b906</span> <span class="n">add</span> <span class="n">another_dev_file</span>
<span class="o">*</span> <span class="mf">00698e1</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="n">update</span> <span class="n">master_file</span>
<span class="o">*</span> <span class="n">d07ac54</span> <span class="n">add</span> <span class="n">master_file</span>
<span class="o">|</span> <span class="o">*</span> <span class="mf">07e33</span><span class="n">e5</span> <span class="p">(</span><span class="n">mydev</span><span class="p">)</span> <span class="n">update</span> <span class="n">mydev_file</span>
<span class="o">|</span> <span class="o">*</span> <span class="n">dceb4d8</span> <span class="n">add</span> <span class="n">mydev_file</span>
<span class="o">|/</span>
<span class="o">*</span> <span class="n">a8923b3</span> <span class="n">master</span> <span class="mi">1</span>
<span class="o">*</span> <span class="mi">942</span><span class="n">c6af</span> <span class="n">init</span>
</pre></div>


<p>如果rebase过程中发生了冲突, 则需要用到最开始说的第二条命令了.</p>
<p>遇到冲突时, rebase会在冲突的提交点挂起, 等待处理冲突</p>
<ul>
<li>冲突完成后, <code>git rebase --continue</code>恢复rebase</li>
<li>如果不想要这个提交, 则可以<code>git rebase --skip</code>跳过这个提交</li>
<li>如果不想进行rebase, 则<code>git rebase --abort</code>中止rebase</li>
</ul>
<p><code>git rebase -i</code> 以交互式的方式处理指定范围的rebase操作, 常用于修改以前某次的提交.</p>
<p>一般找到需要需要处理的某个点, 比如abcdef, 则:  TODO</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">rebase</span> <span class="o">-</span><span class="n">i</span> <span class="n">abcdef</span><span class="o">~</span><span class="mi">1</span>
</pre></div>


<p>此时会进入编辑器, 然后对每个commit 指定操作, 默认是pick, 显示如:</p>
<div class="hlcode"><pre><span class="n">pick</span> <span class="n">d07ac54</span> <span class="n">add</span> <span class="n">master_file</span>
<span class="n">pick</span> <span class="mf">00698e1</span> <span class="n">update</span> <span class="n">master_file</span>

<span class="cp"># Rebase a8923b3..00698e1 onto a8923b3 (2 command(s))</span>
<span class="cp">#</span>
<span class="cp"># Commands:</span>
<span class="cp"># p, pick = use commit</span>
<span class="cp"># r, reword = use commit, but edit the commit message</span>
<span class="cp"># e, edit = use commit, but stop for amending</span>
<span class="cp"># s, squash = use commit, but meld into previous commit</span>
<span class="cp"># f, fixup = like &quot;squash&quot;, but discard this commit&#39;s log message</span>
<span class="cp"># x, exec = run command (the rest of the line) using shell</span>
<span class="cp">#</span>
<span class="cp"># These lines can be re-ordered; they are executed from top to bottom.</span>
<span class="cp">#</span>
<span class="cp"># If you remove a line here THAT COMMIT WILL BE LOST.</span>
<span class="cp">#</span>
<span class="cp"># However, if you remove everything, the rebase will be aborted.</span>
<span class="cp">#</span>
<span class="cp"># Note that empty commits are commented out</span>
</pre></div>


<p>提示内容非常详细, 如果要对某个commit进行指定操作, 则修改pick为其它即可, 可以用简写或全称, 如e 或 edit都是编辑修改</p>
<ul>
<li>pick: 默认操作, 使用原来的commit, 没变化</li>
<li>record: 使用原来的commit, 但是修改提交日志</li>
<li>edit: 修改, 到指定点停下, 可以通过--amend修复</li>
<li>squash: 和前一次提交进行融合, 并将两次提交日志合在一起打开编辑器让用户编辑后确认</li>
<li>fixup: 和squash类似, 但是直接使用前一次提交的日志</li>
<li>exec: 指定shell命令.</li>
</ul>
<p>exec这个简单试了下, 不是基于某个commit id, 而是在预期的位置做一些shell操作, 如:</p>
<div class="hlcode"><pre><span class="n">pick</span> <span class="mi">8</span><span class="n">cc5fcb</span> <span class="n">addxxx</span> <span class="n">master_file</span>
<span class="n">exec</span> <span class="n">touch</span> <span class="n">xxx</span>
<span class="n">pick</span> <span class="n">ac7a580</span> <span class="n">update</span> <span class="n">master_file</span>
</pre></div>


<p>看了下官方的man手册, 在针对每个版本都做测试时非常有用, 如:</p>
<div class="hlcode"><pre><span class="n">pick</span> <span class="mi">5928</span><span class="n">aea</span> <span class="n">one</span>
<span class="n">exec</span> <span class="n">make</span> <span class="n">test</span>
<span class="n">pick</span> <span class="mo">04</span><span class="n">d0fda</span> <span class="n">two</span>
<span class="n">exec</span> <span class="n">make</span> <span class="n">test</span>
<span class="n">pick</span> <span class="n">ba46169</span> <span class="n">three</span>
<span class="n">exec</span> <span class="n">make</span> <span class="n">test</span>
<span class="n">pick</span> <span class="n">f4593f9</span> <span class="n">four</span>
<span class="n">exec</span> <span class="n">make</span> <span class="n">test</span>
</pre></div>


<p>另外, git rebase -i进入编辑器后的注释提示信息相当详细, 除了介绍上面的几个操作命令, 还有其它说明:</p>
<ul>
<li>可以重新排序, git rebase是从上至下执行的</li>
<li>甚至可以删除某个commit, 这样这个提交点就会丢失</li>
<li>如果编辑器里除了注释外的内容为空, 则中止rebase, 和 git rebase --abort 一样</li>
</ul>
<p>另外, rebase是把当前分支历史(带合并)线性化到了指定分支. 所以如果移动范围有合并提交, 默认会被线性化, 通过参数<code>-p/--preserve-merges</code>可以保留合并提交. 不然历史树就和以前有较大出入.</p>
<p>rebase后, 如果后悔了, 可以:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="n">ORIG_HEAD</span>
</pre></div>


<h2 id="11">11. 储藏和引用日志</h2>
<p>储藏(stash)是一个很常用的功能, 工作目录有一些修改时, 如:</p>
<ul>
<li>此时需要紧急修复一个bug, 可以stash储藏之前的修改, 然后开始修复bug</li>
<li>需要临时切换分支去修改一些东西, 因为一些冲突导致无法切换过去, 也可以先stash起来</li>
<li>需要pull更新本地, 但是有冲突导致pull失败, 可以stash起来, pull后在pop解决冲突</li>
</ul>
<p>直接执行<code>git stash</code>则储藏当前的修改, 默认是save子命令</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">stash</span>
<span class="n">Saved</span> <span class="n">working</span> <span class="n">directory</span> <span class="n">and</span> <span class="n">index</span> <span class="n">state</span> <span class="n">WIP</span> <span class="n">on</span> <span class="n">master</span><span class="o">:</span> <span class="mf">7f</span><span class="mi">63</span><span class="n">cf0</span> <span class="n">update</span> <span class="n">master</span> <span class="n">file</span>
<span class="n">HEAD</span> <span class="n">is</span> <span class="n">now</span> <span class="n">at</span> <span class="mf">7f</span><span class="mi">63</span><span class="n">cf0</span> <span class="n">update</span> <span class="n">master</span> <span class="n">file</span>
</pre></div>


<p>这里WIP是work in process的缩写</p>
<p>stash的数据结构是一个<code>栈</code>, 即先进后出FILO(first in, last out), 相应的还原最近一个储藏则是:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">stash</span> <span class="n">pop</span>
</pre></div>


<p>查看stash栈:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">stash</span> <span class="n">list</span>
<span class="n">stash</span><span class="err">@</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">:</span> <span class="n">WIP</span> <span class="n">on</span> <span class="n">master</span><span class="o">:</span> <span class="mf">7f</span><span class="mi">63</span><span class="n">cf0</span> <span class="n">update</span> <span class="n">master</span> <span class="n">file</span>
<span class="n">stash</span><span class="err">@</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="o">:</span> <span class="n">WIP</span> <span class="n">on</span> <span class="n">master</span><span class="o">:</span> <span class="mi">7965691</span> <span class="n">master</span>
</pre></div>


<p>这里储藏时是用的默认的信息, 指出了分支, 当前sha1 id.</p>
<p><code>stash@{0}</code>是储藏的编号, 根据FILO的原则, 0表示最新的一个储藏</p>
<p>也可以手动输入信息:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">stash</span> <span class="n">save</span> <span class="err">&#39;</span><span class="k">do</span> <span class="n">a</span> <span class="n">stash</span><span class="err">&#39;</span>
<span class="n">Saved</span> <span class="n">working</span> <span class="n">directory</span> <span class="n">and</span> <span class="n">index</span> <span class="n">state</span> <span class="n">On</span> <span class="n">master</span><span class="o">:</span> <span class="k">do</span> <span class="n">a</span> <span class="n">stash</span>
<span class="n">HEAD</span> <span class="n">is</span> <span class="n">now</span> <span class="n">at</span> <span class="mi">7965691</span> <span class="n">master</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">stash</span> <span class="n">list</span>
<span class="n">stash</span><span class="err">@</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">:</span> <span class="n">On</span> <span class="n">master</span><span class="o">:</span> <span class="k">do</span> <span class="n">a</span> <span class="n">stash</span>
</pre></div>


<p>stash也是一个引用指针(<code>refs/stash</code>), 所以也可以使用这个引用来查看:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">show</span><span class="o">-</span><span class="n">branch</span> <span class="n">stash</span>
<span class="p">[</span><span class="n">stash</span><span class="p">]</span> <span class="n">On</span> <span class="n">master</span><span class="o">:</span> <span class="k">do</span> <span class="n">a</span> <span class="n">stash</span>
</pre></div>


<p>另外, 要注意, git stash并不是把最近一次储藏替换当前文件, 而是会做一个合并的操作, 这个是非常智能的.</p>
<p>git stash pop时, 如果成功, 则会删除相应储藏, 如果失败, 如产生冲突, 则会保留储藏.</p>
<p>删除储藏, 默认删除最近一个, 也可以手动指定某个储藏:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">stash</span> <span class="n">drop</span>
</pre></div>


<p>因为stash pop成功后会清掉, 可以使用apply只做应用还原, 但是不清理, 和drop一样, 也可以指定某个储藏:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">stash</span> <span class="n">apply</span>
</pre></div>


<p>查看储藏的内容, 不加<code>-p</code>则只显示stat信息:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">stash</span> <span class="n">show</span> <span class="o">-</span><span class="n">p</span> <span class="n">stash</span><span class="err">@</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
</pre></div>


<p>也可以</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">show</span> <span class="n">stash</span><span class="err">@</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
</pre></div>


<p>一些常用的选项:</p>
<ul>
<li><code>-u/--include-untracked</code>: 本地某个untracked的文件导致pull冲突失败时, 可以使用此选项把untracked文件也stash</li>
<li><code>-p/--patch</code>: 选择部分储藏, 和git add -p一样</li>
<li><code>-k/--keep-index</code>: 只储藏unstaged部分, 保留索引中的修改, 默认是全部都储藏</li>
<li><code>--index</code>: pop的选项, 当储藏包括staged和unstaged部分时, pop会全还原未unstaged, 次选项会按照原来的格局恢复</li>
</ul>
<p>储藏是本地的操作, 所以储藏的object是不会提交到远程的</p>
<p>储藏还有一个给力的功能, 转化为分支:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">stash</span> <span class="n">branch</span> <span class="o">&lt;</span><span class="n">branch</span> <span class="n">name</span><span class="o">&gt;</span> <span class="n">stash</span><span class="err">@</span><span class="p">{</span><span class="mi">5</span><span class="p">}</span>
</pre></div>


<p>因为某个stash后可能有增加了很多大的修改, 这是可以单拉一个分支来处理.</p>
<p>不过stash和branch还是要区别使用, stash更多是针对一个临时的操作, 最好不要积压太久, 随时保持储藏栈清理; 所以相应也不要过多的将stash转为一个branch. 至少至今为止我还没有做过这样的操作...</p>
<p>引用日志(reflog)</p>
<p>有时, 一些危险的操作, 会导致本地丢失一些提交, 如没有push到远程仓库前误操作执行了git reset HEAD^.</p>
<p>使用引用分支可以恢复丢失的提交.</p>
<p>修改引用或更改分支头的Git操作都会记录引用日志:</p>
<ul>
<li>复制</li>
<li>推送</li>
<li>新提交</li>
<li>修改/创建分支</li>
<li>rebase</li>
<li>reset</li>
<li>...</li>
</ul>
<p>默认情况下, 引用日志在非裸版本库是弃用的, 在裸版本库(bare)中是禁用的. 可以通过如下开启:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">config</span> <span class="n">core</span><span class="p">.</span><span class="n">logAllRefUpdates</span> <span class="nb">true</span>
</pre></div>


<p>查看引用日志:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reflog</span> <span class="p">[</span><span class="n">show</span><span class="p">]</span>
<span class="mf">7f</span><span class="mi">63</span><span class="n">cf0</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">:</span> <span class="n">reset</span><span class="o">:</span> <span class="n">moving</span> <span class="n">to</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="mi">3</span><span class="n">dd62fb</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="o">:</span> <span class="n">merge</span> <span class="n">mod</span><span class="o">:</span> <span class="n">Fast</span><span class="o">-</span><span class="n">forward</span>
<span class="mf">7f</span><span class="mi">63</span><span class="n">cf0</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">2</span><span class="p">}</span><span class="o">:</span> <span class="n">checkout</span><span class="o">:</span> <span class="n">moving</span> <span class="n">from</span> <span class="n">master</span> <span class="n">to</span> <span class="n">master</span>
<span class="mf">7f</span><span class="mi">63</span><span class="n">cf0</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">3</span><span class="p">}</span><span class="o">:</span> <span class="n">checkout</span><span class="o">:</span> <span class="n">moving</span> <span class="n">from</span> <span class="n">master</span> <span class="n">to</span> <span class="n">master</span>
<span class="mf">7f</span><span class="mi">63</span><span class="n">cf0</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">4</span><span class="p">}</span><span class="o">:</span> <span class="n">checkout</span><span class="o">:</span> <span class="n">moving</span> <span class="n">from</span> <span class="n">mod</span> <span class="n">to</span> <span class="n">master</span>
<span class="mi">3</span><span class="n">dd62fb</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">5</span><span class="p">}</span><span class="o">:</span> <span class="n">commit</span><span class="o">:</span> <span class="n">update</span> <span class="n">file</span> <span class="n">in</span> <span class="n">mod</span>
<span class="p">...</span>
<span class="mi">73</span><span class="n">ed934</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">12</span><span class="p">}</span><span class="o">:</span> <span class="n">commit</span><span class="o">:</span> <span class="n">dev</span>
<span class="mi">38</span><span class="n">d4a3d</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">13</span><span class="p">}</span><span class="o">:</span> <span class="n">checkout</span><span class="o">:</span> <span class="n">moving</span> <span class="n">from</span> <span class="n">master</span> <span class="n">to</span> <span class="n">dev</span>
<span class="mi">38</span><span class="n">d4a3d</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">14</span><span class="p">}</span><span class="o">:</span> <span class="n">commit</span> <span class="p">(</span><span class="n">initial</span><span class="p">)</span><span class="o">:</span> <span class="n">add</span> <span class="n">file</span>
</pre></div>


<p>子命令show可有可无, 默认输出的引用是HEAD, 所以在上面也可以看到都是HEAD@{X}</p>
<p>因为分支名也是引用, 所以后接分支名可以查看某个分支的引用日志</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reflog</span> <span class="n">show</span> <span class="n">master</span>
<span class="mi">3</span><span class="n">dd62fb</span> <span class="n">master</span><span class="err">@</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">:</span> <span class="n">reset</span><span class="o">:</span> <span class="n">moving</span> <span class="n">to</span> <span class="n">ORIG_HEAD</span>
<span class="mf">7f</span><span class="mi">63</span><span class="n">cf0</span> <span class="n">master</span><span class="err">@</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="o">:</span> <span class="n">reset</span><span class="o">:</span> <span class="n">moving</span> <span class="n">to</span> <span class="n">HEAD</span><span class="o">^</span>
</pre></div>


<p>或者:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reflog</span> <span class="n">show</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
<span class="mi">3</span><span class="n">dd62fb</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span><span class="err">@</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">:</span> <span class="n">reset</span><span class="o">:</span> <span class="n">moving</span> <span class="n">to</span> <span class="n">ORIG_HEAD</span>
<span class="mf">7f</span><span class="mi">63</span><span class="n">cf0</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span><span class="err">@</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="o">:</span> <span class="n">reset</span><span class="o">:</span> <span class="n">moving</span> <span class="n">to</span> <span class="n">HEAD</span><span class="o">^</span>
</pre></div>


<p>针对输出结果, 第一列的sha1 id和第二列的别名是对应的, 第三列只出相应的操作类型和操作内容</p>
<p><code>HEAD@{0}</code> 始终指向当前的HEAD, 这里可以看到<code>HEAD@{14}</code>是第一次提交</p>
<p>例子:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">ll</span>
<span class="o">*</span> <span class="mi">3</span><span class="n">dd62fb</span> <span class="o">-</span> <span class="p">(</span><span class="n">HEAD</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">master</span><span class="p">)</span> <span class="n">update</span> <span class="n">file</span> <span class="n">in</span> <span class="n">mod</span> <span class="p">(</span><span class="mi">17</span> <span class="n">hours</span> <span class="n">ago</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Tanky</span> <span class="n">Woo</span><span class="o">&gt;</span>
<span class="o">*</span> <span class="mf">7f</span><span class="mi">63</span><span class="n">cf0</span> <span class="o">-</span> <span class="n">update</span> <span class="n">master</span> <span class="n">file</span> <span class="p">(</span><span class="mi">3</span> <span class="n">days</span> <span class="n">ago</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">Tanky</span> <span class="n">Woo</span><span class="o">&gt;</span>
<span class="p">...</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">reflog</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">1</span>
<span class="mi">3</span><span class="n">dd62fb</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">:</span> <span class="n">checkout</span><span class="o">:</span> <span class="n">moving</span> <span class="n">from</span> <span class="n">mod</span> <span class="n">to</span> <span class="n">master</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="n">HEAD</span><span class="o">^</span>
<span class="n">HEAD</span> <span class="n">is</span> <span class="n">now</span> <span class="n">at</span> <span class="mf">7f</span><span class="mi">63</span><span class="n">cf0</span> <span class="n">update</span> <span class="n">master</span> <span class="n">file</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">reflog</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">2</span>
<span class="mf">7f</span><span class="mi">63</span><span class="n">cf0</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">:</span> <span class="n">reset</span><span class="o">:</span> <span class="n">moving</span> <span class="n">to</span> <span class="n">HEAD</span><span class="o">^</span>
<span class="mi">3</span><span class="n">dd62fb</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="o">:</span> <span class="n">checkout</span><span class="o">:</span> <span class="n">moving</span> <span class="n">from</span> <span class="n">mod</span> <span class="n">to</span> <span class="n">master</span>
</pre></div>


<p>现在本地执行了一次reset, 如果发现是误操作, 想要返回, 但是本地的修改没有推送到远程, 这是可以通过reflog撤回:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="n">HEAD</span> <span class="n">is</span> <span class="n">now</span> <span class="n">at</span> <span class="mi">3</span><span class="n">dd62fb</span> <span class="n">update</span> <span class="n">file</span> <span class="n">in</span> <span class="n">mod</span>
</pre></div>


<p>表明要重置到老的HEAD版本.</p>
<p>当然, 这种情形下还有一个方法, 使用<code>ORIG_HEAD</code>:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="n">ORIG_HEAD</span>
<span class="n">HEAD</span> <span class="n">is</span> <span class="n">now</span> <span class="n">at</span> <span class="mi">3</span><span class="n">dd62fb</span> <span class="n">update</span> <span class="n">file</span> <span class="n">in</span> <span class="n">mod</span>
</pre></div>


<p>如<code>HEAD@{1}</code>, 如果使用形式<code>@{X}</code>, 则表示当前分支:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">show</span> <span class="err">@</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span>
<span class="n">commit</span> <span class="mi">3</span><span class="n">dd62fb79377c7d0419ca12183db780489287731</span>
<span class="nl">Author:</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">wtq1990</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="nl">Date:</span>   <span class="n">Sat</span> <span class="n">Jun</span> <span class="mi">20</span> <span class="mi">21</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mi">27</span> <span class="mi">2015</span> <span class="o">+</span><span class="mi">0800</span>

<span class="p">...</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">reflog</span> <span class="n">show</span> <span class="err">@</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span>
<span class="mi">3</span><span class="n">dd62fb</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span><span class="err">@</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">:</span> <span class="n">reset</span><span class="o">:</span> <span class="n">moving</span> <span class="n">to</span> <span class="n">ORIG_HEAD</span>
<span class="mf">7f</span><span class="mi">63</span><span class="n">cf0</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span><span class="err">@</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="o">:</span> <span class="n">reset</span><span class="o">:</span> <span class="n">moving</span> <span class="n">to</span> <span class="n">HEAD</span><span class="o">^</span>
<span class="p">...</span>
</pre></div>


<p>另外, reflog的花括号内还可以指定时间限定符, 如:</p>
<div class="hlcode"><pre><span class="n">TankyWoo</span> <span class="err">$</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">reflog</span> <span class="err">&#39;</span><span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">1</span> <span class="n">hours</span> <span class="n">ago</span><span class="p">}</span><span class="err">&#39;</span>
<span class="mi">3</span><span class="n">dd62fb</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="n">Sat</span> <span class="n">Jun</span> <span class="mi">20</span> <span class="mi">22</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">12</span> <span class="mi">2015</span> <span class="o">+</span><span class="mi">0800</span><span class="p">}</span><span class="o">:</span> <span class="n">reset</span><span class="o">:</span> <span class="n">moving</span> <span class="n">to</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="mi">3</span><span class="n">dd62fb</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="n">Sat</span> <span class="n">Jun</span> <span class="mi">20</span> <span class="mi">21</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mi">47</span> <span class="mi">2015</span> <span class="o">+</span><span class="mi">0800</span><span class="p">}</span><span class="o">:</span> <span class="n">merge</span> <span class="n">mod</span><span class="o">:</span> <span class="n">Fast</span><span class="o">-</span><span class="n">forward</span>
<span class="mf">7f</span><span class="mi">63</span><span class="n">cf0</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="n">Sat</span> <span class="n">Jun</span> <span class="mi">20</span> <span class="mi">21</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mi">38</span> <span class="mi">2015</span> <span class="o">+</span><span class="mi">0800</span><span class="p">}</span><span class="o">:</span> <span class="n">checkout</span><span class="o">:</span> <span class="n">moving</span> <span class="n">from</span> <span class="n">master</span> <span class="n">to</span> <span class="n">master</span>
</pre></div>


<p>还支持如:</p>
<ul>
<li>2 days ago</li>
<li>1 hour ago</li>
<li>1 minute ago</li>
<li>yesterday</li>
<li>last saturday</li>
<li>2015-01-01</li>
<li>...</li>
</ul>
<p>这里注意以下是等价的:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="err">&#39;</span><span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">2</span> <span class="n">days</span> <span class="n">ago</span><span class="p">}</span><span class="err">&#39;</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mf">2.</span><span class="n">days</span><span class="p">.</span><span class="n">ago</span><span class="p">}</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="n">HEAD</span><span class="err">@</span><span class="p">{</span><span class="mi">2</span><span class="o">-</span><span class="n">days</span><span class="o">-</span><span class="n">ago</span><span class="p">}</span>
</pre></div>


<p>注意第一个的单引号, 否则shell报错.</p>
<p>对于可达或不可达的引用日志, 都有一个默认的过期时限.</p>
<p>也可以手动设置过期时间:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">reflog</span> <span class="n">expire</span> <span class="o">--</span><span class="n">expire</span><span class="o">=</span><span class="err">&#39;</span><span class="mi">1</span> <span class="n">day</span> <span class="n">ago</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">all</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">gc</span>
<span class="n">Counting</span> <span class="n">objects</span><span class="o">:</span> <span class="mi">15</span><span class="p">,</span> <span class="n">done</span><span class="p">.</span>
<span class="n">Delta</span> <span class="n">compression</span> <span class="n">using</span> <span class="n">up</span> <span class="n">to</span> <span class="mi">4</span> <span class="n">threads</span><span class="p">.</span>
<span class="n">Compressing</span> <span class="n">objects</span><span class="o">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">4</span><span class="p">),</span> <span class="n">done</span><span class="p">.</span>
<span class="n">Writing</span> <span class="n">objects</span><span class="o">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">15</span><span class="o">/</span><span class="mi">15</span><span class="p">),</span> <span class="n">done</span><span class="p">.</span>
<span class="n">Total</span> <span class="mi">15</span> <span class="p">(</span><span class="n">delta</span> <span class="mi">1</span><span class="p">),</span> <span class="n">reused</span> <span class="mi">15</span> <span class="p">(</span><span class="n">delta</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>


<p>还可以通过<code>git reflog delete</code>删除指定的条目</p>
<p>内部细节:</p>
<p>引用日志都是存储在 <code>.git/logs</code> 下</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">tree</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span>
<span class="err">├──</span> <span class="n">HEAD</span>
<span class="err">└──</span> <span class="n">refs</span>
    <span class="err">└──</span> <span class="n">heads</span>
        <span class="err">├──</span> <span class="n">master</span>
        <span class="err">└──</span> <span class="n">mod</span>
</pre></div>


<p>引用日志也是一个本地概念, 和stash一样, 是不会被推送到远程, 也不会在克隆时被复制下来.</p>
<p>一篇不错的文章: <a href="http://alblue.bandlem.com/2011/05/git-tip-of-week-reflogs.html">Git Tip of the Week: Reflogs</a></p>
<h2 id="12">12. 远程版本库</h2>
<p>远程版本库(remote)是一个引用或句柄, 通过文件系统或网络指向另外一个版本库. 可以使用远程版本库作为简称, 代替又长又复杂的Git URL.</p>
<p>TODO</p>
<ul>
<li>远程追踪分支(remote-tracking branch)</li>
<li>本地追踪分支</li>
</ul>
<p>Git版本库分为:</p>
<ul>
<li>裸(bare)版本库. 是分布式开发的权威焦点, 内容基本就是.git目录</li>
<li>非裸(nonbare)版本库.用于日常开发的仓库</li>
</ul>
<p>在git clone时, 原始版本库的本地开发分支refs/heads/xxx, 会成为新克隆版本库的远程分支refs/remotes/xxx. 原始版本库的远程分支不会克隆过来.</p>
<p>clone下来默认的远程版本库名称是origin, 可以通过<code>--origin</code>改为其它的.</p>
<p>针对远程版本库的操作, 有常用的<code>git pull</code>, <code>git fetch</code>, <code>git push</code>, 还有<code>git remote</code>, <code>git ls-remote</code> 列出远程版本库的引用列表.(相对的 <code>git show-ref</code>显示本地的引用列表)</p>
<p>关于<code>git remote</code>, 这个是我比较常用的一个命令, 介绍一下一些功能:</p>
<p>最简单的查看远程仓库的URL:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">remote</span> <span class="o">-</span><span class="n">v</span>
</pre></div>


<p>添加一个上游版本库(upstream repo):</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">remote</span> <span class="n">add</span> <span class="n">upstream</span> <span class="o">&lt;</span><span class="n">git</span> <span class="n">url</span><span class="o">&gt;</span>
</pre></div>


<p>添加上游版本库后, 我想防止误操作把提交push到这个仓库, 可以修改push url:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">remote</span> <span class="n">set</span><span class="o">-</span><span class="n">url</span> <span class="o">--</span><span class="n">push</span> <span class="n">origin</span> <span class="err">&#39;</span><span class="k">do</span> <span class="n">not</span> <span class="n">pushing</span><span class="err">&#39;</span>
</pre></div>


<p>查看远程版本库的详细内容(这个操作会访问远程仓库, 而不是直接基于本地配置):</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">remote</span> <span class="o">-</span><span class="n">v</span> <span class="n">show</span> <span class="n">origin</span>
<span class="o">*</span> <span class="n">remote</span> <span class="n">origin</span>
  <span class="n">Fetch</span> <span class="n">URL</span><span class="o">:</span> <span class="n">git</span><span class="err">@</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">:</span><span class="n">tankywoo</span><span class="o">/</span><span class="n">simiki</span><span class="p">.</span><span class="n">git</span>
  <span class="n">Push</span>  <span class="n">URL</span><span class="o">:</span> <span class="n">git</span><span class="err">@</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">:</span><span class="n">tankywoo</span><span class="o">/</span><span class="n">simiki</span><span class="p">.</span><span class="n">git</span>
  <span class="n">HEAD</span> <span class="n">branch</span><span class="o">:</span> <span class="n">master</span>
  <span class="n">Remote</span> <span class="n">branches</span><span class="o">:</span>
    <span class="n">dev</span>              <span class="n">tracked</span>
    <span class="n">jinja</span><span class="o">-</span><span class="n">extensions</span> <span class="n">tracked</span>
    <span class="n">master</span>           <span class="n">tracked</span>
    <span class="n">project</span><span class="o">-</span><span class="n">tools</span>    <span class="n">tracked</span>
  <span class="n">Local</span> <span class="n">branches</span> <span class="n">configured</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">git</span> <span class="n">pull</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">dev</span>              <span class="n">merges</span> <span class="n">with</span> <span class="n">remote</span> <span class="n">dev</span>
    <span class="n">jinja</span><span class="o">-</span><span class="n">extensions</span> <span class="n">merges</span> <span class="n">with</span> <span class="n">remote</span> <span class="n">jinja</span><span class="o">-</span><span class="n">extensions</span>
    <span class="n">master</span>           <span class="n">merges</span> <span class="n">with</span> <span class="n">remote</span> <span class="n">master</span>
    <span class="n">project</span><span class="o">-</span><span class="n">tools</span>    <span class="n">merges</span> <span class="n">with</span> <span class="n">remote</span> <span class="n">project</span><span class="o">-</span><span class="n">tools</span>
  <span class="n">Local</span> <span class="n">refs</span> <span class="n">configured</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">git</span> <span class="n">push</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">dev</span>              <span class="n">pushes</span> <span class="n">to</span> <span class="n">dev</span>              <span class="p">(</span><span class="n">up</span> <span class="n">to</span> <span class="n">date</span><span class="p">)</span>
    <span class="n">jinja</span><span class="o">-</span><span class="n">extensions</span> <span class="n">pushes</span> <span class="n">to</span> <span class="n">jinja</span><span class="o">-</span><span class="n">extensions</span> <span class="p">(</span><span class="n">up</span> <span class="n">to</span> <span class="n">date</span><span class="p">)</span>
    <span class="n">master</span>           <span class="n">pushes</span> <span class="n">to</span> <span class="n">master</span>           <span class="p">(</span><span class="n">up</span> <span class="n">to</span> <span class="n">date</span><span class="p">)</span>
    <span class="n">project</span><span class="o">-</span><span class="n">tools</span>    <span class="n">pushes</span> <span class="n">to</span> <span class="n">project</span><span class="o">-</span><span class="n">tools</span>    <span class="p">(</span><span class="n">up</span> <span class="n">to</span> <span class="n">date</span><span class="p">)</span>
</pre></div>


<p>虽然很多操作都可以直接修改<code>.git/config</code>, 但是就像修改/etc/sudoers使用visudo命令, 而不是直接vi /etc/sudoers一样, 命令的可靠性要大于手动.</p>
<p>git支持的传输协议有本地文件系统,git原生协议,http/https协议,rsync协议等. 以前http/https协议效率很多, 不过在1.6.6版本后,效率已经和git原生协议的效率差不多了.</p>
<p>查看<code>.git/config</code>, 可以看到fetch refspec配置, 默认是:</p>
<div class="hlcode"><pre><span class="k">[remote &quot;origin&quot;]</span>
        <span class="na">url</span> <span class="o">=</span> <span class="s">git@github.com:tankywoo/simiki.git</span>
<span class="s">        fetch = +refs/heads/*:refs/remotes/origin/*</span>
</pre></div>


<p>refspec语法:</p>
<div class="hlcode"><pre><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="n">source</span><span class="o">:</span><span class="n">destination</span>
</pre></div>


<p>source表示源引用, destination表示目标引用, 两者用冒号(:)分隔. 前面的加号(+)是可选的, 有加号表示不会在传输过程中进行正常的快进安全检查. 星号(<code>*</code>)表示通配符匹配</p>
<p>git fetch 和 git push 都用到refspec, refspec的源和目标是依赖于执行的操作:</p>
<div class="hlcode"><pre><span class="err">操作</span>      <span class="err">源</span>                   <span class="err">目标</span>
<span class="n">push</span>        <span class="err">推送的本地引用</span>     <span class="err">更新的远程引用</span>
<span class="n">fetch</span>       <span class="err">抓去的远程引用</span>     <span class="err">更新的本地引用</span>
</pre></div>


<p>这里有个很多人都没注意到的地方, push 的对立面不是 pull, 而是 fetch. 很多人可能因为命令名以及上手就学的push/pull, 而在这里有了错误的认识.</p>
<p>TODO</p>
<h2 id="13">13. 版本库管理(略)</h2>
<h2 id="14">14. 补丁</h2>
<p>虽然Git协议非常方便, 但是还是有些理由来使用补丁(patch)的: 1. 防火墙限制, 比如有些公司不允许做推送操作. 2. 将补丁发到公共邮箱(mailing list), 方便同行评审.</p>
<p>关于补丁的一系列操作从生成补丁到发送补丁最后到应用补丁:</p>
<ul>
<li>git format-path 生成email形式的补丁</li>
<li>git send-mail通过SMTP协议发送Git补丁</li>
<li>git am 应用补丁</li>
</ul>
<p><code>git format-patch</code> 命令以邮件消息的形式生成一个补丁. 常用的生成方式(参数)有几种方式:</p>
<ul>
<li>特定提交数; 如-2, 表示生成2个patch</li>
<li>提交范围; 如 master~4..master~2, 表示生成master~3, master~2这两个patch(不包括master~4), 和diff, log指定范围类似</li>
<li>某次特定提交; 如master~1, 其实表示是范围master~1..HEAD</li>
</ul>
<p>git diff 是 git format-patch的核心, 不过还是有些区别, git diff 生成单个的差异合集, 而git format-match是为每个提交都生成单个patch; 二是git diff不带邮件头等信息.</p>
<p>git format-patch 和 git log -p --pretty=email的输出基本一致, 前者多了一个--stats信息, 以及最后的Git版本号(这里是2.3.5):</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">format</span><span class="o">-</span><span class="n">patch</span> <span class="o">-</span><span class="mi">1</span>
<span class="mo">0001</span><span class="o">-</span><span class="n">D</span><span class="p">.</span><span class="n">patch</span>

<span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">more</span> <span class="mo">0001</span><span class="o">-</span><span class="n">D</span><span class="p">.</span><span class="n">patch</span>
<span class="n">From</span> <span class="mf">50e7530441</span><span class="n">d9836b8643e3a3134b9072c7763e60</span> <span class="n">Mon</span> <span class="n">Sep</span> <span class="mi">17</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="mi">2001</span>
<span class="nl">From:</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">wtq1990</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="nl">Date:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">7</span> <span class="n">Jul</span> <span class="mi">2015</span> <span class="mo">07</span><span class="o">:</span><span class="mi">45</span><span class="o">:</span><span class="mi">38</span> <span class="o">+</span><span class="mi">0800</span>
<span class="nl">Subject:</span> <span class="p">[</span><span class="n">PATCH</span><span class="p">]</span> <span class="n">D</span>

<span class="o">---</span>
 <span class="n">file</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">+</span>
 <span class="mi">1</span> <span class="n">file</span> <span class="n">changed</span><span class="p">,</span> <span class="mi">1</span> <span class="n">insertion</span><span class="p">(</span><span class="o">+</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">file</span> <span class="n">b</span><span class="o">/</span><span class="n">file</span>
<span class="n">index</span> <span class="n">b1e6722</span><span class="p">.</span><span class="mf">.8422</span><span class="n">d40</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">file</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">file</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span> <span class="err">@@</span>
 <span class="n">A</span>
 <span class="n">B</span>
 <span class="n">C</span>
<span class="o">+</span><span class="n">D</span>
<span class="o">--</span>
<span class="mf">2.3.5</span>

<span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">log</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="n">pretty</span><span class="o">=</span><span class="n">email</span>
<span class="n">From</span> <span class="mf">50e7530441</span><span class="n">d9836b8643e3a3134b9072c7763e60</span> <span class="n">Mon</span> <span class="n">Sep</span> <span class="mi">17</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="mi">2001</span>
<span class="nl">From:</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">wtq1990</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="nl">Date:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">7</span> <span class="n">Jul</span> <span class="mi">2015</span> <span class="mo">07</span><span class="o">:</span><span class="mi">45</span><span class="o">:</span><span class="mi">38</span> <span class="o">+</span><span class="mi">0800</span>
<span class="nl">Subject:</span> <span class="p">[</span><span class="n">PATCH</span><span class="p">]</span> <span class="n">D</span>

<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">file</span> <span class="n">b</span><span class="o">/</span><span class="n">file</span>
<span class="n">index</span> <span class="n">b1e6722</span><span class="p">.</span><span class="mf">.8422</span><span class="n">d40</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">file</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">file</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span> <span class="err">@@</span>
 <span class="n">A</span>
 <span class="n">B</span>
 <span class="n">C</span>
<span class="o">+</span><span class="n">D</span>
</pre></div>


<p>例子, 首先创造环境:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">init</span>
<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">echo</span> <span class="n">A</span> <span class="o">&gt;</span> <span class="n">file</span> <span class="p">;</span> <span class="n">git</span> <span class="n">add</span> <span class="n">file</span> <span class="p">;</span> <span class="n">git</span> <span class="n">ci</span> <span class="o">-</span><span class="n">mA</span>
<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">echo</span> <span class="n">B</span> <span class="o">&gt;&gt;</span> <span class="n">file</span> <span class="p">;</span> <span class="n">git</span> <span class="n">ci</span> <span class="o">-</span><span class="n">mB</span> <span class="n">file</span>
<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">echo</span> <span class="n">C</span> <span class="o">&gt;&gt;</span> <span class="n">file</span> <span class="p">;</span> <span class="n">git</span> <span class="n">ci</span> <span class="o">-</span><span class="n">mC</span> <span class="n">file</span>
<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">echo</span> <span class="n">D</span> <span class="o">&gt;&gt;</span> <span class="n">file</span> <span class="p">;</span> <span class="n">git</span> <span class="n">ci</span> <span class="o">-</span><span class="n">mD</span> <span class="n">file</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">graph</span> <span class="o">--</span><span class="n">oneline</span> <span class="o">--</span><span class="n">decorate</span> <span class="n">master</span>
<span class="o">*</span> <span class="mf">50e7530</span> <span class="p">(</span><span class="n">HEAD</span><span class="p">,</span> <span class="n">master</span><span class="p">)</span> <span class="n">D</span>
<span class="o">*</span> <span class="mf">1f</span><span class="mi">0</span><span class="n">c2fd</span> <span class="n">C</span>
<span class="o">*</span> <span class="mi">2</span><span class="n">d1b9ed</span> <span class="n">B</span>
<span class="o">*</span> <span class="n">d900590</span> <span class="n">A</span>
</pre></div>


<p>首先 -X 指定提交数:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">format</span><span class="o">-</span><span class="n">patch</span> <span class="o">-</span><span class="mi">2</span>
<span class="mo">0001</span><span class="o">-</span><span class="n">C</span><span class="p">.</span><span class="n">patch</span>
<span class="mo">0002</span><span class="o">-</span><span class="n">D</span><span class="p">.</span><span class="n">patch</span>

<span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">format</span><span class="o">-</span><span class="n">patch</span> <span class="o">-</span><span class="mi">3</span>
<span class="mo">0001</span><span class="o">-</span><span class="n">B</span><span class="p">.</span><span class="n">patch</span>
<span class="mo">0002</span><span class="o">-</span><span class="n">C</span><span class="p">.</span><span class="n">patch</span>
<span class="mo">0003</span><span class="o">-</span><span class="n">D</span><span class="p">.</span><span class="n">patch</span>
</pre></div>


<p>默认情况下, git为每个补丁生成单独的文件, 用一序列数字加上提交日志消息为其命令.</p>
<p>指定提交范围:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">format</span><span class="o">-</span><span class="n">patch</span> <span class="n">master</span><span class="o">~</span><span class="mf">3.</span><span class="p">.</span><span class="n">master</span><span class="o">~</span><span class="mi">1</span>
<span class="mo">0001</span><span class="o">-</span><span class="n">B</span><span class="p">.</span><span class="n">patch</span>
<span class="mo">0002</span><span class="o">-</span><span class="n">C</span><span class="p">.</span><span class="n">patch</span>
</pre></div>


<p>指定某次提交:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">format</span><span class="o">-</span><span class="n">patch</span> <span class="n">master</span><span class="o">~</span><span class="mi">3</span>
<span class="mo">0001</span><span class="o">-</span><span class="n">B</span><span class="p">.</span><span class="n">patch</span>
<span class="mo">0002</span><span class="o">-</span><span class="n">C</span><span class="p">.</span><span class="n">patch</span>
<span class="mo">0003</span><span class="o">-</span><span class="n">D</span><span class="p">.</span><span class="n">patch</span>

<span class="cp"># 如果要包含提交A, 即首次提交:</span>
<span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">format</span><span class="o">-</span><span class="n">patch</span> <span class="o">--</span><span class="n">root</span> <span class="n">master</span><span class="o">~</span><span class="mi">3</span>
<span class="mo">0001</span><span class="o">-</span><span class="n">A</span><span class="p">.</span><span class="n">patch</span>

<span class="cp"># 全部提交, 带上 --root 参数</span>
<span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">format</span><span class="o">-</span><span class="n">patch</span> <span class="o">--</span><span class="n">root</span> <span class="n">master</span>
<span class="mo">0001</span><span class="o">-</span><span class="n">A</span><span class="p">.</span><span class="n">patch</span>
<span class="mo">0002</span><span class="o">-</span><span class="n">B</span><span class="p">.</span><span class="n">patch</span>
<span class="mo">0003</span><span class="o">-</span><span class="n">C</span><span class="p">.</span><span class="n">patch</span>
<span class="mo">0004</span><span class="o">-</span><span class="n">D</span><span class="p">.</span><span class="n">patch</span>
</pre></div>


<p>几种方式还可以互相配合:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">format</span><span class="o">-</span><span class="n">patch</span> <span class="o">--</span><span class="n">root</span> <span class="n">master</span> <span class="o">-</span><span class="mi">2</span>
<span class="mo">0001</span><span class="o">-</span><span class="n">C</span><span class="p">.</span><span class="n">patch</span>
<span class="mo">0002</span><span class="o">-</span><span class="n">D</span><span class="p">.</span><span class="n">patch</span>
</pre></div>


<p>复杂的例子:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">checkout</span> <span class="o">-</span><span class="n">b</span> <span class="n">alt</span> <span class="n">master</span><span class="o">~</span><span class="mi">2</span>
<span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="o">%</span> <span class="n">echo</span> <span class="n">X</span> <span class="o">&gt;&gt;</span> <span class="n">file</span> <span class="p">;</span> <span class="n">git</span> <span class="n">ci</span> <span class="o">-</span><span class="n">mX</span> <span class="n">file</span>
<span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="o">%</span> <span class="n">echo</span> <span class="n">Y</span> <span class="o">&gt;&gt;</span> <span class="n">file</span> <span class="p">;</span> <span class="n">git</span> <span class="n">ci</span> <span class="o">-</span><span class="n">mY</span> <span class="n">file</span>
<span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="o">%</span> <span class="n">echo</span> <span class="n">Z</span> <span class="o">&gt;&gt;</span> <span class="n">file</span> <span class="p">;</span> <span class="n">git</span> <span class="n">ci</span> <span class="o">-</span><span class="n">mZ</span> <span class="n">file</span>

<span class="cp"># 这里使用 --all 可以画出全部分支的ASCII图</span>
<span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">graph</span> <span class="o">--</span><span class="n">oneline</span> <span class="o">--</span><span class="n">decorate</span> <span class="o">--</span><span class="n">all</span> <span class="n">master</span>
<span class="o">*</span> <span class="n">fb5c9a0</span> <span class="p">(</span><span class="n">HEAD</span><span class="p">,</span> <span class="n">alt</span><span class="p">)</span> <span class="n">Z</span>
<span class="o">*</span> <span class="n">f67540b</span> <span class="n">Y</span>
<span class="o">*</span> <span class="n">b50d656</span> <span class="n">X</span>
<span class="o">|</span> <span class="o">*</span> <span class="mf">50e7530</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="n">D</span>
<span class="o">|</span> <span class="o">*</span> <span class="mf">1f</span><span class="mi">0</span><span class="n">c2fd</span> <span class="n">C</span>
<span class="o">|/</span>
<span class="o">*</span> <span class="mi">2</span><span class="n">d1b9ed</span> <span class="n">B</span>
<span class="o">*</span> <span class="n">d900590</span> <span class="n">A</span>
</pre></div>


<p>接着合并alt分支, 处理冲突, 再增加一个新提交:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">checkout</span> <span class="n">master</span>
<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">merge</span> <span class="n">alt</span>
<span class="cp"># ... 处理冲突 ...</span>
<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">echo</span> <span class="n">F</span> <span class="o">&gt;&gt;</span> <span class="n">file</span> <span class="p">;</span> <span class="n">git</span> <span class="n">ci</span> <span class="o">-</span><span class="n">mF</span> <span class="n">file</span>
</pre></div>


<p>现在的结构:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">graph</span> <span class="o">--</span><span class="n">oneline</span> <span class="o">--</span><span class="n">decorate</span> <span class="o">--</span><span class="n">all</span> <span class="n">master</span>
<span class="o">*</span> <span class="n">bfad1bc</span> <span class="p">(</span><span class="n">HEAD</span><span class="p">,</span> <span class="n">master</span><span class="p">)</span> <span class="n">F</span>
<span class="o">*</span>   <span class="mi">1</span><span class="n">dd3011</span> <span class="n">Merge</span> <span class="n">branch</span> <span class="err">&#39;</span><span class="n">alt</span><span class="err">&#39;</span>
<span class="o">|</span>\
<span class="o">|</span> <span class="o">*</span> <span class="n">fb5c9a0</span> <span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="n">Z</span>
<span class="o">|</span> <span class="o">*</span> <span class="n">f67540b</span> <span class="n">Y</span>
<span class="o">|</span> <span class="o">*</span> <span class="n">b50d656</span> <span class="n">X</span>
<span class="o">*</span> <span class="o">|</span> <span class="mf">50e7530</span> <span class="n">D</span>
<span class="o">*</span> <span class="o">|</span> <span class="mf">1f</span><span class="mi">0</span><span class="n">c2fd</span> <span class="n">C</span>
<span class="o">|/</span>
<span class="o">*</span> <span class="mi">2</span><span class="n">d1b9ed</span> <span class="n">B</span>
<span class="o">*</span> <span class="n">d900590</span> <span class="n">A</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">show</span><span class="o">-</span><span class="n">branch</span> <span class="o">--</span><span class="n">more</span><span class="o">=</span><span class="mi">10</span>
<span class="o">!</span> <span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="n">Z</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">F</span>
<span class="o">--</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">F</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="n">Z</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">alt</span><span class="o">^</span><span class="p">]</span> <span class="n">Y</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">alt</span><span class="o">~</span><span class="mi">2</span><span class="p">]</span> <span class="n">X</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">2</span><span class="p">]</span> <span class="n">D</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">3</span><span class="p">]</span> <span class="n">C</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">4</span><span class="p">]</span> <span class="n">B</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">5</span><span class="p">]</span> <span class="n">A</span>
</pre></div>


<p>生成master~2..master范围的补丁:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">format</span><span class="o">-</span><span class="n">patch</span> <span class="n">master</span><span class="o">~</span><span class="mf">2.</span><span class="p">.</span><span class="n">master</span>
<span class="mo">0001</span><span class="o">-</span><span class="n">X</span><span class="p">.</span><span class="n">patch</span>
<span class="mo">0002</span><span class="o">-</span><span class="n">Y</span><span class="p">.</span><span class="n">patch</span>
<span class="mo">0003</span><span class="o">-</span><span class="n">Z</span><span class="p">.</span><span class="n">patch</span>
<span class="mo">0004</span><span class="o">-</span><span class="n">F</span><span class="p">.</span><span class="n">patch</span>
</pre></div>


<p>注意: 合并提交本身是不会生成补丁.</p>
<p>关于范围解析, TODO P250</p>
<p>邮件补丁 TODO</p>
<p>git有两条命令来应用补丁:</p>
<ul>
<li>git am 高层命令</li>
<li>git apply 底层命令</li>
</ul>
<p>基础最开始的A-D的提交图, 增加一个新提交E, 设成patch:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">echo</span> <span class="n">E</span> <span class="o">&gt;&gt;</span> <span class="n">file</span> <span class="p">;</span> <span class="n">git</span> <span class="n">ci</span> <span class="o">-</span><span class="n">mE</span> <span class="n">file</span>
<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">format</span><span class="o">-</span><span class="n">patch</span> <span class="o">-</span><span class="mi">1</span>
<span class="mo">0001</span><span class="o">-</span><span class="n">E</span><span class="p">.</span><span class="n">patch</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">graph</span> <span class="o">--</span><span class="n">oneline</span> <span class="o">--</span><span class="n">decorate</span> <span class="o">--</span><span class="n">all</span> <span class="n">master</span>
<span class="o">*</span> <span class="mo">022</span><span class="n">cb18</span> <span class="p">(</span><span class="n">HEAD</span><span class="p">,</span> <span class="n">master</span><span class="p">)</span> <span class="n">E</span>
<span class="o">*</span> <span class="mf">50e7530</span> <span class="n">D</span>
<span class="o">*</span> <span class="mf">1f</span><span class="mi">0</span><span class="n">c2fd</span> <span class="n">C</span>
<span class="o">*</span> <span class="mi">2</span><span class="n">d1b9ed</span> <span class="n">B</span>
<span class="o">*</span> <span class="n">d900590</span> <span class="n">A</span>

<span class="cp"># 重新构建A-D的提交历史, 或者直接reset撤回D</span>

<span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">more</span> <span class="mo">0001</span><span class="o">-</span><span class="n">E</span><span class="p">.</span><span class="n">patch</span>
<span class="n">From</span> <span class="mo">022</span><span class="n">cb1861d3ae5a500c5152464cece0d3e0082b0</span> <span class="n">Mon</span> <span class="n">Sep</span> <span class="mi">17</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="mi">2001</span>
<span class="nl">From:</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">wtq1990</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="nl">Date:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">7</span> <span class="n">Jul</span> <span class="mi">2015</span> <span class="mi">08</span><span class="o">:</span><span class="mi">46</span><span class="o">:</span><span class="mi">22</span> <span class="o">+</span><span class="mi">0800</span>
<span class="nl">Subject:</span> <span class="p">[</span><span class="n">PATCH</span><span class="p">]</span> <span class="n">E</span>

<span class="o">---</span>
 <span class="n">file</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">+</span>
 <span class="mi">1</span> <span class="n">file</span> <span class="n">changed</span><span class="p">,</span> <span class="mi">1</span> <span class="n">insertion</span><span class="p">(</span><span class="o">+</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">file</span> <span class="n">b</span><span class="o">/</span><span class="n">file</span>
<span class="n">index</span> <span class="mi">8422</span><span class="n">d40</span><span class="p">.</span><span class="mf">.8f</span><span class="n">da00d</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">file</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">file</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span> <span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span> <span class="err">@@</span> <span class="n">A</span>
 <span class="n">B</span>
 <span class="n">C</span>
 <span class="n">D</span>
<span class="o">+</span><span class="n">E</span>
<span class="o">--</span>
<span class="mf">2.3.5</span>

<span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">am</span> <span class="mo">0001</span><span class="o">-</span><span class="n">E</span><span class="p">.</span><span class="n">patch</span>
<span class="nl">Applying:</span> <span class="n">E</span>

<span class="n">commit</span> <span class="n">b98a9b55f6952f21ea64b28a478e0936744f8039</span>
<span class="nl">Author:</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">wtq1990</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="nl">Date:</span>   <span class="n">Tue</span> <span class="n">Jul</span> <span class="mi">7</span> <span class="mi">08</span><span class="o">:</span><span class="mi">46</span><span class="o">:</span><span class="mi">22</span> <span class="mi">2015</span> <span class="o">+</span><span class="mi">0800</span>

    <span class="n">E</span>

<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">file</span> <span class="n">b</span><span class="o">/</span><span class="n">file</span>
<span class="n">index</span> <span class="mi">8422</span><span class="n">d40</span><span class="p">.</span><span class="mf">.8f</span><span class="n">da00d</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">file</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">file</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span> <span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span> <span class="err">@@</span> <span class="n">A</span>
 <span class="n">B</span>
 <span class="n">C</span>
 <span class="n">D</span>
<span class="o">+</span><span class="n">E</span>
</pre></div>


<p>git am后会生成新的提交</p>
<p>如果使用 <code>git apply</code>, 则会把修改保留在工作目录, 但是不会提交:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="n">HEAD</span><span class="o">^</span>
<span class="n">HEAD</span> <span class="n">is</span> <span class="n">now</span> <span class="n">at</span> <span class="mf">50e7530</span> <span class="n">D</span>

<span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">apply</span> <span class="mo">0001</span><span class="o">-</span><span class="n">E</span><span class="p">.</span><span class="n">patch</span>

<span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">diff</span>
<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">file</span> <span class="n">b</span><span class="o">/</span><span class="n">file</span>
<span class="n">index</span> <span class="mi">8422</span><span class="n">d40</span><span class="p">.</span><span class="mf">.8f</span><span class="n">da00d</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">file</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">file</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span> <span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span> <span class="err">@@</span> <span class="n">A</span>
 <span class="n">B</span>
 <span class="n">C</span>
 <span class="n">D</span>
<span class="o">+</span><span class="n">E</span>
</pre></div>


<p>有时在仓库里作了一些修改没有提交, 也可以用git diff生成一个patch文件, 然后传给别人, 对象可以直接应用上这个patch:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">apply</span> <span class="n">patch</span><span class="p">.</span><span class="n">file</span>
</pre></div>


<p>在没有git的情况下, 可以使用<code>patch</code>命令:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">patch</span> <span class="o">-</span><span class="n">p1</span> <span class="o">&lt;</span> <span class="n">patch</span><span class="p">.</span><span class="n">file</span>
</pre></div>


<p>参考:</p>
<ul>
<li><a href="http://stackoverflow.com/questions/12320863/how-do-you-take-a-git-diff-file-and-apply-it-to-a-local-branch-that-is-a-copy-o">How do you take a git diff file, and apply it to a local branch that is a copy of the same repository?</a></li>
<li><a href="http://stackoverflow.com/questions/3418277/how-to-apply-git-diff-patch-without-git-installed">How to apply <code>git diff</code> patch without Git installed?</a></li>
</ul>
<p>关于复杂的情况, 如之前A-Z的情况, 中间有个分支alt从B点分出去, 再重复贴一次图:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">graph</span> <span class="o">--</span><span class="n">oneline</span> <span class="o">--</span><span class="n">decorate</span> <span class="o">--</span><span class="n">all</span> <span class="n">master</span>
<span class="o">*</span> <span class="n">bfad1bc</span> <span class="p">(</span><span class="n">HEAD</span><span class="p">,</span> <span class="n">master</span><span class="p">)</span> <span class="n">F</span>
<span class="o">*</span>   <span class="mi">1</span><span class="n">dd3011</span> <span class="n">Merge</span> <span class="n">branch</span> <span class="err">&#39;</span><span class="n">alt</span><span class="err">&#39;</span>
<span class="o">|</span>\
<span class="o">|</span> <span class="o">*</span> <span class="n">fb5c9a0</span> <span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="n">Z</span>
<span class="o">|</span> <span class="o">*</span> <span class="n">f67540b</span> <span class="n">Y</span>
<span class="o">|</span> <span class="o">*</span> <span class="n">b50d656</span> <span class="n">X</span>
<span class="o">*</span> <span class="o">|</span> <span class="mf">50e7530</span> <span class="n">D</span>
<span class="o">*</span> <span class="o">|</span> <span class="mf">1f</span><span class="mi">0</span><span class="n">c2fd</span> <span class="n">C</span>
<span class="o">|/</span>
<span class="o">*</span> <span class="mi">2</span><span class="n">d1b9ed</span> <span class="n">B</span>
<span class="o">*</span> <span class="n">d900590</span> <span class="n">A</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">show</span><span class="o">-</span><span class="n">branch</span> <span class="o">--</span><span class="n">more</span><span class="o">=</span><span class="mi">10</span>
<span class="o">!</span> <span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="n">Z</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">F</span>
<span class="o">--</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">F</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="n">Z</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">alt</span><span class="o">^</span><span class="p">]</span> <span class="n">Y</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">alt</span><span class="o">~</span><span class="mi">2</span><span class="p">]</span> <span class="n">X</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">2</span><span class="p">]</span> <span class="n">D</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">3</span><span class="p">]</span> <span class="n">C</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">4</span><span class="p">]</span> <span class="n">B</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">5</span><span class="p">]</span> <span class="n">A</span>
</pre></div>


<p>生成除A以外的patches:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">format</span><span class="o">-</span><span class="n">patch</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span> <span class="n">master</span><span class="o">~</span><span class="mi">5</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/</span><span class="mo">0001</span><span class="o">-</span><span class="n">B</span><span class="p">.</span><span class="n">patch</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/</span><span class="mo">0002</span><span class="o">-</span><span class="n">C</span><span class="p">.</span><span class="n">patch</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/</span><span class="mo">0003</span><span class="o">-</span><span class="n">D</span><span class="p">.</span><span class="n">patch</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/</span><span class="mo">0004</span><span class="o">-</span><span class="n">X</span><span class="p">.</span><span class="n">patch</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/</span><span class="mo">0005</span><span class="o">-</span><span class="n">Y</span><span class="p">.</span><span class="n">patch</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/</span><span class="mo">0006</span><span class="o">-</span><span class="n">Z</span><span class="p">.</span><span class="n">patch</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/</span><span class="mo">0007</span><span class="o">-</span><span class="n">F</span><span class="p">.</span><span class="n">patch</span>
</pre></div>


<p>现在回到提交A, 然后应用这些patches:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="n">HEAD</span><span class="o">~</span><span class="mi">5</span>
<span class="n">HEAD</span> <span class="n">is</span> <span class="n">now</span> <span class="n">at</span> <span class="n">d900590</span> <span class="n">A</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">am</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/*</span>
<span class="nl">Applying:</span> <span class="n">B</span>
<span class="nl">Applying:</span> <span class="n">C</span>
<span class="nl">Applying:</span> <span class="n">D</span>
<span class="nl">Applying:</span> <span class="n">X</span>
<span class="nl">error:</span> <span class="n">patch</span> <span class="n">failed</span><span class="o">:</span> <span class="n">file</span><span class="o">:</span><span class="mi">1</span>
<span class="nl">error:</span> <span class="n">file</span><span class="o">:</span> <span class="n">patch</span> <span class="n">does</span> <span class="n">not</span> <span class="n">apply</span>
<span class="n">Patch</span> <span class="n">failed</span> <span class="n">at</span> <span class="mo">0004</span> <span class="n">X</span>
<span class="n">The</span> <span class="n">copy</span> <span class="n">of</span> <span class="n">the</span> <span class="n">patch</span> <span class="n">that</span> <span class="n">failed</span> <span class="n">is</span> <span class="n">found</span> <span class="n">in</span><span class="o">:</span>
   <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">myrepo</span><span class="o">/</span><span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">rebase</span><span class="o">-</span><span class="n">apply</span><span class="o">/</span><span class="n">patch</span>
<span class="n">When</span> <span class="n">you</span> <span class="n">have</span> <span class="n">resolved</span> <span class="n">this</span> <span class="n">problem</span><span class="p">,</span> <span class="n">run</span> <span class="s">&quot;git am --continue&quot;</span><span class="p">.</span>
<span class="n">If</span> <span class="n">you</span> <span class="n">prefer</span> <span class="n">to</span> <span class="n">skip</span> <span class="n">this</span> <span class="n">patch</span><span class="p">,</span> <span class="n">run</span> <span class="s">&quot;git am --skip&quot;</span> <span class="n">instead</span><span class="p">.</span>
<span class="n">To</span> <span class="n">restore</span> <span class="n">the</span> <span class="n">original</span> <span class="n">branch</span> <span class="n">and</span> <span class="n">stop</span> <span class="n">patching</span><span class="p">,</span> <span class="n">run</span> <span class="s">&quot;git am --abort&quot;</span><span class="p">.</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">more</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">rebase</span><span class="o">-</span><span class="n">apply</span><span class="o">/</span><span class="n">patch</span>
<span class="o">---</span>
 <span class="n">file</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">+</span>
 <span class="mi">1</span> <span class="n">file</span> <span class="n">changed</span><span class="p">,</span> <span class="mi">1</span> <span class="n">insertion</span><span class="p">(</span><span class="o">+</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">file</span> <span class="n">b</span><span class="o">/</span><span class="n">file</span>
<span class="n">index</span> <span class="mi">35</span><span class="n">d242b</span><span class="p">.</span><span class="mf">.7f</span><span class="mi">9826</span><span class="n">a</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">file</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">file</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="err">@@</span>
 <span class="n">A</span>
 <span class="n">B</span>
<span class="o">+</span><span class="n">X</span>
<span class="o">--</span>
<span class="mf">2.3.5</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">status</span>
<span class="n">On</span> <span class="n">branch</span> <span class="n">master</span>
<span class="n">You</span> <span class="n">are</span> <span class="n">in</span> <span class="n">the</span> <span class="n">middle</span> <span class="n">of</span> <span class="n">an</span> <span class="n">am</span> <span class="n">session</span><span class="p">.</span>
  <span class="p">(</span><span class="n">fix</span> <span class="n">conflicts</span> <span class="n">and</span> <span class="n">then</span> <span class="n">run</span> <span class="s">&quot;git am --continue&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">use</span> <span class="s">&quot;git am --skip&quot;</span> <span class="n">to</span> <span class="n">skip</span> <span class="n">this</span> <span class="n">patch</span><span class="p">)</span>
  <span class="p">(</span><span class="n">use</span> <span class="s">&quot;git am --abort&quot;</span> <span class="n">to</span> <span class="n">restore</span> <span class="n">the</span> <span class="n">original</span> <span class="n">branch</span><span class="p">)</span>

<span class="n">nothing</span> <span class="n">to</span> <span class="n">commit</span><span class="p">,</span> <span class="n">working</span> <span class="n">directory</span> <span class="n">clean</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">show</span><span class="o">-</span><span class="n">branch</span> <span class="o">--</span><span class="n">more</span><span class="o">=</span><span class="mi">4</span>
<span class="o">!</span> <span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="n">Z</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">D</span>
<span class="o">--</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">D</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">^</span><span class="p">]</span> <span class="n">C</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">2</span><span class="p">]</span> <span class="n">B</span>
<span class="o">+</span>  <span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="n">Z</span>
<span class="o">+</span>  <span class="p">[</span><span class="n">alt</span><span class="o">^</span><span class="p">]</span> <span class="n">Y</span>
<span class="o">+</span>  <span class="p">[</span><span class="n">alt</span><span class="o">~</span><span class="mi">2</span><span class="p">]</span> <span class="n">X</span>
<span class="o">+</span>  <span class="p">[</span><span class="n">alt</span><span class="o">~</span><span class="mi">3</span><span class="p">]</span> <span class="n">B</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">3</span><span class="p">]</span> <span class="n">A</span>
</pre></div>


<p>执行am失败了, 并且给了一些有用的提示操作. 不过这里失败了就是失败了, 没有类似合并冲突的解决的脏数据遗留下来.</p>
<p>.git/rebase-apply/patch文件还保留了失败时修改的内容, 老版本git在.dotest目录下. 这个文件是要清理掉的, 不然后续执行am会报错.</p>
<div class="hlcode"><pre><span class="n">The</span> <span class="n">copy</span> <span class="n">of</span> <span class="n">the</span> <span class="n">patch</span> <span class="n">that</span> <span class="n">failed</span> <span class="n">is</span> <span class="n">found</span> <span class="n">in</span><span class="o">:</span>
   <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">myrepo</span><span class="o">/</span><span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">rebase</span><span class="o">-</span><span class="n">apply</span><span class="o">/</span><span class="n">patch</span>
</pre></div>


<p>这时使用<code>-3/-3way</code>三路合并的方式来解决这个问题:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="n">HEAD</span><span class="o">~</span><span class="mi">3</span>
<span class="n">HEAD</span> <span class="n">is</span> <span class="n">now</span> <span class="n">at</span> <span class="n">d900590</span> <span class="n">A</span>

<span class="cp"># 这里如果没清理 .git/rebase-apply/ 目录的话就会报错</span>
<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">am</span> <span class="o">-</span><span class="mi">3</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/*</span>
<span class="n">previous</span> <span class="n">rebase</span> <span class="n">directory</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">myrepo</span><span class="o">/</span><span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">rebase</span><span class="o">-</span><span class="n">apply</span> <span class="n">still</span> <span class="n">exists</span> <span class="n">but</span> <span class="n">mbox</span> <span class="n">given</span><span class="p">.</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">rebase</span><span class="o">-</span><span class="n">apply</span>
</pre></div>


<p>继续重新执行三路合并应用patch:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="o">%</span> <span class="nx">git</span> <span class="nb">am</span> <span class="o">-</span><span class="mi">3</span> <span class="p">/</span><span class="nx">tmp</span><span class="p">/</span><span class="nx">patches</span><span class="o">/*</span>
<span class="nx">Applying</span><span class="p">:</span> <span class="nx">B</span>
<span class="nx">Applying</span><span class="p">:</span> <span class="nx">C</span>
<span class="nx">Applying</span><span class="p">:</span> <span class="nb">D</span>
<span class="nx">Applying</span><span class="p">:</span> <span class="nx">X</span>
<span class="nx">Using</span> <span class="nb">index</span> <span class="nx">info</span> <span class="k">to</span> <span class="nx">reconstruct</span> <span class="nx">a</span> <span class="nx">base</span> <span class="nx">tree...</span>
<span class="nx">M</span>       <span class="nb">file</span>
<span class="nx">Falling</span> <span class="nb">back</span> <span class="k">to</span> <span class="nx">patching</span> <span class="nx">base</span> <span class="ow">and</span> <span class="mi">3</span><span class="na">-way</span> <span class="nx">merge...</span>
<span class="nx">Auto</span><span class="na">-merging</span> <span class="nb">file</span>
<span class="nx">CONFLICT</span> <span class="p">(</span><span class="nb">content</span><span class="p">):</span> <span class="nb">Merge</span> <span class="n">conflict</span> <span class="k">in</span> <span class="nb">file</span>
<span class="nx">Failed</span> <span class="k">to</span> <span class="n">merge</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">changes.</span>
<span class="nx">Patch</span> <span class="nx">failed</span> <span class="nx">at</span> <span class="mi">0004</span> <span class="nx">X</span>
<span class="nx">The</span> <span class="nx">copy</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">patch</span> <span class="nx">that</span> <span class="nx">failed</span> <span class="nx">is</span> <span class="n">found</span> <span class="k">in</span><span class="p">:</span>
   <span class="p">/</span><span class="nb">path</span><span class="p">/</span><span class="k">to</span><span class="p">/</span><span class="nx">myrepo</span><span class="p">/</span><span class="nx">.git</span><span class="p">/</span><span class="nx">rebase</span><span class="na">-apply</span><span class="p">/</span><span class="nx">patch</span>
<span class="nx">When</span> <span class="nx">you</span> <span class="nx">have</span> <span class="nx">resolved</span> <span class="nx">this</span> <span class="nx">problem</span><span class="p">,</span> <span class="nb">run</span> <span class="s2">&quot;git am --continue&quot;</span><span class="nx">.</span>
<span class="k">If</span> <span class="nx">you</span> <span class="nx">prefer</span> <span class="k">to</span> <span class="k">skip</span> <span class="nx">this</span> <span class="nx">patch</span><span class="p">,</span> <span class="nb">run</span> <span class="s2">&quot;git am --skip&quot;</span> <span class="nx">instead.</span>
<span class="k">To</span> <span class="nx">restore</span> <span class="nx">the</span> <span class="nx">original</span> <span class="nx">branch</span> <span class="ow">and</span> <span class="nb">stop</span> <span class="nx">patching</span><span class="p">,</span> <span class="nb">run</span> <span class="s2">&quot;git am --abort&quot;</span><span class="nx">.</span>

<span class="p">(</span><span class="nx">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="nx">git</span> <span class="nb">status</span>
<span class="k">On</span> <span class="nx">branch</span> <span class="nx">master</span>
<span class="nx">You</span> <span class="n">are</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">middle</span> <span class="nx">of</span> <span class="nx">an</span> <span class="nb">am</span> <span class="nx">session.</span>
  <span class="p">(</span><span class="nx">fix</span> <span class="nx">conflicts</span> <span class="ow">and</span> <span class="nx">then</span> <span class="nb">run</span> <span class="s2">&quot;git am --continue&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git am --skip&quot;</span> <span class="k">to</span> <span class="k">skip</span> <span class="nx">this</span> <span class="nx">patch</span><span class="p">)</span>
  <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git am --abort&quot;</span> <span class="k">to</span> <span class="nx">restore</span> <span class="nx">the</span> <span class="nx">original</span> <span class="nx">branch</span><span class="p">)</span>

<span class="nx">Unmerged</span> <span class="nx">paths</span><span class="p">:</span>
  <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git reset HEAD &lt;file&gt;...&quot;</span> <span class="k">to</span> <span class="nx">unstage</span><span class="p">)</span>
  <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git add &lt;file&gt;...&quot;</span> <span class="k">to</span> <span class="nx">mark</span> <span class="nx">resolution</span><span class="p">)</span>

        <span class="nx">both</span> <span class="nx">modified</span><span class="p">:</span>   <span class="nb">file</span>

<span class="nx">no</span> <span class="nx">changes</span> <span class="nx">added</span> <span class="k">to</span> <span class="nx">commit</span> <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git add&quot;</span> <span class="ow">and</span><span class="p">/</span><span class="nb">or</span> <span class="s2">&quot;git commit -a&quot;</span><span class="p">)</span>
</pre></div>


<p>这次和之前不一样, 虽然失败了, 但是给了一个机会来处理:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">vi</span> <span class="n">file</span>
<span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">add</span> <span class="n">file</span>
<span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">am</span> <span class="o">--</span><span class="k">continue</span>
<span class="nl">Applying:</span> <span class="n">X</span>
<span class="nl">Applying:</span> <span class="n">Y</span>
<span class="n">Using</span> <span class="n">index</span> <span class="n">info</span> <span class="n">to</span> <span class="n">reconstruct</span> <span class="n">a</span> <span class="n">base</span> <span class="n">tree</span><span class="p">...</span>
<span class="n">M</span>       <span class="n">file</span>
<span class="n">Falling</span> <span class="n">back</span> <span class="n">to</span> <span class="n">patching</span> <span class="n">base</span> <span class="n">and</span> <span class="mi">3</span><span class="o">-</span><span class="n">way</span> <span class="n">merge</span><span class="p">...</span>
<span class="n">Auto</span><span class="o">-</span><span class="n">merging</span> <span class="n">file</span>
<span class="nl">Applying:</span> <span class="n">Z</span>
<span class="n">Using</span> <span class="n">index</span> <span class="n">info</span> <span class="n">to</span> <span class="n">reconstruct</span> <span class="n">a</span> <span class="n">base</span> <span class="n">tree</span><span class="p">...</span>
<span class="n">M</span>       <span class="n">file</span>
<span class="n">Falling</span> <span class="n">back</span> <span class="n">to</span> <span class="n">patching</span> <span class="n">base</span> <span class="n">and</span> <span class="mi">3</span><span class="o">-</span><span class="n">way</span> <span class="n">merge</span><span class="p">...</span>
<span class="n">Auto</span><span class="o">-</span><span class="n">merging</span> <span class="n">file</span>
<span class="nl">Applying:</span> <span class="n">F</span>
</pre></div>


<p>现在的结构图:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">show</span><span class="o">-</span><span class="n">branch</span> <span class="o">--</span><span class="n">more</span><span class="o">=</span><span class="mi">10</span>
<span class="o">!</span> <span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="n">Z</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">F</span>
<span class="o">--</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">F</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">^</span><span class="p">]</span> <span class="n">Z</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">2</span><span class="p">]</span> <span class="n">Y</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">3</span><span class="p">]</span> <span class="n">X</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">4</span><span class="p">]</span> <span class="n">D</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">5</span><span class="p">]</span> <span class="n">C</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">6</span><span class="p">]</span> <span class="n">B</span>
<span class="o">+</span>  <span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="n">Z</span>
<span class="o">+</span>  <span class="p">[</span><span class="n">alt</span><span class="o">^</span><span class="p">]</span> <span class="n">Y</span>
<span class="o">+</span>  <span class="p">[</span><span class="n">alt</span><span class="o">~</span><span class="mi">2</span><span class="p">]</span> <span class="n">X</span>
<span class="o">+</span>  <span class="p">[</span><span class="n">alt</span><span class="o">~</span><span class="mi">3</span><span class="p">]</span> <span class="n">B</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">7</span><span class="p">]</span> <span class="n">A</span>


<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">pager</span>  <span class="n">log</span> <span class="o">--</span><span class="n">graph</span> <span class="o">--</span><span class="n">oneline</span> <span class="o">--</span><span class="n">decorate</span> <span class="o">--</span><span class="n">all</span>
<span class="o">*</span> <span class="n">b16dc1a</span> <span class="p">(</span><span class="n">HEAD</span><span class="p">,</span> <span class="n">master</span><span class="p">)</span> <span class="n">F</span>
<span class="o">*</span> <span class="mf">79f</span><span class="mi">431</span><span class="n">d</span> <span class="n">Z</span>
<span class="o">*</span> <span class="mi">9642</span><span class="n">ba2</span> <span class="n">Y</span>
<span class="o">*</span> <span class="mi">816197</span><span class="n">e</span> <span class="n">X</span>
<span class="o">*</span> <span class="mi">0</span><span class="n">d3f91b</span> <span class="n">D</span>
<span class="o">*</span> <span class="n">b30ce22</span> <span class="n">C</span>
<span class="o">*</span> <span class="mi">7</span><span class="n">dd8d42</span> <span class="n">B</span>
<span class="o">|</span> <span class="o">*</span> <span class="n">fb5c9a0</span> <span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="n">Z</span>
<span class="o">|</span> <span class="o">*</span> <span class="n">f67540b</span> <span class="n">Y</span>
<span class="o">|</span> <span class="o">*</span> <span class="n">b50d656</span> <span class="n">X</span>
<span class="o">|</span> <span class="o">*</span> <span class="mi">2</span><span class="n">d1b9ed</span> <span class="n">B</span>
<span class="o">|/</span>
<span class="o">*</span> <span class="n">d900590</span> <span class="n">A</span>
</pre></div>


<p>应用patch后的结构是线性的</p>
<p>如果要想和原来的结构保持一致, 估计只能手动来处理之间的关系了:</p>
<div class="hlcode"><pre><span class="cp"># 当前停留在B点</span>
<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">am</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/</span><span class="mo">0002</span><span class="o">-</span><span class="n">C</span><span class="p">.</span><span class="n">patch</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/</span><span class="mo">0003</span><span class="o">-</span><span class="n">D</span><span class="p">.</span><span class="n">patch</span>
<span class="nl">Applying:</span> <span class="n">C</span>
<span class="nl">Applying:</span> <span class="n">D</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">show</span><span class="o">-</span><span class="n">branch</span> <span class="o">--</span><span class="n">more</span><span class="o">=</span><span class="mi">3</span>
<span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">D</span>
<span class="p">[</span><span class="n">master</span><span class="o">^</span><span class="p">]</span> <span class="n">C</span>
<span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">2</span><span class="p">]</span> <span class="n">B</span>
<span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">3</span><span class="p">]</span> <span class="n">A</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">co</span> <span class="o">-</span><span class="n">b</span> <span class="n">alt</span> <span class="n">master</span><span class="o">~</span><span class="mi">2</span>
<span class="n">Switched</span> <span class="n">to</span> <span class="n">a</span> <span class="n">new</span> <span class="n">branch</span> <span class="err">&#39;</span><span class="n">alt</span><span class="err">&#39;</span>

<span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">am</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/</span><span class="mo">0004</span><span class="o">-</span><span class="n">X</span><span class="p">.</span><span class="n">patch</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/</span><span class="mo">0005</span><span class="o">-</span><span class="n">Y</span><span class="p">.</span><span class="n">patch</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/</span><span class="mo">0006</span><span class="o">-</span><span class="n">Z</span><span class="p">.</span><span class="n">patch</span>
<span class="nl">Applying:</span> <span class="n">X</span>
<span class="nl">Applying:</span> <span class="n">Y</span>
<span class="nl">Applying:</span> <span class="n">Z</span>

<span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">co</span> <span class="n">master</span>
<span class="n">Switched</span> <span class="n">to</span> <span class="n">branch</span> <span class="err">&#39;</span><span class="n">master</span><span class="err">&#39;</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">show</span><span class="o">-</span><span class="n">branch</span> <span class="o">--</span><span class="n">more</span><span class="o">=</span><span class="mi">10</span>
<span class="o">!</span> <span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="n">Z</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">D</span>
<span class="o">--</span>
<span class="o">+</span>  <span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="n">Z</span>
<span class="o">+</span>  <span class="p">[</span><span class="n">alt</span><span class="o">^</span><span class="p">]</span> <span class="n">Y</span>
<span class="o">+</span>  <span class="p">[</span><span class="n">alt</span><span class="o">~</span><span class="mi">2</span><span class="p">]</span> <span class="n">X</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">D</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">^</span><span class="p">]</span> <span class="n">C</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">alt</span><span class="o">~</span><span class="mi">3</span><span class="p">]</span> <span class="n">B</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">alt</span><span class="o">~</span><span class="mi">4</span><span class="p">]</span> <span class="n">A</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">merge</span> <span class="n">alt</span>
<span class="n">Auto</span><span class="o">-</span><span class="n">merging</span> <span class="n">file</span>
<span class="n">CONFLICT</span> <span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">:</span> <span class="n">Merge</span> <span class="n">conflict</span> <span class="k">in</span> <span class="n">file</span>
<span class="n">Automatic</span> <span class="n">merge</span> <span class="n">failed</span><span class="p">;</span> <span class="n">fix</span> <span class="n">conflicts</span> <span class="n">and</span> <span class="n">then</span> <span class="n">commit</span> <span class="n">the</span> <span class="n">result</span><span class="p">.</span>

<span class="cp"># ... 处理冲突 ...</span>
<span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">ci</span>
<span class="p">[</span><span class="n">master</span> <span class="n">eab9bcf</span><span class="p">]</span> <span class="n">Merge</span> <span class="n">branch</span> <span class="err">&#39;</span><span class="n">alt</span><span class="err">&#39;</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">am</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">patches</span><span class="o">/</span><span class="mo">0007</span><span class="o">-</span><span class="n">F</span><span class="p">.</span><span class="n">patch</span>
<span class="nl">Applying:</span> <span class="n">F</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">%</span> <span class="n">git</span> <span class="n">show</span><span class="o">-</span><span class="n">branch</span> <span class="o">--</span><span class="n">more</span><span class="o">=</span><span class="mi">10</span>
<span class="o">!</span> <span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="n">Z</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">F</span>
<span class="o">--</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span> <span class="n">F</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">alt</span><span class="p">]</span> <span class="n">Z</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">alt</span><span class="o">^</span><span class="p">]</span> <span class="n">Y</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">alt</span><span class="o">~</span><span class="mi">2</span><span class="p">]</span> <span class="n">X</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">2</span><span class="p">]</span> <span class="n">D</span>
 <span class="o">*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">3</span><span class="p">]</span> <span class="n">C</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">4</span><span class="p">]</span> <span class="n">B</span>
<span class="o">+*</span> <span class="p">[</span><span class="n">master</span><span class="o">~</span><span class="mi">5</span><span class="p">]</span> <span class="n">A</span>
</pre></div>


<h2 id="15">15. 钩子</h2>
<p>Git在操作如提交, 补丁等事件时, 可以通过钩子(hook)来触发一些脚本.</p>
<p>大多数钩子分为两类:</p>
<ul>
<li>前置(pre), 在动作完成前调用</li>
<li>后置(post), 在动作完成后调用</li>
</ul>
<p>如果钩子以非0状态退出(如 <code>exit 1</code>), 则表示执行失败, Git动作中止; 不过后置的状态无法影响Git操作的结果.</p>
<p>谨慎的使用钩子:</p>
<ul>
<li>钩子会改变Git的行为</li>
<li>钩子是本地的, 不随版本库一起提交到远端, 所以可能多个开发者的动作行为不一样</li>
<li>钩子会影响动作的速度</li>
</ul>
<p>每个版本库新建的时候, 会默认提供一些钩子模板, 以<code>.sample</code>结尾, 状态是禁止的:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="n">tree</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">hooks</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">hooks</span>
<span class="err">├──</span> <span class="n">applypatch</span><span class="o">-</span><span class="n">msg</span><span class="p">.</span><span class="n">sample</span>
<span class="err">├──</span> <span class="n">commit</span><span class="o">-</span><span class="n">msg</span><span class="p">.</span><span class="n">sample</span>
<span class="err">├──</span> <span class="n">post</span><span class="o">-</span><span class="n">update</span><span class="p">.</span><span class="n">sample</span>
<span class="err">├──</span> <span class="n">pre</span><span class="o">-</span><span class="n">applypatch</span><span class="p">.</span><span class="n">sample</span>
<span class="err">├──</span> <span class="n">pre</span><span class="o">-</span><span class="n">commit</span>
<span class="err">├──</span> <span class="n">pre</span><span class="o">-</span><span class="n">commit</span><span class="p">.</span><span class="n">sample</span>
<span class="err">├──</span> <span class="n">pre</span><span class="o">-</span><span class="n">push</span><span class="p">.</span><span class="n">sample</span>
<span class="err">├──</span> <span class="n">pre</span><span class="o">-</span><span class="n">rebase</span><span class="p">.</span><span class="n">sample</span>
<span class="err">├──</span> <span class="n">prepare</span><span class="o">-</span><span class="n">commit</span><span class="o">-</span><span class="n">msg</span><span class="p">.</span><span class="n">sample</span>
<span class="err">└──</span> <span class="n">update</span><span class="p">.</span><span class="n">sample</span>
</pre></div>


<p>如果要使一个钩子起作用, 必须保证:</p>
<ul>
<li>去掉 .sample 后缀</li>
<li>拥有可执行权限</li>
</ul>
<p>也可以自己写钩子.</p>
<p>因为钩子是针对特定动作的特定时刻起作用的, 所以钩子名(脚本名)需要为特定范围的名字, 可以见 <code>git help hooks</code> 查看可用的钩子.</p>
<p>提交相关钩子:</p>
<div class="hlcode"><pre><span class="n">pre</span><span class="o">-</span><span class="n">commit</span> <span class="o">-&gt;</span> <span class="n">prepare</span><span class="o">-</span><span class="n">commit</span><span class="o">-</span><span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">commit</span><span class="o">-</span><span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">post</span><span class="o">-</span><span class="n">commit</span>
</pre></div>


<p>补丁相关钩子:</p>
<div class="hlcode"><pre><span class="n">applypatch</span><span class="o">-</span><span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">pre</span><span class="o">-</span><span class="n">applypatch</span> <span class="o">-&gt;</span> <span class="n">post</span><span class="o">-</span><span class="n">applypatch</span>
</pre></div>


<p>push相关钩子(Git服务端执行):</p>
<div class="hlcode"><pre><span class="n">pre</span><span class="o">-</span><span class="n">receive</span> <span class="o">-&gt;</span> <span class="n">update</span> <span class="o">-&gt;</span> <span class="n">post</span><span class="o">-</span><span class="n">receive</span> <span class="o">-&gt;</span> <span class="n">post</span><span class="o">-</span><span class="n">update</span>
</pre></div>


<h2 id="16">16. 合并项目</h2>
<p>项目管理过程中经常会遇到需要将别的项目加入到自己项目中.</p>
<p>比如某个网站开发, 需要用到一些前端的库. 最简单的方法就是将压缩包下载解压后放到本地指定目录, 升级的时候覆盖就行. 但是一是每次升级这些第三方库时, 还需要做一次无意义的提交, 如果频繁修改是很坑爹的; 另外就是升级也比较麻烦, 并且如果第三方依赖比较大, 也占用了很多无意义的空间.</p>
<p>又比如一个项目的某个子目录是一些功能函数, 现在另一个项目也想用到. 以前用svn时, 是支持部分检出(partial checkout), 但是git是不支持的.</p>
<p>针对上面的这类情况, 都可以考虑子模块(submodule), 说白了就是模块化, 一个模块负责好相应的功能, 其它需要用到它的都使用这个模块, 保证统一性; 并且使用了git的子模块, 对于升级维护都比较方便, 也不需要考虑太多第三方依赖库需要的空间问题.</p>
<p><code>git submodule</code>由两个独立功能组合:</p>
<ul>
<li>gitlink</li>
<li>git submodule命令</li>
</ul>
<p>gitlink是一个从树对象(tree object)到一个提交对象(commit object)的链接. 之前介绍过git对象时, 一般情况下, 树对象指向的是一组blob对象和树对象. 所以这里是比较特殊的情况.</p>
<p>现在有一个仓库目录git-main, 子目录git-sub, 分别是两个库:</p>
<div class="hlcode"><pre><span class="nx">git</span><span class="na">-main</span><span class="o">/</span> <span class="p">(</span><span class="nx">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="nx">tree</span>
<span class="nx">.</span>
<span class="err">├──</span> <span class="nx">git</span><span class="na">-sub</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="nx">sub.txt</span>
<span class="err">└──</span> <span class="nx">hello.txt</span>

<span class="mi">1</span> <span class="nx">directory</span><span class="p">,</span> <span class="mi">2</span> <span class="nx">files</span>

<span class="nx">git</span><span class="na">-main</span><span class="o">/</span> <span class="p">(</span><span class="nx">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="nx">remote</span> <span class="na">-v</span>
<span class="nx">origin</span>  <span class="nx">https</span><span class="p">:</span><span class="c1">//git.example.com/tankywoo/git-main.git (fetch)</span>
<span class="nx">origin</span>  <span class="nx">https</span><span class="p">:</span><span class="c1">//git.example.com/tankywoo/git-main.git (push)</span>

<span class="nx">git</span><span class="na">-main</span><span class="o">/</span> <span class="p">(</span><span class="nx">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="nx">cd</span> <span class="nx">git</span><span class="na">-sub</span>
<span class="nx">git</span><span class="na">-main</span><span class="p">/</span><span class="nx">git</span><span class="na">-sub</span><span class="o">/</span> <span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="nx">remote</span> <span class="na">-v</span>
<span class="nx">origin</span>  <span class="nx">https</span><span class="p">:</span><span class="c1">//git.example.com/tankywoo/git-sub.git (fetch)</span>
<span class="nx">origin</span>  <span class="nx">https</span><span class="p">:</span><span class="c1">//git.example.com/tankywoo/git-sub.git (push)</span>

<span class="nx">git</span><span class="na">-main</span><span class="o">/</span> <span class="p">(</span><span class="nx">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="nx">gst</span>
<span class="k">On</span> <span class="nx">branch</span> <span class="nx">master</span>
<span class="nx">Your</span> <span class="nx">branch</span> <span class="nx">is</span> <span class="nb">up</span><span class="na">-to-date</span> <span class="k">with</span> <span class="s1">&#39;origin/master&#39;</span><span class="nx">.</span>
<span class="nx">Untracked</span> <span class="nx">files</span><span class="p">:</span>
  <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git add &lt;file&gt;...&quot;</span> <span class="k">to</span> <span class="n">include</span> <span class="k">in</span> <span class="nx">what</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">committed</span><span class="p">)</span>

        <span class="nx">git</span><span class="na">-sub</span><span class="o">/</span>

<span class="nx">nothing</span> <span class="nx">added</span> <span class="k">to</span> <span class="nx">commit</span> <span class="nx">but</span> <span class="nx">untracked</span> <span class="nx">files</span> <span class="nx">present</span> <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git add&quot;</span> <span class="k">to</span> <span class="nx">track</span><span class="p">)</span>
</pre></div>


<p>现在将 git-sub 加入到 git-main库:</p>
<div class="hlcode"><pre><span class="nx">git</span><span class="na">-main</span><span class="o">/</span> <span class="p">(</span><span class="nx">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="nb">add</span> <span class="nx">git</span><span class="na">-sub</span>

<span class="nx">git</span><span class="na">-main</span><span class="o">/</span> <span class="p">(</span><span class="nx">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="nx">gst</span>
<span class="k">On</span> <span class="nx">branch</span> <span class="nx">master</span>
<span class="nx">Your</span> <span class="nx">branch</span> <span class="nx">is</span> <span class="nb">up</span><span class="na">-to-date</span> <span class="k">with</span> <span class="s1">&#39;origin/master&#39;</span><span class="nx">.</span>
<span class="nx">Changes</span> <span class="k">to</span> <span class="nx">be</span> <span class="nx">committed</span><span class="p">:</span>
  <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git reset HEAD &lt;file&gt;...&quot;</span> <span class="k">to</span> <span class="nx">unstage</span><span class="p">)</span>

        <span class="nb">new</span> <span class="nb">file</span><span class="p">:</span>   <span class="nx">git</span><span class="na">-sub</span>

<span class="nx">git</span><span class="na">-main</span><span class="o">/</span> <span class="p">(</span><span class="nx">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="nx">ci</span> <span class="na">-m</span> <span class="s1">&#39;import git-sub&#39;</span>
<span class="err">[</span><span class="nx">master</span> <span class="mi">36</span><span class="nx">c4d6e</span><span class="cp">]</span> import git-sub
 1 file changed, 1 insertion(+)
 create mode 160000 git-sub

git-main/ (master) $ git ls-tree HEAD
160000 commit 1efb773d1740a7ad66e5b53bdf66f10c66440ce5  git-sub
100644 blob ce013625030ba8dba906f756967f9e9ca394464a    hello.txt
</pre></div>


<p>这里git-sub子目录是commit类型, 模式码是160000. 这是一个gitlink对象.</p>
<p>注意: 通常情况下, <code>git add /path/to</code> 和 <code>git add /path/to/</code>(有无斜线结束符)是一样的. 但是在这里创建gitlink时, 两者是不一样的, 如果加了斜线结束符, 则不是创建gitlink, 而是把子目录下的所有文件都添加进来.</p>
<div class="hlcode"><pre><span class="nx">git</span><span class="na">-main</span><span class="o">/</span> <span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">cp</span> <span class="na">-r</span> <span class="nx">git</span><span class="na">-sub</span> <span class="nx">git</span><span class="na">-non-sub</span>

<span class="nx">git</span><span class="na">-main</span><span class="o">/</span> <span class="p">(</span><span class="nx">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="nb">add</span> <span class="nx">git</span><span class="na">-non-sub</span><span class="o">/</span>

<span class="nx">git</span><span class="na">-main</span><span class="o">/</span> <span class="p">(</span><span class="nx">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="nx">gst</span>
<span class="k">On</span> <span class="nx">branch</span> <span class="nx">master</span>
<span class="nx">Your</span> <span class="nx">branch</span> <span class="nx">is</span> <span class="nx">ahead</span> <span class="nx">of</span> <span class="s1">&#39;origin/master&#39;</span> <span class="k">by</span> <span class="mi">1</span> <span class="nx">commit.</span>
  <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git push&quot;</span> <span class="k">to</span> <span class="nx">publish</span> <span class="nx">your</span> <span class="kd">local</span> <span class="nx">commits</span><span class="p">)</span>
<span class="nx">Changes</span> <span class="k">to</span> <span class="nx">be</span> <span class="nx">committed</span><span class="p">:</span>
  <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git reset HEAD &lt;file&gt;...&quot;</span> <span class="k">to</span> <span class="nx">unstage</span><span class="p">)</span>

        <span class="nb">new</span> <span class="nb">file</span><span class="p">:</span>   <span class="nx">git</span><span class="na">-non-sub</span><span class="p">/</span><span class="nx">sub.txt</span>

<span class="nx">git</span><span class="na">-main</span><span class="o">/</span> <span class="p">(</span><span class="nx">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="nx">ci</span> <span class="na">-m</span> <span class="s1">&#39;import git-non-sub&#39;</span>
<span class="err">[</span><span class="nx">master</span> <span class="mi">249</span><span class="nx">c085</span><span class="cp">]</span> import git-non-sub
 1 file changed, 1 insertion(+)
 create mode 100644 git-non-sub/sub.txt

git-main/ (master) $ git ls-tree HEAD
040000 tree 04756934bd18bee46b7978441ff47dfd695e6344    git-non-sub
160000 commit 1efb773d1740a7ad66e5b53bdf66f10c66440ce5  git-sub
100644 blob ce013625030ba8dba906f756967f9e9ca394464a    hello.txt
</pre></div>


<p>这里git-non-sub就是一个普通的树对象.</p>
<p>git 将 gitlink当做一个简单的指针值或者其它版本库的引用. 绝大部分git操作(如clone)不会对gitlink解引用, 并作用在子模块版本库上.</p>
<div class="hlcode"><pre><span class="n">git</span><span class="o">-</span><span class="n">main</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">tree</span>
<span class="p">.</span>
<span class="err">├──</span> <span class="n">git</span><span class="o">-</span><span class="n">non</span><span class="o">-</span><span class="n">sub</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="n">sub</span><span class="p">.</span><span class="n">txt</span>
<span class="err">├──</span> <span class="n">git</span><span class="o">-</span><span class="n">sub</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="n">sub</span><span class="p">.</span><span class="n">txt</span>
<span class="err">└──</span> <span class="n">hello</span><span class="p">.</span><span class="n">txt</span>

<span class="mi">2</span> <span class="n">directories</span><span class="p">,</span> <span class="mi">3</span> <span class="n">files</span>

<span class="n">git</span><span class="o">-</span><span class="n">main</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">cd</span> <span class="p">..</span>
 <span class="err">$</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">git</span><span class="o">-</span><span class="n">main</span> <span class="n">git</span><span class="o">-</span><span class="n">main2</span>
<span class="n">Cloning</span> <span class="n">into</span> <span class="err">&#39;</span><span class="n">git</span><span class="o">-</span><span class="n">main2</span><span class="err">&#39;</span><span class="p">...</span>
<span class="n">done</span><span class="p">.</span>
 <span class="err">$</span> <span class="n">cd</span> <span class="n">git</span><span class="o">-</span><span class="n">main2</span>

<span class="n">git</span><span class="o">-</span><span class="n">main2</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">tree</span>
<span class="p">.</span>
<span class="err">├──</span> <span class="n">git</span><span class="o">-</span><span class="n">non</span><span class="o">-</span><span class="n">sub</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="n">sub</span><span class="p">.</span><span class="n">txt</span>
<span class="err">├──</span> <span class="n">git</span><span class="o">-</span><span class="n">sub</span>
<span class="err">└──</span> <span class="n">hello</span><span class="p">.</span><span class="n">txt</span>

<span class="mi">2</span> <span class="n">directories</span><span class="p">,</span> <span class="mi">2</span> <span class="n">files</span>

<span class="n">git</span><span class="o">-</span><span class="n">main2</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">cd</span> <span class="n">git</span><span class="o">-</span><span class="n">sub</span>
<span class="n">git</span><span class="o">-</span><span class="n">main2</span><span class="o">/</span><span class="n">git</span><span class="o">-</span><span class="n">sub</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">remote</span> <span class="o">-</span><span class="n">v</span>
<span class="n">origin</span>  <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">TankyWoo</span><span class="o">/</span><span class="n">dev_env</span><span class="o">/</span><span class="n">git</span><span class="o">-</span><span class="n">submodule</span><span class="o">/</span><span class="n">git</span><span class="o">-</span><span class="n">main</span> <span class="p">(</span><span class="n">fetch</span><span class="p">)</span>
<span class="n">origin</span>  <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">TankyWoo</span><span class="o">/</span><span class="n">dev_env</span><span class="o">/</span><span class="n">git</span><span class="o">-</span><span class="n">submodule</span><span class="o">/</span><span class="n">git</span><span class="o">-</span><span class="n">main</span> <span class="p">(</span><span class="n">push</span><span class="p">)</span>
</pre></div>


<p>继续在克隆出来的git-main2上测试:</p>
<div class="hlcode"><pre><span class="n">git</span><span class="o">-</span><span class="n">main2</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">ls</span><span class="o">-</span><span class="n">files</span> <span class="o">--</span><span class="n">stage</span> <span class="o">--</span> <span class="n">git</span><span class="o">-</span><span class="n">sub</span>
<span class="mi">160000</span> <span class="mi">1</span><span class="n">efb773d1740a7ad66e5b53bdf66f10c66440ce5</span> <span class="mi">0</span>       <span class="n">git</span><span class="o">-</span><span class="n">sub</span>

<span class="n">git</span><span class="o">-</span><span class="n">main2</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">rmdir</span> <span class="n">git</span><span class="o">-</span><span class="n">sub</span>
<span class="n">git</span><span class="o">-</span><span class="n">main2</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="o">:</span><span class="c1">//git.example.com/tankywoo/git-sub.git git-sub</span>
<span class="n">Cloning</span> <span class="n">into</span> <span class="err">&#39;</span><span class="n">git</span><span class="o">-</span><span class="n">sub</span><span class="err">&#39;</span><span class="p">...</span>
<span class="n">Username</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//git.example.com&#39;: tankywoo</span>
<span class="n">Password</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//tankywoo@git.example.com&#39;:</span>
<span class="nl">remote:</span> <span class="n">Counting</span> <span class="n">objects</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">done</span><span class="p">.</span>
<span class="nl">remote:</span> <span class="n">Total</span> <span class="mi">3</span> <span class="p">(</span><span class="n">delta</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reused</span> <span class="mi">0</span> <span class="p">(</span><span class="n">delta</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">Unpacking</span> <span class="n">objects</span><span class="o">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span><span class="p">),</span> <span class="n">done</span><span class="p">.</span>
<span class="n">Checking</span> <span class="n">connectivity</span><span class="p">...</span> <span class="n">done</span><span class="p">.</span>

<span class="n">git</span><span class="o">-</span><span class="n">main2</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">cd</span> <span class="n">git</span><span class="o">-</span><span class="n">sub</span>
<span class="n">git</span><span class="o">-</span><span class="n">main2</span><span class="o">/</span><span class="n">git</span><span class="o">-</span><span class="n">sub</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">checkout</span> <span class="mi">1</span><span class="n">efb773</span>
<span class="nl">Note:</span> <span class="n">checking</span> <span class="n">out</span> <span class="err">&#39;</span><span class="mi">1</span><span class="n">efb773</span><span class="err">&#39;</span><span class="p">.</span>

<span class="n">You</span> <span class="n">are</span> <span class="n">in</span> <span class="err">&#39;</span><span class="n">detached</span> <span class="n">HEAD</span><span class="err">&#39;</span> <span class="n">state</span><span class="p">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">look</span> <span class="n">around</span><span class="p">,</span> <span class="n">make</span> <span class="n">experimental</span>
<span class="n">changes</span> <span class="n">and</span> <span class="n">commit</span> <span class="n">them</span><span class="p">,</span> <span class="n">and</span> <span class="n">you</span> <span class="n">can</span> <span class="n">discard</span> <span class="n">any</span> <span class="n">commits</span> <span class="n">you</span> <span class="n">make</span> <span class="n">in</span> <span class="n">this</span>
<span class="n">state</span> <span class="n">without</span> <span class="n">impacting</span> <span class="n">any</span> <span class="n">branches</span> <span class="n">by</span> <span class="n">performing</span> <span class="n">another</span> <span class="n">checkout</span><span class="p">.</span>

<span class="n">If</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">create</span> <span class="n">a</span> <span class="n">new</span> <span class="n">branch</span> <span class="n">to</span> <span class="n">retain</span> <span class="n">commits</span> <span class="n">you</span> <span class="n">create</span><span class="p">,</span> <span class="n">you</span> <span class="n">may</span>
<span class="k">do</span> <span class="n">so</span> <span class="p">(</span><span class="n">now</span> <span class="n">or</span> <span class="n">later</span><span class="p">)</span> <span class="n">by</span> <span class="n">using</span> <span class="o">-</span><span class="n">b</span> <span class="n">with</span> <span class="n">the</span> <span class="n">checkout</span> <span class="n">command</span> <span class="n">again</span><span class="p">.</span> <span class="n">Example</span><span class="o">:</span>

  <span class="n">git</span> <span class="n">checkout</span> <span class="o">-</span><span class="n">b</span> <span class="n">new_branch_name</span>

<span class="n">HEAD</span> <span class="n">is</span> <span class="n">now</span> <span class="n">at</span> <span class="mi">1</span><span class="n">efb773</span><span class="p">...</span> <span class="n">init</span> <span class="n">sub</span>
</pre></div>


<p>这个操作的原理和<code>git submodule update</code>类似, 只不过后者的实现更复杂一些.</p>
<div class="hlcode"><pre><span class="n">git</span><span class="o">-</span><span class="n">main2</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">submodule</span> <span class="n">update</span>
<span class="n">No</span> <span class="n">submodule</span> <span class="n">mapping</span> <span class="n">found</span> <span class="n">in</span> <span class="p">.</span><span class="n">gitmodules</span> <span class="k">for</span> <span class="n">path</span> <span class="err">&#39;</span><span class="n">git</span><span class="o">-</span><span class="n">sub</span><span class="err">&#39;</span>
</pre></div>


<p>git submodule 首先需要一个基本的配置文件: 放在主库根目录下的<code>.gitmodules</code>文件.</p>
<p>git submoduel 的前期操作 init 依赖这个 TODO</p>
<p>可以手动或通过<code>git submodule add</code>创建这个文件(有点类似git remote add). 不过这里因为之前已经作了gitlink了, 所以这里只能手动创建这个文件:</p>
<div class="hlcode"><pre><span class="n">git</span><span class="o">-</span><span class="n">main2</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="n">cat</span> <span class="p">.</span><span class="n">gitmodules</span>
<span class="p">[</span><span class="n">submodule</span> <span class="s">&quot;git-sub&quot;</span><span class="p">]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">git</span><span class="o">-</span><span class="n">sub</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">https</span><span class="o">:</span><span class="c1">//git.example.com/tankywoo/git-sub.git</span>
</pre></div>


<p>接下来执行<code>git submodule init</code>将.gitmodules文件中的配置复制到.git/config中:</p>
<div class="hlcode"><pre><span class="n">git</span><span class="o">-</span><span class="n">main2</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">submodule</span> <span class="n">init</span>
<span class="n">Submodule</span> <span class="err">&#39;</span><span class="n">git</span><span class="o">-</span><span class="n">sub</span><span class="err">&#39;</span> <span class="p">(</span><span class="n">https</span><span class="o">:</span><span class="c1">//git.example.com/tankywoo/git-sub.git) registered for path &#39;git-sub&#39;</span>
<span class="n">git</span><span class="o">-</span><span class="n">main2</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="n">cat</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">config</span>
<span class="p">[</span><span class="n">core</span><span class="p">]</span>
        <span class="n">repositoryformatversion</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">filemode</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">bare</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="n">logallrefupdates</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">ignorecase</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">precomposeunicode</span> <span class="o">=</span> <span class="nb">true</span>
<span class="p">[</span><span class="n">remote</span> <span class="s">&quot;origin&quot;</span><span class="p">]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">TankyWoo</span><span class="o">/</span><span class="n">dev_env</span><span class="o">/</span><span class="n">git</span><span class="o">-</span><span class="n">submodule</span><span class="o">/</span><span class="n">git</span><span class="o">-</span><span class="n">main</span>
        <span class="n">fetch</span> <span class="o">=</span> <span class="o">+</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/*:</span><span class="n">refs</span><span class="o">/</span><span class="n">remotes</span><span class="o">/</span><span class="n">origin</span><span class="o">/*</span>
<span class="p">[</span><span class="n">branch</span> <span class="s">&quot;master&quot;</span><span class="p">]</span>
        <span class="n">remote</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="n">merge</span> <span class="o">=</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
<span class="p">[</span><span class="n">submodule</span> <span class="s">&quot;git-sub&quot;</span><span class="p">]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">https</span><span class="o">:</span><span class="c1">//git.example.com/tankywoo/git-sub.git</span>
</pre></div>


<p>回到git-main, 提交.gitmodules, 在git-sub目录增加一个提交:</p>
<div class="hlcode"><pre><span class="nx">git</span><span class="na">-main</span><span class="p">/</span><span class="nx">git</span><span class="na">-sub</span><span class="o">/</span> <span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">echo</span> <span class="s1">&#39;new line&#39;</span> <span class="o">&gt;&gt;</span> <span class="nx">sub.txt</span>
<span class="nx">git</span><span class="na">-main</span><span class="p">/</span><span class="nx">git</span><span class="na">-sub</span><span class="o">/</span> <span class="p">(</span><span class="nx">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="nx">ci</span> <span class="na">-m</span> <span class="s1">&#39;add new line to sub.txt&#39;</span> <span class="nx">sub.txt</span>
<span class="err">[</span><span class="nx">master</span> <span class="mi">4102106</span><span class="cp">]</span> add new line to sub.txt
 1 file changed, 1 insertion(+)

git-main/git-sub/ (master) $ cd ..
git-main/ (master*) $ gst
On branch master
Your branch is up-to-date with &#39;origin/master&#39;.
Changes not staged for commit:
  (use &quot;git add <span class="nt">&lt;file&gt;</span>...&quot; to update what will be committed)
  (use &quot;git checkout -- <span class="nt">&lt;file&gt;</span>...&quot; to discard changes in working directory)

        modified:   git-sub (new commits)

no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)

git-main/ (master*) $ git submodule update
Submodule path &#39;git-sub&#39;: checked out &#39;1efb773d1740a7ad66e5b53bdf66f10c66440ce5&#39;
</pre></div>


<p>因为子模块针对主库都是一个指针, 指向子模块的某一个版本.</p>
<p>所以执行git submodule update时, 会更新到指定的版本. 这里是检出之前的一个版本, 这时可以把git-sub更新到新提交.</p>
<div class="hlcode"><pre><span class="n">git</span><span class="o">-</span><span class="n">main</span><span class="o">/</span><span class="n">git</span><span class="o">-</span><span class="n">sub</span><span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="n">efb773</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">checkout</span> <span class="n">master</span>
<span class="n">Previous</span> <span class="n">HEAD</span> <span class="n">position</span> <span class="n">was</span> <span class="mi">1</span><span class="n">efb773</span><span class="p">...</span> <span class="n">init</span> <span class="n">sub</span>
<span class="n">Switched</span> <span class="n">to</span> <span class="n">branch</span> <span class="err">&#39;</span><span class="n">master</span><span class="err">&#39;</span>
<span class="n">Your</span> <span class="n">branch</span> <span class="n">is</span> <span class="n">up</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">date</span> <span class="n">with</span> <span class="err">&#39;</span><span class="n">origin</span><span class="o">/</span><span class="n">master</span><span class="err">&#39;</span><span class="p">.</span>

<span class="n">git</span><span class="o">-</span><span class="n">main</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="n">gst</span>
<span class="n">On</span> <span class="n">branch</span> <span class="n">master</span>
<span class="n">Your</span> <span class="n">branch</span> <span class="n">is</span> <span class="n">up</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">date</span> <span class="n">with</span> <span class="err">&#39;</span><span class="n">origin</span><span class="o">/</span><span class="n">master</span><span class="err">&#39;</span><span class="p">.</span>
<span class="n">Changes</span> <span class="n">to</span> <span class="n">be</span> <span class="n">committed</span><span class="o">:</span>
  <span class="p">(</span><span class="n">use</span> <span class="s">&quot;git reset HEAD &lt;file&gt;...&quot;</span> <span class="n">to</span> <span class="n">unstage</span><span class="p">)</span>

        <span class="nl">modified:</span>   <span class="n">git</span><span class="o">-</span><span class="n">sub</span>

<span class="n">git</span><span class="o">-</span><span class="n">main</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">ci</span> <span class="o">-</span><span class="n">m</span> <span class="err">&#39;</span><span class="n">update</span> <span class="n">git</span><span class="o">-</span><span class="n">sub</span><span class="err">&#39;</span>
<span class="p">[</span><span class="n">master</span> <span class="n">d052863</span><span class="p">]</span> <span class="n">update</span> <span class="n">git</span><span class="o">-</span><span class="n">sub</span>
 <span class="mi">1</span> <span class="n">file</span> <span class="n">changed</span><span class="p">,</span> <span class="mi">1</span> <span class="n">insertion</span><span class="p">(</span><span class="o">+</span><span class="p">),</span> <span class="mi">1</span> <span class="n">deletion</span><span class="p">(</span><span class="o">-</span><span class="p">)</span>
</pre></div>


<p>可以看到, git-sub在主库的对象就是一个指针:</p>
<div class="hlcode"><pre><span class="n">git</span><span class="o">-</span><span class="n">main</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">ls</span><span class="o">-</span><span class="n">tree</span> <span class="n">HEAD</span>
<span class="mi">100644</span> <span class="n">blob</span> <span class="mi">9</span><span class="n">c7efd6f991c84837049b6ce41233281b54b12a6</span>    <span class="p">.</span><span class="n">gitmodules</span>
<span class="mo">040000</span> <span class="n">tree</span> <span class="mo">04756</span><span class="mi">934</span><span class="n">bd18bee46b7978441ff47dfd695e6344</span>    <span class="n">git</span><span class="o">-</span><span class="n">non</span><span class="o">-</span><span class="n">sub</span>
<span class="mi">160000</span> <span class="n">commit</span> <span class="mi">4102106</span><span class="n">db336adbf5d0ad572b64b379ab5098abc</span>  <span class="n">git</span><span class="o">-</span><span class="n">sub</span>
<span class="mi">100644</span> <span class="n">blob</span> <span class="n">ce013625030ba8dba906f756967f9e9ca394464a</span>    <span class="n">hello</span><span class="p">.</span><span class="n">txt</span>

<span class="n">git</span><span class="o">-</span><span class="n">main</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">cd</span> <span class="n">git</span><span class="o">-</span><span class="n">sub</span>
<span class="n">git</span><span class="o">-</span><span class="n">main</span><span class="o">/</span><span class="n">git</span><span class="o">-</span><span class="n">sub</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">rev</span><span class="o">-</span><span class="n">parse</span> <span class="n">master</span>
<span class="mi">4102106</span><span class="n">db336adbf5d0ad572b64b379ab5098abc</span>
</pre></div>


<p>解引用子模块:</p>
<div class="hlcode"><pre><span class="n">git</span><span class="o">-</span><span class="n">main</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">submodule</span> <span class="n">deinit</span> <span class="n">git</span><span class="o">-</span><span class="n">sub</span>
<span class="n">Cleared</span> <span class="n">directory</span> <span class="err">&#39;</span><span class="n">git</span><span class="o">-</span><span class="n">sub</span><span class="err">&#39;</span>
<span class="n">Submodule</span> <span class="err">&#39;</span><span class="n">git</span><span class="o">-</span><span class="n">sub</span><span class="err">&#39;</span> <span class="p">(</span><span class="n">https</span><span class="o">:</span><span class="c1">//git.example.com/tankywoo/git-sub.git) unregistered for path &#39;git-sub&#39;</span>
<span class="n">git</span><span class="o">-</span><span class="n">main</span><span class="o">/</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">more</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">config</span>
<span class="p">[</span><span class="n">core</span><span class="p">]</span>
        <span class="n">repositoryformatversion</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">filemode</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">bare</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="n">logallrefupdates</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">ignorecase</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">precomposeunicode</span> <span class="o">=</span> <span class="nb">true</span>
<span class="p">[</span><span class="n">remote</span> <span class="s">&quot;origin&quot;</span><span class="p">]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">https</span><span class="o">:</span><span class="c1">//git.example.com/tankywoo/git-main.git</span>
        <span class="n">fetch</span> <span class="o">=</span> <span class="o">+</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/*:</span><span class="n">refs</span><span class="o">/</span><span class="n">remotes</span><span class="o">/</span><span class="n">origin</span><span class="o">/*</span>
<span class="p">[</span><span class="n">branch</span> <span class="s">&quot;master&quot;</span><span class="p">]</span>
        <span class="n">remote</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="n">merge</span> <span class="o">=</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
</pre></div>


<p><code>git submodule status</code>和 git status类似, 可以查看所有子模块的引用sha-1 id和脏状态</p>
<p>之前提到, git submodle init会把.gitmodules的配置加到.git/config下, 关于这两个文件中针对子模块的配置:</p>
<div class="hlcode"><pre><span class="cp"># .gitmodules</span>
<span class="p">[</span><span class="n">submodule</span> <span class="s">&quot;git-sub&quot;</span><span class="p">]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">git</span><span class="o">-</span><span class="n">sub</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">https</span><span class="o">:</span><span class="c1">//git.example.com/tankywoo/git-sub.git</span>

<span class="cp"># .git/config</span>
<span class="p">[</span><span class="n">submodule</span> <span class="s">&quot;git-sub&quot;</span><span class="p">]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">https</span><span class="o">:</span><span class="c1">//git.example.com/tankywoo/git-sub.git</span>
</pre></div>


<p>TODO: 个人理解是这两个文件互相配合, 针对子模块的路径, 是由.gitmodules控制, 因为这个在.git/config中没有, 关于执行git submodule update的路径, 是由.git/config中的url控制.<br />
另外, 子模块的配置在 <code>.git/modules/&lt;module-name&gt;/config</code>中, 和.git/config类似, 那么这里的作用又是?</p>
<p>TODO:</p>
<ul>
<li>git pull -s subtree 导入子项目</li>
<li>git subtree vs git submodule 前者在去年就听过了, 一直没试过.</li>
</ul>
<h2 id="17">17. 子模块最佳实践(略)</h2>
<h2 id="18-svngit">18. 结合SVN版本库使用Git(略)</h2>
<h2 id="19">19. 高级操作</h2>
<p><code>git filter-branch</code> 是一个通用的分支操作命令, 可以通过自定义命令来利用它操作不同的git对象, 从而重写分支上的提交.</p>
<p>filter-branch命令会在版本库中的一个或多个分支执行一系列过滤器, 每个过滤器可以搭配一条自定义过滤器命令.</p>
<p>和<code>rebase</code>, <code>reset</code>等类似, 改写历史的操作总是危险的, 所以最好不要在公共分支操作.</p>
<p>另外, filter-branch完成后, 原先包含旧提交历史的引用会存在 <code>refs/original/</code>目录下, <code>refs/heads/</code> 存的是新的历史.</p>
<p>在操作filter-branch之前, 要保证<code>refs/original/</code>目录是空的.</p>
<p>如果确认新的历史OK后, 并确认旧的历史不在使用, 则可以删掉.git/refs/original(直接rm或<code>git update-ref -d refs/original/&lt;branch&gt;</code>)</p>
<p>如果不删除此目录, 则在版本库中拥有新旧两套历史记录, 旧的历史会阻止垃圾回收(gc).</p>
<p>如果不想显示删除此目录, 可以克隆一个新的版本库, 旧的历史存在旧的版本库作备份.</p>
<p>关于filter-branch, 最佳实践是先克隆一个心版本库, 然后再执行过滤操作. 个人感觉这个操作的破坏性比rebase等还要强, 很容易导致整个历史脱离自己的预计, 这应该也是它专门提供一个original引用的原因.</p>
<p>例子:</p>
<p>在整个历史中删除某个文件. 一般而言某个文件可能不再用了, 也可能包含了敏感的信息, 需要删除这个文件, 如果只是简单的<code>git rm</code>, 只会在当前版本中删除, 但是在历史版本还是可以检出这个文件.</p>
<p>使用<code>--tree-filter</code>可以实现这个功能:</p>
<div class="hlcode"><pre><span class="err">#</span> <span class="mi">4</span><span class="err">个</span><span class="nx">commit</span><span class="p">,</span> <span class="err">其中</span> <span class="nx">e7fc148</span> <span class="err">引入</span><span class="nx">hello</span><span class="err">这个空文件</span>
<span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="k">log</span> <span class="o">--</span><span class="nx">oneline</span>
<span class="mi">20124</span><span class="nx">f8</span> <span class="nb">add</span> <span class="nx">hello</span> <span class="nx">git</span> <span class="k">to</span> <span class="nx">git.txt</span>
<span class="nx">e7fc148</span> <span class="nb">add</span> <span class="nx">hello</span> <span class="nx">world</span> <span class="k">to</span> <span class="nx">world.txt</span> <span class="o">&lt;</span><span class="nx">v0.1</span><span class="o">&gt;</span>  <span class="err">#</span> <span class="err">在这块打了一个</span><span class="kt">tag</span> <span class="nx">v0.1</span>
<span class="mi">5406</span><span class="nx">b57</span> <span class="nb">add</span> <span class="nx">hello</span>
<span class="nx">f1b0b42</span> <span class="nb">first</span> <span class="nx">commit</span>

<span class="err">#</span> <span class="err">使用</span><span class="o">--</span><span class="nx">tree</span><span class="na">-filter</span><span class="err">可以看到每个版本的文件有哪些</span>
<span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="nx">filter</span><span class="na">-branch</span> <span class="o">--</span><span class="nx">tree</span><span class="na">-filter</span> <span class="s1">&#39;ls&#39;</span> <span class="nx">master</span>
<span class="nx">Rewrite</span> <span class="nx">f1b0b42d0590f35f290e1c47b6e0fc12ed11267c</span> <span class="p">(</span><span class="mi">1</span><span class="p">/</span><span class="nx">4</span><span class="p">)</span><span class="nx">t.sh</span>
<span class="nx">Rewrite</span> <span class="mi">5406</span><span class="nx">b570273078b2193fc7b890f20a56b2e697c8</span> <span class="p">(</span><span class="mi">2</span><span class="p">/</span><span class="nx">4</span><span class="p">)</span><span class="nx">hello</span>    <span class="nx">t.sh</span>
<span class="nx">Rewrite</span> <span class="nx">e7fc1486aea71618c719800e8fbe4fd58ffc29e9</span> <span class="p">(</span><span class="mi">3</span><span class="p">/</span><span class="nx">4</span><span class="p">)</span><span class="nx">hello</span>    <span class="nx">t.sh</span>   <span class="nx">world.txt</span>
<span class="nx">Rewrite</span> <span class="mi">20124</span><span class="nx">f85c45e360dff4d05b5e9eb4f73132f066b</span> <span class="p">(</span><span class="mi">4</span><span class="p">/</span><span class="nx">4</span><span class="p">)</span><span class="nx">git.txt</span>  <span class="nx">hello</span>  <span class="nx">t.sh</span>    <span class="nx">world.txt</span>

<span class="nx">WARNING</span><span class="p">:</span> <span class="nx">Ref</span> <span class="s1">&#39;refs/heads/master&#39;</span> <span class="nx">is</span> <span class="nx">unchanged</span>

<span class="err">#</span> <span class="err">使用</span><span class="o">--</span><span class="nx">tree</span><span class="na">-filter</span><span class="err">删除</span><span class="nx">hello</span><span class="err">这个文件</span>
<span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="nx">filter</span><span class="na">-branch</span> <span class="o">--</span><span class="nx">tree</span><span class="na">-filter</span> <span class="s1">&#39;rm -f hello&#39;</span> <span class="nx">master</span>
<span class="nx">Rewrite</span> <span class="mi">20124</span><span class="nx">f85c45e360dff4d05b5e9eb4f73132f066b</span> <span class="p">(</span><span class="mi">4</span><span class="p">/</span><span class="nx">4</span><span class="p">)</span>
<span class="nx">Ref</span> <span class="s1">&#39;refs/heads/master&#39;</span> <span class="nx">was</span> <span class="nx">rewritten</span>

<span class="err">#</span> <span class="err">再次查看</span><span class="p">,</span> <span class="err">从第</span><span class="mi">2</span><span class="err">个</span><span class="nx">commit</span><span class="err">开始</span><span class="nx">sha</span><span class="o">-</span><span class="mi">1</span><span class="err">值都变了</span>
<span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="k">log</span> <span class="o">--</span><span class="nx">oneline</span>
<span class="mi">891</span><span class="nx">b0ec</span> <span class="nb">add</span> <span class="nx">hello</span> <span class="nx">git</span> <span class="k">to</span> <span class="nx">git.txt</span>
<span class="mi">4</span><span class="nx">fca41c</span> <span class="nb">add</span> <span class="nx">hello</span> <span class="nx">world</span> <span class="k">to</span> <span class="nx">world.txt</span>
<span class="nx">cc1cc50</span> <span class="nb">add</span> <span class="nx">hello</span>
<span class="nx">f1b0b42</span> <span class="nb">first</span> <span class="nx">commit</span>

<span class="err">#</span> <span class="err">当前工作目录下</span><span class="p">,</span> <span class="nx">hello</span><span class="err">这个文件没了</span>
<span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">ls</span>
<span class="nx">git.txt</span>   <span class="nx">t.sh</span>   <span class="nx">world.txt</span>

<span class="err">#</span> <span class="err">再次尝试查看每个版本有哪些文件</span>
<span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="nx">filter</span><span class="na">-branch</span> <span class="o">--</span><span class="nx">tree</span><span class="na">-filter</span> <span class="s1">&#39;ls&#39;</span> <span class="nx">master</span>
<span class="nx">Cannot</span> <span class="nb">create</span> <span class="nx">a</span> <span class="nb">new</span> <span class="nx">backup.</span>
<span class="nx">A</span> <span class="nx">previous</span> <span class="nx">backup</span> <span class="nx">already</span> <span class="n">exists</span> <span class="k">in</span> <span class="nx">refs</span><span class="p">/</span><span class="nx">original</span><span class="o">/</span>
<span class="nx">Force</span> <span class="nx">overwriting</span> <span class="nx">the</span> <span class="nx">backup</span> <span class="k">with</span> <span class="na">-f</span>

<span class="err">#</span> <span class="err">多了一个</span><span class="nx">refs</span><span class="p">/</span><span class="nx">original</span><span class="o">/</span>
<span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">tree</span> <span class="bp">.</span><span class="nx">git</span><span class="p">/</span><span class="nx">refs</span>
<span class="bp">.</span><span class="nx">git</span><span class="p">/</span><span class="nx">refs</span>
<span class="err">├──</span> <span class="nx">heads</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="nx">master</span>
<span class="err">├──</span> <span class="nx">original</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="nx">refs</span>
<span class="err">│  </span>     <span class="err">└──</span> <span class="nx">heads</span>
<span class="err">│  </span>         <span class="err">└──</span> <span class="nx">master</span>
<span class="err">├──</span> <span class="nx">remotes</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="nx">origin</span>
<span class="err">│  </span>     <span class="err">└──</span> <span class="nb">HEAD</span>
<span class="err">└──</span> <span class="nb">tags</span>

<span class="mi">7</span> <span class="nx">directories</span><span class="p">,</span> <span class="mi">3</span> <span class="nx">files</span>

<span class="err">#</span> <span class="err">存的老的</span><span class="nx">master</span> <span class="nb">head</span>
<span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">more</span> <span class="bp">.</span><span class="nx">git</span><span class="p">/</span><span class="nx">refs</span><span class="p">/</span><span class="nx">original</span><span class="p">/</span><span class="nx">refs</span><span class="p">/</span><span class="nx">heads</span><span class="p">/</span><span class="nx">master</span>
<span class="mi">20124</span><span class="nx">f85c45e360dff4d05b5e9eb4f73132f066b</span>

<span class="err">#</span> <span class="err">存的新的</span><span class="nx">master</span> <span class="nb">head</span>
<span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">more</span> <span class="bp">.</span><span class="nx">git</span><span class="p">/</span><span class="nx">refs</span><span class="p">/</span><span class="nx">heads</span><span class="p">/</span><span class="nx">master</span>
<span class="mi">891</span><span class="nx">b0ece810d9d8dcbc34e8f023fb5713e6e4b32</span>

<span class="err">#</span> <span class="err">如果把</span> <span class="bp">.</span><span class="nx">git</span><span class="p">/</span><span class="nx">refs</span><span class="p">/</span><span class="nx">heads</span><span class="p">/</span><span class="nx">master</span><span class="err">改为老的</span><span class="nx">sha</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="err">这时就还是原来的历史了</span>
<span class="p">(</span><span class="nx">master</span><span class="o">*</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="nb">status</span>
<span class="k">On</span> <span class="nx">branch</span> <span class="nx">master</span>
<span class="nx">Your</span> <span class="nx">branch</span> <span class="nx">is</span> <span class="nx">ahead</span> <span class="nx">of</span> <span class="s1">&#39;origin/master&#39;</span> <span class="k">by</span> <span class="mi">2</span> <span class="nx">commits.</span>
  <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git push&quot;</span> <span class="k">to</span> <span class="nx">publish</span> <span class="nx">your</span> <span class="kd">local</span> <span class="nx">commits</span><span class="p">)</span>
<span class="nx">Changes</span> <span class="k">to</span> <span class="nx">be</span> <span class="nx">committed</span><span class="p">:</span>
  <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git reset HEAD &lt;file&gt;...&quot;</span> <span class="k">to</span> <span class="nx">unstage</span><span class="p">)</span>
        <span class="nx">deleted</span><span class="p">:</span>    <span class="nx">hello</span>


<span class="err">#</span> <span class="err">删除旧的引用</span>
<span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="nx">update</span><span class="na">-ref</span> <span class="na">-d</span> <span class="nx">refs</span><span class="p">/</span><span class="nx">original</span><span class="p">/</span><span class="nx">refs</span><span class="p">/</span><span class="nx">heads</span><span class="p">/</span><span class="nx">master</span>
<span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">tree</span> <span class="bp">.</span><span class="nx">git</span><span class="p">/</span><span class="nx">refs</span>
<span class="bp">.</span><span class="nx">git</span><span class="p">/</span><span class="nx">refs</span>
<span class="err">├──</span> <span class="nx">heads</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="nx">master</span>
<span class="err">├──</span> <span class="nx">original</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="nx">refs</span>
<span class="err">│  </span>     <span class="err">└──</span> <span class="nx">heads</span>
<span class="err">├──</span> <span class="nx">remotes</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="nx">origin</span>
<span class="err">│  </span>     <span class="err">└──</span> <span class="nb">HEAD</span>
<span class="err">└──</span> <span class="nb">tags</span>

<span class="mi">7</span> <span class="nx">directories</span><span class="p">,</span> <span class="mi">2</span> <span class="nx">files</span>

<span class="err">#</span> <span class="err">此时可以查看每个版本的文件了</span>
<span class="p">(</span><span class="nx">master</span><span class="p">)</span> <span class="err">$</span> <span class="nx">git</span> <span class="nx">filter</span><span class="na">-branch</span> <span class="o">--</span><span class="nx">tree</span><span class="na">-filter</span> <span class="s1">&#39;ls&#39;</span> <span class="nx">master</span>
<span class="nx">Rewrite</span> <span class="nx">f1b0b42d0590f35f290e1c47b6e0fc12ed11267c</span> <span class="p">(</span><span class="mi">1</span><span class="p">/</span><span class="nx">4</span><span class="p">)</span><span class="nx">t.sh</span>
<span class="nx">Rewrite</span> <span class="nx">cc1cc501bd669ff44814ecd384f2dab7fc846cd9</span> <span class="p">(</span><span class="mi">2</span><span class="p">/</span><span class="nx">4</span><span class="p">)</span><span class="nx">t.sh</span>
<span class="nx">Rewrite</span> <span class="mi">4</span><span class="nx">fca41c1d1237963cb62f639dac6b82e9bf2de04</span> <span class="p">(</span><span class="mi">3</span><span class="p">/</span><span class="nx">4</span><span class="p">)</span><span class="nx">t.sh</span>     <span class="nx">world.txt</span>
<span class="nx">Rewrite</span> <span class="mi">891</span><span class="nx">b0ece810d9d8dcbc34e8f023fb5713e6e4b32</span> <span class="p">(</span><span class="mi">4</span><span class="p">/</span><span class="nx">4</span><span class="p">)</span><span class="nx">git.txt</span>  <span class="nx">t.sh</span>    <span class="nx">world.txt</span>

<span class="nx">WARNING</span><span class="p">:</span> <span class="nx">Ref</span> <span class="s1">&#39;refs/heads/master&#39;</span> <span class="nx">is</span> <span class="nx">unchanged</span>
</pre></div>


<p>不过这里有个问题, tag标签没有转过来:</p>
<div class="hlcode"><pre><span class="cp"># 但是之前打的tag v0.1 还是指向老的commit</span>
<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">rev</span><span class="o">-</span><span class="n">parse</span> <span class="n">v0</span><span class="mf">.1</span>
<span class="n">e7fc1486aea71618c719800e8fbe4fd58ffc29e9</span>
</pre></div>


<p>在--tree-filter可以配合--tag-name-filter:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">filter</span><span class="o">-</span><span class="n">branch</span> <span class="o">--</span><span class="n">tree</span><span class="o">-</span><span class="n">filter</span> <span class="err">&#39;</span><span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="n">hello</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">tag</span><span class="o">-</span><span class="n">name</span><span class="o">-</span><span class="n">filter</span> <span class="n">cat</span>  <span class="n">master</span>
<span class="n">Rewrite</span> <span class="mf">20124f</span><span class="mi">85</span><span class="n">c45e360dff4d05b5e9eb4f73132f066b</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Ref</span> <span class="err">&#39;</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span><span class="err">&#39;</span> <span class="n">was</span> <span class="n">rewritten</span>
<span class="n">v0</span><span class="mf">.1</span> <span class="o">-&gt;</span> <span class="n">v0</span><span class="mf">.1</span> <span class="p">(</span><span class="n">e7fc1486aea71618c719800e8fbe4fd58ffc29e9</span> <span class="o">-&gt;</span> <span class="mf">4f</span><span class="n">ca41c1d1237963cb62f639dac6b82e9bf2de04</span><span class="p">)</span>
</pre></div>


<p>另外, 如果某个文件改名过, 则上面的情况会漏掉改名前的版本, 可以通过之前提到过的<code>--follow</code>找到:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">name</span><span class="o">-</span><span class="n">only</span> <span class="o">--</span><span class="n">follow</span> <span class="o">--</span><span class="n">all</span> <span class="o">--</span> <span class="n">file</span>
</pre></div>


<p>接着上面的例子, 使用<code>--msg-filter</code>把commit message的hello改为nothing, 当然这里会把最后三条都改掉, 仅仅当一个例子来使用, 正常情况下应该只改第2条, 用rebase合适些.</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">filter</span><span class="o">-</span><span class="n">branch</span> <span class="o">--</span><span class="n">msg</span><span class="o">-</span><span class="n">filter</span> <span class="err">&#39;</span><span class="n">sed</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;s/hello/nothing/&quot;</span><span class="err">&#39;</span> <span class="n">master</span>
<span class="n">Rewrite</span> <span class="mi">891</span><span class="n">b0ece810d9d8dcbc34e8f023fb5713e6e4b32</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Ref</span> <span class="err">&#39;</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span><span class="err">&#39;</span> <span class="n">was</span> <span class="n">rewritten</span>

<span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="err">$</span> <span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">oneline</span>
<span class="n">f53bafc</span> <span class="n">add</span> <span class="n">nothing</span> <span class="n">git</span> <span class="n">to</span> <span class="n">git</span><span class="p">.</span><span class="n">txt</span>
<span class="n">e216bec</span> <span class="n">add</span> <span class="n">nothing</span> <span class="n">world</span> <span class="n">to</span> <span class="n">world</span><span class="p">.</span><span class="n">txt</span>
<span class="mf">47e5</span><span class="n">bce</span> <span class="n">add</span> <span class="n">nothing</span>
<span class="n">f1b0b42</span> <span class="n">first</span> <span class="n">commit</span>
</pre></div>


<p>如果filter-branch需要在所有分支上操作, 则在命令最后加上<code>--all</code></p>
<p>最后, 来一个以前用过的例子, 修改提交者的name和email, 有时会遇到这个情况, 可能个人的两个开发环境配置的name不一样, 导致提交会出现多个昵称, 这时可以统一下, github help已经给出了脚本, 用的就是filter-branch的env-filter, 文档链接 <a href="https://help.github.com/articles/changing-author-info/">Changing author info</a></p>
<table class="hlcodetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="hlcode"><pre><span class="c">#!/bin/sh</span>

git filter-branch --env-filter <span class="s1">&#39;</span>

<span class="s1">OLD_EMAIL=&quot;your-old-email@example.com&quot;</span>
<span class="s1">CORRECT_NAME=&quot;Your Correct Name&quot;</span>
<span class="s1">CORRECT_EMAIL=&quot;your-correct-email@example.com&quot;</span>

<span class="s1">if [ &quot;$GIT_COMMITTER_EMAIL&quot; = &quot;$OLD_EMAIL&quot; ]</span>
<span class="s1">then</span>
<span class="s1">    export GIT_COMMITTER_NAME=&quot;$CORRECT_NAME&quot;</span>
<span class="s1">    export GIT_COMMITTER_EMAIL=&quot;$CORRECT_EMAIL&quot;</span>
<span class="s1">fi</span>
<span class="s1">if [ &quot;$GIT_AUTHOR_EMAIL&quot; = &quot;$OLD_EMAIL&quot; ]</span>
<span class="s1">then</span>
<span class="s1">    export GIT_AUTHOR_NAME=&quot;$CORRECT_NAME&quot;</span>
<span class="s1">    export GIT_AUTHOR_EMAIL=&quot;$CORRECT_EMAIL&quot;</span>
<span class="s1">fi</span>
<span class="s1">&#39;</span> --tag-name-filter cat -- --branches --tags
</pre></div>
</td></tr></table>

<p>更多的filter可以man, 暂时也就跟着书折腾了这几个filter.</p>
<p><code>git rev-list</code> 和 git log 类似, 不过只输出sha-1 id. 并且两者的文档很多地方也是一样. 比如对输出范围的限制. 不过git log默认参数是HEAD, 而 rev-list必须指定commit id.</p>
<blockquote>
<p>git log takes options applicable to the <code>git rev-list</code> command to control what is shown and how, and options applicable to the <code>git diff-*</code> commands to control how the changes each commit introduces are shown.</p>
</blockquote>
<p>例子, 找出2015-01-01之前的提交:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">rev</span><span class="o">-</span><span class="n">list</span> <span class="o">--</span><span class="n">before</span><span class="o">=</span><span class="s">&quot;2015-01-01&quot;</span> <span class="n">master</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span>
     <span class="mi">266</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">rev</span><span class="o">-</span><span class="n">list</span> <span class="o">--</span><span class="n">before</span><span class="o">=</span><span class="s">&quot;2014-01-01&quot;</span> <span class="n">master</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span>
      <span class="mi">73</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">rev</span><span class="o">-</span><span class="n">list</span> <span class="o">-</span><span class="n">n</span> <span class="mi">3</span> <span class="o">--</span><span class="n">before</span><span class="o">=</span><span class="s">&quot;2014-01-01&quot;</span> <span class="n">master</span>
<span class="mf">78f19370f</span><span class="mi">4</span><span class="n">c67ca094565b9de6310917eaf85321</span>
<span class="mi">898309</span><span class="n">c61f5cea3ec2c52568ec8e0e4fed83a369</span>
<span class="n">e0332b5dc692d4404b33596ff1a61ee430c36264</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">show</span> <span class="mf">78f19370f</span><span class="mi">4</span><span class="n">c67ca094565b9de6310917eaf85321</span>
<span class="n">commit</span> <span class="mf">78f19370f</span><span class="mi">4</span><span class="n">c67ca094565b9de6310917eaf85321</span>
<span class="nl">Author:</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">wtq1990</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="nl">Date:</span>   <span class="n">Wed</span> <span class="n">Dec</span> <span class="mi">25</span> <span class="mi">16</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mi">12</span> <span class="mi">2013</span> <span class="o">+</span><span class="mi">0800</span>

    <span class="n">add</span> <span class="n">server</span> <span class="k">for</span> <span class="n">preview</span>

<span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">simiki</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">py</span> <span class="n">b</span><span class="o">/</span><span class="n">simiki</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">py</span>
<span class="p">...</span>
</pre></div>


<p>对于基于时间检出commit时, 需要注意:</p>
<p>根据限制的精度, 会影响输出结果. 如果缺乏精确时间, 则相对的是当前时刻. 如上传入的2015-01-01, 默认时间点是当前的点09:00:00; 如果要限制在晚上23点, 则应该传入 2015-01-01 23:00:00. 所以包括yesterday都是这样, 会依赖当前时刻.</p>
<p>和log一样, rev-list也可以限制路径:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">rev</span><span class="o">-</span><span class="n">list</span> <span class="n">master</span> <span class="o">--</span> <span class="n">setup</span><span class="p">.</span><span class="n">cfg</span>
<span class="mf">46ff</span><span class="mi">8</span><span class="n">a318b09c2d915bda22d9c5d93541e719680</span>
<span class="mi">70</span><span class="n">a7e9e7e55e3c125e2c81682ef21d03fe0a09fe</span>
</pre></div>


<p>输出限制某个commit的某个文件, 这个功能也挺给力, 语法 <code>commit:path</code></p>
<div class="hlcode"><pre><span class="cp"># 提交包含添加两个文件</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">show</span> <span class="o">--</span><span class="n">stat</span> <span class="n">HEAD</span>
<span class="n">commit</span> <span class="n">c10e81d7414e7ea8055e1c36eeb6d0bb58c46c11</span>
<span class="nl">Author:</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">wtq1990</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="nl">Date:</span>   <span class="n">Sun</span> <span class="n">Jun</span> <span class="mi">28</span> <span class="mi">09</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">34</span> <span class="mi">2015</span> <span class="o">+</span><span class="mi">0800</span>

    <span class="n">update</span> <span class="n">git</span><span class="p">.</span><span class="n">txt</span> <span class="n">and</span> <span class="n">world</span><span class="p">.</span><span class="n">txt</span>

 <span class="n">git</span><span class="p">.</span><span class="n">txt</span>   <span class="o">|</span> <span class="mi">1</span> <span class="o">+</span>
 <span class="n">world</span><span class="p">.</span><span class="n">txt</span> <span class="o">|</span> <span class="mi">2</span> <span class="o">+-</span>
 <span class="mi">2</span> <span class="n">files</span> <span class="n">changed</span><span class="p">,</span> <span class="mi">2</span> <span class="n">insertions</span><span class="p">(</span><span class="o">+</span><span class="p">),</span> <span class="mi">1</span> <span class="n">deletion</span><span class="p">(</span><span class="o">-</span><span class="p">)</span>

<span class="cp"># 只输出git.txt的内容</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">show</span> <span class="n">HEAD</span><span class="o">:</span><span class="n">git</span><span class="p">.</span><span class="n">txt</span>
<span class="n">hello</span> <span class="n">git</span>
<span class="n">hello</span> <span class="n">git</span><span class="p">.</span><span class="n">txt</span>
</pre></div>


<p>这里输出HEAD这个版本是, git.txt的内容. 书上说"需要该提交中确实包含了该文件", 这里说的有歧义, 应该说提交的tree blob有这个文件, 而不是这个提交中此文件必须有diff.</p>
<p>关于数据块的交互式暂存, 也就是<code>git add -p</code>和<code>git stash -p</code>等, 输出提示已经很详细了.</p>
<p><code>git fsck</code> (file system check)可以帮助找回丢失的数据. 一些操作(如reset, rebase)会使一些对象失去和其它对象的连接, 从而脱离版本库的完整数据结构.</p>
<p>这些对象叫做"不可及的"(unreachable) 或 "悬挂的"(dangling).</p>
<p>如:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">init</span>
<span class="n">Initialized</span> <span class="n">empty</span> <span class="n">Git</span> <span class="n">repository</span> <span class="n">in</span> <span class="o">/</span><span class="n">xxx</span><span class="o">/</span><span class="p">.</span><span class="n">git</span>

<span class="err">$</span> <span class="n">echo</span> <span class="err">&#39;</span><span class="n">foo</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">file</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">add</span> <span class="n">file</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">ci</span> <span class="o">-</span><span class="n">m</span> <span class="err">&#39;</span><span class="n">add</span> <span class="n">foo</span><span class="err">&#39;</span>
<span class="p">[</span><span class="n">master</span> <span class="p">(</span><span class="n">root</span><span class="o">-</span><span class="n">commit</span><span class="p">)</span> <span class="n">bfcce61</span><span class="p">]</span> <span class="n">add</span> <span class="n">foo</span>
 <span class="mi">1</span> <span class="n">file</span> <span class="n">changed</span><span class="p">,</span> <span class="mi">1</span> <span class="n">insertion</span><span class="p">(</span><span class="o">+</span><span class="p">)</span>
 <span class="n">create</span> <span class="n">mode</span> <span class="mi">100644</span> <span class="n">file</span>

<span class="err">$</span> <span class="n">echo</span> <span class="err">&#39;</span><span class="n">bar</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">file</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">ci</span> <span class="o">-</span><span class="n">m</span> <span class="err">&#39;</span><span class="n">add</span> <span class="n">bar</span><span class="err">&#39;</span> <span class="n">file</span>
<span class="p">[</span><span class="n">master</span> <span class="mi">39</span><span class="n">a6f59</span><span class="p">]</span> <span class="n">add</span> <span class="n">bar</span>
 <span class="mi">1</span> <span class="n">file</span> <span class="n">changed</span><span class="p">,</span> <span class="mi">1</span> <span class="n">insertion</span><span class="p">(</span><span class="o">+</span><span class="p">)</span>

<span class="err">$</span> <span class="n">tree</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">objects</span>
<span class="err">├──</span> <span class="mi">25</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="mi">7</span><span class="n">cc5642cb1a054f08cc83f2d943e56fd3ebe99</span>
<span class="err">├──</span> <span class="mi">39</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="n">a6f59fd5b646b57c42bd6928d7c36066842891</span>
<span class="err">├──</span> <span class="mi">3</span><span class="n">b</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="n">d1f0e29744a1f32b08d5650e62e2e62afb177c</span>
<span class="err">├──</span> <span class="mi">41</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="mf">31f</span><span class="n">e4d33cd85da805ac9a6697c2251c913881c</span>
<span class="err">├──</span> <span class="mi">4</span><span class="n">a</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="mi">1</span><span class="n">c03029e7407c0afe9fc0320b3258e188b115e</span>
<span class="err">├──</span> <span class="n">bf</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="n">cce61b0e90cb1cb385a9b1650c2a27bce30275</span>
<span class="err">├──</span> <span class="n">info</span>
<span class="err">└──</span> <span class="n">pack</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">cat</span><span class="o">-</span><span class="n">file</span> <span class="o">-</span><span class="n">p</span> <span class="mi">39</span><span class="n">a6f59fd5b646b57c42bd6928d7c36066842891</span>
<span class="n">tree</span> <span class="mf">4131f</span><span class="n">e4d33cd85da805ac9a6697c2251c913881c</span>
<span class="n">parent</span> <span class="n">bfcce61b0e90cb1cb385a9b1650c2a27bce30275</span>
<span class="n">author</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">wtq1990</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span> <span class="mi">1435458156</span> <span class="o">+</span><span class="mi">0800</span>
<span class="n">committer</span> <span class="n">Tanky</span> <span class="n">Woo</span> <span class="o">&lt;</span><span class="n">wtq1990</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span> <span class="mi">1435458156</span> <span class="o">+</span><span class="mi">0800</span>

<span class="n">add</span> <span class="n">bar</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="n">HEAD</span><span class="o">^</span>
<span class="n">HEAD</span> <span class="n">is</span> <span class="n">now</span> <span class="n">at</span> <span class="n">bfcce61</span> <span class="n">add</span> <span class="n">foo</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">fsck</span>
<span class="n">Checking</span> <span class="n">object</span> <span class="n">directories</span><span class="o">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">256</span><span class="o">/</span><span class="mi">256</span><span class="p">),</span> <span class="n">done</span><span class="p">.</span>

<span class="err">$</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">fsck</span>
<span class="n">Checking</span> <span class="n">object</span> <span class="n">directories</span><span class="o">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">256</span><span class="o">/</span><span class="mi">256</span><span class="p">),</span> <span class="n">done</span><span class="p">.</span>
<span class="n">dangling</span> <span class="n">commit</span> <span class="mi">39</span><span class="n">a6f59fd5b646b57c42bd6928d7c36066842891</span>
</pre></div>


<p>因为reflog会防止意外的丢失提前, 所以在上面未删除.git/logs时, fsck没有找到dangling对象.</p>
<h2 id="20">20. 提示、技巧和技术</h2>
<p>垃圾回收(garbage collection), 在之前reflog expire时提到过.</p>
<p>git会在下面情况下自动进行垃圾回收:</p>
<ul>
<li>版本库里有过多松散对象</li>
<li>当推送到一个远程版本库时 (TODO ???实际测试没有清理)</li>
<li>当一些命令引入许多松散对象 (如 filter-branch, rebase)</li>
<li>当一些命令明确要求 (如 reflog expire)</li>
</ul>
<p>手动进行垃圾回收使用:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">gc</span>
</pre></div>


<p>当然, 如果要保留一些松散对象, 则要注意别被自动垃圾回收给干掉了.</p>
<p><code>git.auto</code>默认值是6700, 控制版本库允许存在的松散对象数量, 可以强制关闭掉:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="n">global</span> <span class="n">gc</span><span class="p">.</span><span class="k">auto</span> <span class="mi">0</span>
</pre></div>


<p>从上游rebase中恢复    <strong>TODO</strong></p>
<p>定制 Git 命令: 定义脚本, 脚本名以<code>git-</code>开头, 并保证有可执行权限, 然后把脚本放在<code>$PATH</code>路径下.</p>
<p>如书上的例子:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">echo</span> <span class="err">$</span><span class="n">PATH</span> <span class="o">|</span> <span class="n">tr</span> <span class="o">-</span><span class="n">s</span> <span class="sc">&#39;:&#39;</span> <span class="sc">&#39;\n&#39;</span> <span class="o">|</span> <span class="n">grep</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="n">bin</span>
<span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">TankyWoo</span><span class="o">/</span><span class="n">bin</span>

<span class="err">$</span> <span class="n">more</span> <span class="o">~/</span><span class="n">bin</span><span class="o">/</span><span class="n">git</span><span class="o">-</span><span class="n">top</span><span class="o">-</span><span class="n">check</span>
<span class="cp">#!/bin/bash</span>

<span class="k">if</span> <span class="p">[</span> <span class="o">-</span><span class="n">d</span> <span class="s">&quot;.git&quot;</span> <span class="p">];</span> <span class="n">then</span>
        <span class="n">echo</span> <span class="s">&quot;This is a top level Git development repository.&quot;</span>
        <span class="n">exit</span> <span class="mi">0</span>
<span class="n">fi</span>

<span class="n">echo</span> <span class="s">&quot;This is not a top level Git development repository.&quot;</span>
<span class="n">exit</span> <span class="o">-</span><span class="mi">1</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">top</span><span class="o">-</span><span class="n">check</span>
<span class="n">This</span> <span class="n">is</span> <span class="n">a</span> <span class="n">top</span> <span class="n">level</span> <span class="n">Git</span> <span class="n">development</span> <span class="n">repository</span><span class="p">.</span>
</pre></div>


<p>这个相对于<code>git config alias.xxx</code>就是可以定制逻辑复杂的脚本.</p>
<p>比如把上面branch-filter --env-filter的脚本放在这块.</p>
<p>Github上的<a href="https://github.com/tj/git-extras">tj/git-extras</a> 包含了很多扩展的命令工具.</p>
<p>快速查看变更:</p>
<p><code>git whatchanged</code>, 又一个给力的命令! 它的参数和git log基本一致, 如果输入<code>git whatchanged -h</code>可以看到提示是git log和git show的usage.</p>
<p>例子:</p>
<div class="hlcode"><pre><span class="cp"># 抽取其中一部分作为例子</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">whatchanged</span> <span class="o">--</span><span class="n">oneline</span>
<span class="mf">12e3223</span> <span class="n">Fix</span> <span class="n">Travis</span> <span class="n">CI</span> <span class="o">-</span> <span class="n">Build</span> <span class="err">#</span><span class="mi">126</span>
<span class="o">:</span><span class="mi">100755</span> <span class="mi">100755</span> <span class="mi">52</span><span class="n">c844a</span><span class="p">...</span> <span class="mi">486</span><span class="n">a651</span><span class="p">...</span> <span class="n">M</span>  <span class="n">simiki</span><span class="o">/</span><span class="n">cli</span><span class="p">.</span><span class="n">py</span>
<span class="n">e477fa6</span> <span class="n">Disable</span> <span class="n">logging</span> <span class="n">output</span> <span class="n">when</span> <span class="n">unittest</span> <span class="n">and</span> <span class="n">refactor</span>
<span class="o">:</span><span class="mo">000000</span> <span class="mi">100644</span> <span class="mf">0000000.</span><span class="p">..</span> <span class="mf">0043f</span><span class="mi">0</span><span class="n">c</span><span class="p">...</span> <span class="n">A</span>  <span class="n">tests</span><span class="o">/</span><span class="n">__init__</span><span class="p">.</span><span class="n">py</span>
<span class="o">:</span><span class="mi">100644</span> <span class="mi">100644</span> <span class="mi">6441</span><span class="n">aa8</span><span class="p">...</span> <span class="n">a9ee8f0</span><span class="p">...</span> <span class="n">M</span>  <span class="n">tests</span><span class="o">/</span><span class="n">test_log</span><span class="p">.</span><span class="n">py</span>
<span class="mo">055</span><span class="mi">84</span><span class="n">a3</span> <span class="n">Simplify</span> <span class="n">generate</span> <span class="n">argument</span>
<span class="o">:</span><span class="mi">100755</span> <span class="mi">100755</span> <span class="mf">405f776.</span><span class="p">..</span> <span class="mi">52</span><span class="n">c844a</span><span class="p">...</span> <span class="n">M</span>  <span class="n">simiki</span><span class="o">/</span><span class="n">cli</span><span class="p">.</span><span class="n">py</span>
<span class="o">:</span><span class="mi">100644</span> <span class="mi">100644</span> <span class="mi">2995</span><span class="n">ac3</span><span class="p">...</span> <span class="n">e5fda56</span><span class="p">...</span> <span class="n">M</span>  <span class="n">simiki</span><span class="o">/</span><span class="n">utils</span><span class="p">.</span><span class="n">py</span>
<span class="o">:</span><span class="mi">100644</span> <span class="mo">000000</span> <span class="mf">7796986.</span><span class="p">..</span> <span class="mf">0000000.</span><span class="p">..</span> <span class="n">D</span>  <span class="n">tests</span><span class="o">/</span><span class="n">attach</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">opstools</span><span class="p">.</span><span class="n">png</span>
<span class="o">:</span><span class="mo">000000</span> <span class="mi">100644</span> <span class="mf">0000000.</span><span class="p">..</span> <span class="mf">7796986.</span><span class="p">..</span> <span class="n">A</span>  <span class="n">tests</span><span class="o">/</span><span class="n">mywiki</span><span class="o">/</span><span class="n">attach</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">opstools</span><span class="p">.</span><span class="n">png</span>
<span class="o">:</span><span class="mi">100644</span> <span class="mi">100644</span> <span class="n">a0c3c56</span><span class="p">...</span> <span class="mf">2e0</span><span class="n">ae86</span><span class="p">...</span> <span class="n">M</span>  <span class="n">tests</span><span class="o">/</span><span class="n">test_cli</span><span class="p">.</span><span class="n">py</span>
<span class="n">a54174d</span> <span class="n">move</span> <span class="n">pages</span> <span class="n">to</span> <span class="n">a</span> <span class="n">class</span> <span class="n">variable</span>
<span class="o">:</span><span class="mi">100755</span> <span class="mi">100755</span> <span class="n">d150c3a</span><span class="p">...</span> <span class="mf">405f776.</span><span class="p">..</span> <span class="n">M</span>  <span class="n">simiki</span><span class="o">/</span><span class="n">cli</span><span class="p">.</span><span class="n">py</span>
</pre></div>


<p>在上面例子里, 每个提交有两行.</p>
<p>第一行是commit id 和 commit message</p>
<p>第二行分别是 文件位模式(提交前和提交后), blob的sha-1 id(提交前和提交后), 状态字母, 更改后blob的路径</p>
<p>还可以限制时间, 比如上周有哪些提交, 都修改了哪些文件:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">whatchanged</span> <span class="o">--</span><span class="n">since</span><span class="o">=</span><span class="err">&#39;</span><span class="n">last</span> <span class="n">week</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">oneline</span>
</pre></div>


<p>还可以显示文件:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">whatchanged</span> <span class="o">--</span><span class="n">since</span><span class="o">=</span><span class="err">&#39;</span><span class="n">last</span> <span class="n">week</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">file</span>
</pre></div>


<p>清理仓库工作目录:</p>
<p><code>git clean</code>用于清理仓库的工作目录, 比如一个Python的仓库, 中间经过执行、打包等操作, 会产生一些临时文件, 可以使用此命令删除(也可以自己写Makefile).</p>
<p>git clean默认情况下不会删除<code>.gitignore</code>和<code>.git/info/exclude</code>指定的文件, 通过<code>-x</code>会将列表中的文件也删掉;</p>
<p>如果不确定会删除哪些文件, 可以使用<code>-n/--dry-run</code>;</p>
<p>默认只删除文件, 目录会保留, <code>-d</code>会将目录也删除.</p>
<p>搜索版本库:</p>
<p>之前提到过<code>git log -S &lt;string&gt;</code>用于搜索提交的变更历史中包含指定字符串的功能.</p>
<p><code>git grep</code>用于搜索历史记录上某个特定点的版本库内文件的内容. 默认情况下, 只搜索工作树上被追踪的文件.</p>
<p>此命令支持传统grep命令的参数.</p>
<p>之前用的grep就比较麻烦, 因为会搜到.git/目录下的信息.</p>
<p>更新和删除ref:</p>
<p><code>git update-ref</code>可以用于更新引用、符号引用的值.</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">rev</span><span class="o">-</span><span class="n">parse</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
<span class="n">ba5ddbed95e2798d6862debe7ce434270ae392a9</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">update</span><span class="o">-</span><span class="n">ref</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span> <span class="mi">5406</span><span class="n">b57</span>

<span class="err">$</span> <span class="n">git</span> <span class="n">rev</span><span class="o">-</span><span class="n">parse</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
<span class="mi">5406</span><span class="n">b570273078b2193fc7b890f20a56b2e697c8</span>

<span class="cp"># 删除引用dev</span>
<span class="err">$</span> <span class="n">git</span> <span class="n">update</span><span class="o">-</span><span class="n">ref</span> <span class="o">-</span><span class="n">d</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">dev</span>
</pre></div>


<p>跟踪移动的文件: <code>--follow</code>选项, 在git log时提到过</p>
<p>保留但不追踪文件:</p>
<p>也是一个很常见的需求, 开发时, 某个文件可能需要做一些参数或其它地方调整, 但是不需要提交. 这时一是有diff, 看着不舒服, 二是没法直接add所有.</p>
<p><code>git update-index --assume-unchanged &lt;file&gt;</code> 可以将指定文件标记为不追踪. 如果有更改需要提交时, 先用<code>--no-assume-unchanged</code>改回来.</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="nx">git</span> <span class="nx">diff</span> <span class="nb">file</span>
<span class="nx">diff</span> <span class="o">--</span><span class="nx">git</span> <span class="nx">a</span><span class="p">/</span><span class="nb">file</span> <span class="nx">b</span><span class="p">/</span><span class="nb">file</span>
<span class="nb">index</span> <span class="mi">8768061</span><span class="nx">..5329883</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="nx">a</span><span class="p">/</span><span class="nb">file</span>
<span class="o">+++</span> <span class="nx">b</span><span class="p">/</span><span class="nb">file</span>
<span class="p">@@</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="p">@@</span>
<span class="o">-</span> <span class="nx">bar</span>
<span class="o">+</span><span class="nb">foo</span> <span class="nx">bar</span>

<span class="err">$</span> <span class="nx">git</span> <span class="nx">update</span><span class="na">-index</span> <span class="o">--</span><span class="nx">assume</span><span class="na">-unchanged</span> <span class="nb">file</span>

<span class="err">$</span> <span class="nx">git</span> <span class="nb">status</span>
<span class="k">On</span> <span class="nx">branch</span> <span class="nx">master</span>
<span class="nx">Your</span> <span class="nx">branch</span> <span class="nx">is</span> <span class="nb">up</span><span class="na">-to-date</span> <span class="k">with</span> <span class="s1">&#39;origin/master&#39;</span><span class="nx">.</span>
<span class="nx">nothing</span> <span class="k">to</span> <span class="nx">commit</span><span class="p">,</span> <span class="nx">working</span> <span class="nx">directory</span> <span class="nx">clean</span>

<span class="err">$</span> <span class="nx">git</span> <span class="nx">update</span><span class="na">-index</span> <span class="o">--</span><span class="nx">no</span><span class="na">-assume-unchanged</span> <span class="nb">file</span>

<span class="err">$</span> <span class="nx">git</span> <span class="nb">status</span>
<span class="k">On</span> <span class="nx">branch</span> <span class="nx">master</span>
<span class="nx">Your</span> <span class="nx">branch</span> <span class="nx">is</span> <span class="nb">up</span><span class="na">-to-date</span> <span class="k">with</span> <span class="s1">&#39;origin/master&#39;</span><span class="nx">.</span>
<span class="nx">Changes</span> <span class="ow">not</span> <span class="nx">staged</span> <span class="nb">for</span> <span class="nx">commit</span><span class="p">:</span>
  <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git add &lt;file&gt;...&quot;</span> <span class="k">to</span> <span class="nx">update</span> <span class="nx">what</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">committed</span><span class="p">)</span>
  <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git checkout -- &lt;file&gt;...&quot;</span> <span class="k">to</span> <span class="nx">discard</span> <span class="n">changes</span> <span class="k">in</span> <span class="nx">working</span> <span class="nx">directory</span><span class="p">)</span>

        <span class="nx">modified</span><span class="p">:</span>   <span class="nb">file</span>

<span class="nx">no</span> <span class="nx">changes</span> <span class="nx">added</span> <span class="k">to</span> <span class="nx">commit</span> <span class="p">(</span><span class="nx">use</span> <span class="s2">&quot;git add&quot;</span> <span class="ow">and</span><span class="p">/</span><span class="nb">or</span> <span class="s2">&quot;git commit -a&quot;</span><span class="p">)</span>
</pre></div>


<p>重用已录制的解决方案:</p>
<p><code>git rerere</code>(reuse record resolution), 用于自动解决相同的合并或变基冲突操作.</p>
<p>默认是关闭的, 开启选项:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="n">global</span> <span class="n">rerere</span><span class="p">.</span><span class="n">enabled</span> <span class="nb">true</span>
</pre></div>


<p>该功能会在 <code>.git/rr-cache</code>目录下记录合并冲突的左右两侧, 如果把冲突解决了, 还会记录冲突的手动解决方案.</p>
<p>但是rerere 属于本地的概念, 所以.rr-cache目录没法push到远程</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">tree</span> <span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">rr</span><span class="o">-</span><span class="n">cache</span>
<span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">rr</span><span class="o">-</span><span class="n">cache</span>
<span class="err">└──</span> <span class="mi">670909</span><span class="n">b9c4e71983c75c81b566c1ec1ba08d65b5</span>
    <span class="err">├──</span> <span class="n">postimage</span>
    <span class="err">└──</span> <span class="n">preimage</span>
</pre></div>


<p>比如我这里, 如果合并时有冲突, 会产生一个preimage, 记录冲突的diff; 如果我修复提交后, 会产生一个postimage, 记录解决冲突后的内容.</p>
<h2 id="21-git-github">21. Git 和 Github(略)</h2>
  
  <div class="relation">
    Related:
    <ul>
  
    <li><a href="/tool/git.html">Git</a></li>
  
    <li><a href="/tool/practical-vim.html">Practical Vim</a></li>
  
    <li><a href="/tool/regular-expressions-in-10-minutes.html">正则表达式必知必会</a></li>
  
    <li><a href="/web/eloquent-javascript.html">JavaScript编程精解</a></li>
  
    </ul>
  </div>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2012-2017 Tanky Woo.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://git.coding.net/tankywoo/yasimple_x2.git" target="_blank">YASimple_X2</a>.
        </p>
        <p>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>站点最后生成 2017-09-04 19:21:05</p>
        <p><a href="https://github.com/tankywoo/wiki.tankywoo.com">Fork me on Github</a></p>
        <p><a href="http://www.miitbeian.gov.cn/">京ICP备16016622号</a></p>
      </div> <!-- end footer-right -->
    </div>

    
    

    <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F754de327571c0ba7ff50a61fc964e196' type='text/javascript'%3E%3C/script%3E"));
    </script>
  </body>
</html>