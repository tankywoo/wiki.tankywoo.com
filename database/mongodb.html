<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>MongoDB - Wiki · Tanky Woo</title>
    <meta name="keywords" content="wiki, makrdown, linux, python, cpp, ops, simiki"/>
    <meta name="description" content="Tanky Woo's personal wiki, powered by vim and markdown. Focus on Python, C/C++, Linux, Ops-Dev, Gentoo, and so on."/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/">Wiki · Tanky Woo</a>
    &nbsp;&#187;&nbsp;
    <a href="/#database">database</a>
    &nbsp;&#187;&nbsp;MongoDB
    <span class="updated">当前页面最后更新&nbsp;
    2017-08-08 17:55
    
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">常用命令</a><ul>
<li><a href="#_2">插入数据</a></li>
<li><a href="#_3">用户认证</a></li>
<li><a href="#_4">更新整个文档</a></li>
<li><a href="#collection">collection增加一列</a></li>
<li><a href="#_5">修改某一个文档的某一列值</a></li>
</ul>
</li>
<li><a href="#cheat-sheet">Cheat Sheet</a></li>
</ul>
</div>
<p><a href="https://docs.mongodb.com/manual/">MongoDB官方文档</a></p>
<h2 id="_1">常用命令</h2>
<h3 id="_2">插入数据</h3>
<div class="hlcode"><pre>db.users.insert({&#39;username&#39;: &#39;tankywoo&#39;, &#39;email&#39;: &#39;me@tankywoo.com&#39;, &#39;name&#39;: &#39;TankyWoo&#39;, &#39;password_hash&#39;: &#39;pbkdf2:sha1:1000$pPfqG458$6f79c72df67897b1234abcdcc4helloworldhehe&#39;})
</pre></div>


<h3 id="_3">用户认证</h3>
<p>目前最新的稳定版是 3.X 版本，认证这块改动还是非常大：</p>
<p>首先，认证机制由 <code>MONGODB-CR</code> 改为 <code>SCRAM-SHA-1</code>，<a href="https://docs.mongodb.com/manual/release-notes/3.0-scram/#upgrade-2-6-mongodb-cr-users-to-scram-sha-1">参考</a>，具体看<a href="https://docs.mongodb.com/manual/core/authentication-mechanisms/">这里</a></p>
<p>创建用户的命令也变了，改用 <code>db.createUser()</code></p>
<p>最后，用户的角色也变得非常复杂，比如针对数据库用户、数据库管理员、超级管理员等等，具体看 <a href="https://docs.mongodb.com/manual/reference/built-in-roles/#all-database-roles">Built-In Roles</a></p>
<p>大致的步骤就是：</p>
<ul>
<li>先关闭认证，切换到 admin 数据库</li>
<li>创建管理员用户，用于后续针对数据库创建的读写用户</li>
<li>开启认证，使用管理员登录</li>
<li>切换到欲创建的数据库，创建用户，授予如 <code>readWrite</code> 角色使其可以读写</li>
</ul>
<p>注：一个用户可以配置多个角色，比如我使用 <a href="https://github.com/TylerBrock/mongo-hacker">mongo-hacker</a> 会在 <code>find</code> 后读取 profile 信息，而这个信息需要 <code>dbAdmin</code> 角色读，所以我最后给用户 <code>readWrite</code> 和 <code>dbAdmin</code> 两个角色：</p>
<div class="hlcode"><pre>&gt; show users
{
  &quot;_id&quot;: &quot;mydb.myuser&quot;,
  &quot;user&quot;: &quot;myuser&quot;,
  &quot;db&quot;: &quot;mydb&quot;,
  &quot;roles&quot;: [
    {
      &quot;role&quot;: &quot;dbAdmin&quot;,
      &quot;db&quot;: &quot;mydb&quot;
    },
    {
      &quot;role&quot;: &quot;readWrite&quot;,
      &quot;db&quot;: &quot;mydb&quot;
    }
  ]
}
</pre></div>


<p>还可以参考这篇 <a href="http://tgrall.github.io/blog/2015/02/04/introduction-to-mongodb-security/">博文</a>，更详细可以看官方文档 <a href="https://docs.mongodb.com/manual/tutorial/enable-authentication/">Enable Auth</a></p>
<p>以下是 MongoDB 2.x 的用户认证相关：</p>
<p>首先先添加一个管理员帐号</p>
<div class="hlcode"><pre>&gt; use admin
switched to db admin

&gt; db.addUser(&quot;root&quot;, &quot;123456&quot;);
WARNING: The &#39;addUser&#39; shell helper is DEPRECATED. Please use &#39;createUser&#39; instead
Successfully added user: { &quot;user&quot; : &quot;tankywoo&quot;, &quot;roles&quot; : [ &quot;root&quot; ] }
</pre></div>


<p>给普通数据库添加帐号：</p>
<div class="hlcode"><pre>&gt; use mytest
switched to db mytest

&gt; db.addUser(&quot;tankywoo&quot;, &quot;123456&quot;);
WARNING: The &#39;addUser&#39; shell helper is DEPRECATED. Please use &#39;createUser&#39; instead
Successfully added user: { &quot;user&quot; : &quot;tankywoo&quot;, &quot;roles&quot; : [ &quot;dbOwner&quot; ] }
</pre></div>


<p>然后修改<code>mongodb.conf</code>，添加配置：</p>
<div class="hlcode"><pre>security:
  authorization: enabled
</pre></div>


<p>重启MongoDB</p>
<p>认证：</p>
<div class="hlcode"><pre>&gt; db.auth(&#39;username&#39;, &#39;password&#39;);
</pre></div>


<p><strong>注</strong> : 普通用户权限(绑定到数据库)，需要先<code>use dbname</code>切换到指定数据库，再认证。</p>
<h3 id="_4">更新整个文档</h3>
<div class="hlcode"><pre>mycollection.update({&#39;_id&#39;:mongo_id}, {&quot;$set&quot;: post}, upsert=False)
</pre></div>


<p>参考:</p>
<ul>
<li><a href="http://stackoverflow.com/questions/4372797/how-do-i-update-a-mongo-document-after-inserting-it">How do I update a Mongo document after inserting it?</a></li>
<li><a href="http://stackoverflow.com/questions/10290621/how-do-i-partially-update-an-object-in-mongodb-so-the-new-object-will-overlay">How do I partially update an object in MongoDB so the new object will overlay / merge with the existing one</a></li>
</ul>
<h3 id="collection">collection增加一列</h3>
<div class="hlcode"><pre>&gt; db.coll.update({}, {$set: {&#39;data&#39;: {}}}, false, true)
Updated 2 existing record(s) in 2ms
WriteResult({
  &quot;nMatched&quot;: 2,
  &quot;nUpserted&quot;: 0,
  &quot;nModified&quot;: 2
})
</pre></div>


<p>参考：<a href="http://stackoverflow.com/questions/7714216/add-new-field-to-a-collection-in-mongodb">Add new field to a collection in MongoDB</a></p>
<h3 id="_5">修改某一个文档的某一列值</h3>
<p>比如多级字典：</p>
<div class="hlcode"><pre>&gt; db.coll.update({&#39;_id&#39;: ObjectId(&#39;123405ff3b909e19269a381a&#39;)}, {$set: {&#39;data&#39;: {&#39;2016-09-24&#39;: true}}})
</pre></div>


<p>或者（这种比较方便）：</p>
<div class="hlcode"><pre>&gt; db.coll.update({&#39;_id&#39;: ObjectId(&#39;123405ff3b909e19269a381a&#39;)}, {$set: {&#39;data.2016-09-24&#39;: true}} )
</pre></div>


<p>参考：<a href="http://stackoverflow.com/questions/29267519/mongodb-update-dictionary-in-document">MongoDB: update dictionary in document</a></p>
<h2 id="cheat-sheet">Cheat Sheet</h2>
<ul>
<li><a href="chrome-extension://ikhdkkncnoglghljlkmcimlnlhkeamad/pdf-viewer/web/viewer.html?file=https%3A%2F%2Fblog.codecentric.de%2Ffiles%2F2012%2F12%2FMongoDB-CheatSheet-v1_0.pdf">MongoDB-CheatSheet-v1_0.pdf</a></li>
<li><a href="https://www.cheatography.com/ovi-mihai/cheat-sheets/mongodb/">MongoDB Cheat Sheet by ovi_mihai</a></li>
<li><a href="http://www.mongodbspain.com/en/2014/03/23/mongodb-cheat-sheet-quick-reference/">MongoDB Cheat Sheet – Quick Reference</a></li>
</ul>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2012-2017 Tanky Woo.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://github.com/tankywoo/yasimple_x2" target="_blank">YASimple_X2</a>.
        </p>
        <p>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>站点最后生成 2017-12-20 17:19:45</p>
        <p><a href="https://github.com/tankywoo/wiki.tankywoo.com">Fork me on Github</a></p>
        <p><a href="http://www.miitbeian.gov.cn/">京ICP备16016622号</a></p>
      </div> <!-- end footer-right -->
    </div>

    
    

    <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F754de327571c0ba7ff50a61fc964e196' type='text/javascript'%3E%3C/script%3E"));
    </script>
  </body>
</html>