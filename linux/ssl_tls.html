<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>SSL/TLS相关 - Wiki · Tanky Woo</title>
    <meta name="keywords" content="wiki, makrdown, linux, python, cpp, ops, simiki"/>
    <meta name="description" content="Tanky Woo's personal wiki, powered by vim and markdown. Focus on Python, C/C++, Linux, Ops-Dev, Gentoo, and so on."/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/">Wiki · Tanky Woo</a>
    &nbsp;&#187;&nbsp;
    <a href="/#linux">linux</a>
    &nbsp;&#187;&nbsp;SSL/TLS相关
    <span class="updated">最后更新&nbsp;
    2016-04-07 09:50
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#ca">自建CA</a></li>
</ul>
</div>
<h2 id="ca">自建CA</h2>
<p>环境:</p>
<ul>
<li>Gentoo</li>
<li>OpenSSL 1.0.2g</li>
</ul>
<p>当前环境下, 有关SSL证书的目录是 <code>/etc/ssl/</code>。</p>
<p>A certificate authority (CA) is an entity that signs digital certificates.</p>
<p>默认openssl配置: <code>/etc/ssl/openssl.cnf</code>， 定义openssl操作时的一些默认选项。</p>
<div class="hlcode"><pre><span class="cp">####################################################################</span>
<span class="p">[</span> <span class="n">ca</span> <span class="p">]</span>
<span class="n">default_ca</span>      <span class="o">=</span> <span class="n">CA_default</span>            <span class="err">#</span> <span class="n">The</span> <span class="k">default</span> <span class="n">ca</span> <span class="n">section</span>

<span class="cp">####################################################################</span>
<span class="p">[</span> <span class="n">CA_default</span> <span class="p">]</span>

<span class="cp">#dir            = ./demoCA              # Where everything is kept</span>
<span class="n">dir</span>             <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">demoCA</span>       <span class="err">#</span> <span class="n">Where</span> <span class="n">everything</span> <span class="n">is</span> <span class="n">kept</span>
<span class="n">certs</span>           <span class="o">=</span> <span class="err">$</span><span class="n">dir</span><span class="o">/</span><span class="n">certs</span>            <span class="err">#</span> <span class="n">Where</span> <span class="n">the</span> <span class="n">issued</span> <span class="n">certs</span> <span class="n">are</span> <span class="n">kept</span>
<span class="n">crl_dir</span>         <span class="o">=</span> <span class="err">$</span><span class="n">dir</span><span class="o">/</span><span class="n">crl</span>              <span class="err">#</span> <span class="n">Where</span> <span class="n">the</span> <span class="n">issued</span> <span class="n">crl</span> <span class="n">are</span> <span class="n">kept</span>
<span class="n">database</span>        <span class="o">=</span> <span class="err">$</span><span class="n">dir</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">txt</span>        <span class="err">#</span> <span class="n">database</span> <span class="n">index</span> <span class="n">file</span><span class="p">.</span>
<span class="cp">#unique_subject = no                    # Set to &#39;no&#39; to allow creation of</span>
                                        <span class="err">#</span> <span class="n">several</span> <span class="n">ctificates</span> <span class="n">with</span> <span class="n">same</span> <span class="n">subject</span><span class="p">.</span>
<span class="n">new_certs_dir</span>   <span class="o">=</span> <span class="err">$</span><span class="n">dir</span><span class="o">/</span><span class="n">newcerts</span>         <span class="err">#</span> <span class="k">default</span> <span class="n">place</span> <span class="k">for</span> <span class="n">new</span> <span class="n">certs</span><span class="p">.</span>

<span class="n">certificate</span>     <span class="o">=</span> <span class="err">$</span><span class="n">dir</span><span class="o">/</span><span class="n">cacert</span><span class="p">.</span><span class="n">pem</span>       <span class="err">#</span> <span class="n">The</span> <span class="n">CA</span> <span class="n">certificate</span>
<span class="n">serial</span>          <span class="o">=</span> <span class="err">$</span><span class="n">dir</span><span class="o">/</span><span class="n">serial</span>           <span class="err">#</span> <span class="n">The</span> <span class="n">current</span> <span class="n">serial</span> <span class="n">number</span>
<span class="n">crlnumber</span>       <span class="o">=</span> <span class="err">$</span><span class="n">dir</span><span class="o">/</span><span class="n">crlnumber</span>        <span class="err">#</span> <span class="n">the</span> <span class="n">current</span> <span class="n">crl</span> <span class="n">number</span>
                                        <span class="err">#</span> <span class="n">must</span> <span class="n">be</span> <span class="n">commented</span> <span class="n">out</span> <span class="n">to</span> <span class="n">leave</span> <span class="n">a</span> <span class="n">V1</span> <span class="n">CRL</span>
<span class="n">crl</span>             <span class="o">=</span> <span class="err">$</span><span class="n">dir</span><span class="o">/</span><span class="n">crl</span><span class="p">.</span><span class="n">pem</span>          <span class="err">#</span> <span class="n">The</span> <span class="n">current</span> <span class="n">CRL</span>
<span class="n">private_key</span>     <span class="o">=</span> <span class="err">$</span><span class="n">dir</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">cakey</span><span class="p">.</span><span class="n">pem</span>        <span class="err">#</span> <span class="n">The</span> <span class="n">private</span> <span class="n">key</span>
<span class="n">RANDFILE</span>        <span class="o">=</span> <span class="err">$</span><span class="n">dir</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="p">.</span><span class="n">rand</span>    <span class="err">#</span> <span class="n">private</span> <span class="n">random</span> <span class="n">number</span> <span class="n">file</span>
</pre></div>


<p>其中:</p>
<ul>
<li><code>default_ca</code> 配置默认使用的ca配置块，这里配置的是下面的「CA_default」块。</li>
<li><code>dir</code> 配置CA相关的根目录，默认是相对路径，因为涉及到在别的路径下操作，所以这里我改为绝对路径。</li>
<li><code>certs</code> / <code>crl_dir</code> 存放的是个人使用的相关的 cert / crl。具体讨论见: <a href="http://serverfault.com/questions/360825/what-is-certs-in-openssl-conf-for">What is “certs” in openssl.conf for?</a></li>
<li><code>database</code> / <code>serial</code> / <code>crlnumber</code> 都是维护的索引文件，编号可以自定义。</li>
<li><code>new_certs_dir</code> 存放通过ca签发的证书。</li>
<li><code>private_key</code> 是CA证书私钥。</li>
<li><code>certificate</code> 是CA证书。</li>
<li><code>crl</code> 是当前的CRL。</li>
</ul>
<p>扩展这块还需要研究: TODO</p>
<div class="hlcode"><pre><span class="n">x509_extensions</span> <span class="o">=</span> <span class="n">usr_cert</span>              <span class="err">#</span> <span class="n">The</span> <span class="n">extentions</span> <span class="n">to</span> <span class="n">add</span> <span class="n">to</span> <span class="n">the</span> <span class="n">cert</span>
</pre></div>


<p>匹配策略配置:</p>
<div class="hlcode"><pre><span class="c1"># A few difference way of specifying how similar the request should look</span>
<span class="s-Atom">#</span> <span class="nv">For</span> <span class="s-Atom">type</span> <span class="nv">CA</span><span class="p">,</span> <span class="s-Atom">the</span> <span class="s-Atom">listed</span> <span class="s-Atom">attributes</span> <span class="s-Atom">must</span> <span class="s-Atom">be</span> <span class="s-Atom">the</span> <span class="s-Atom">same</span><span class="p">,</span> <span class="s-Atom">and</span> <span class="s-Atom">the</span> <span class="s-Atom">optional</span>
<span class="s-Atom">#</span> <span class="s-Atom">and</span> <span class="s-Atom">supplied</span> <span class="s-Atom">fields</span> <span class="s-Atom">are</span> <span class="s-Atom">just</span> <span class="nf">that</span> <span class="o">:-</span><span class="p">)</span>
<span class="s-Atom">policy</span>          <span class="o">=</span> <span class="s-Atom">policy_match</span>

<span class="s-Atom">#</span> <span class="nv">For</span> <span class="s-Atom">the</span> <span class="nv">CA</span> <span class="s-Atom">policy</span>
<span class="p">[</span> <span class="s-Atom">policy_match</span> <span class="p">]</span>
<span class="s-Atom">countryName</span>             <span class="o">=</span> <span class="s-Atom">match</span>
<span class="s-Atom">stateOrProvinceName</span>     <span class="o">=</span> <span class="s-Atom">optional</span>
<span class="s-Atom">organizationName</span>        <span class="o">=</span> <span class="s-Atom">optional</span>
<span class="s-Atom">organizationalUnitName</span>  <span class="o">=</span> <span class="s-Atom">optional</span>
<span class="s-Atom">commonName</span>              <span class="o">=</span> <span class="s-Atom">supplied</span>
<span class="s-Atom">emailAddress</span>            <span class="o">=</span> <span class="s-Atom">optional</span>
</pre></div>


<p>如果是 <code>match</code>, 则必须要一样的配置才行; 比如之前「organizationName 」是match, 而我签发证书时写的和CA的organizationName 不一样，导致报错:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">openssl</span> <span class="n">ca</span> <span class="o">-</span><span class="n">in</span> <span class="n">www</span><span class="p">.</span><span class="n">tankywoo</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">csr</span> <span class="o">-</span><span class="n">out</span> <span class="n">www</span><span class="p">.</span><span class="n">tankywoo</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">crt</span>
<span class="n">Using</span> <span class="n">configuration</span> <span class="n">from</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">openssl</span><span class="p">.</span><span class="n">cnf</span>
<span class="n">Check</span> <span class="n">that</span> <span class="n">the</span> <span class="n">request</span> <span class="n">matches</span> <span class="n">the</span> <span class="n">signature</span>
<span class="n">Signature</span> <span class="n">ok</span>
<span class="n">The</span> <span class="n">organizationName</span> <span class="n">field</span> <span class="n">needed</span> <span class="n">to</span> <span class="n">be</span> <span class="n">the</span> <span class="n">same</span> <span class="n">in</span> <span class="n">the</span>
<span class="n">CA</span> <span class="n">certificate</span> <span class="p">(</span><span class="n">myorg1</span><span class="p">)</span> <span class="n">and</span> <span class="n">the</span> <span class="n">request</span> <span class="p">(</span><span class="n">myorg2</span><span class="p">)</span>
</pre></div>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2012-2016 Tanky Woo.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://git.coding.net/tankywoo/yasimple_x2.git" target="_blank">YASimple_X2</a>.
        </p>
        <p>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>站点最后生成 2016-09-20 11:12:19</p>
        <p><a href="https://github.com/tankywoo/wiki.tankywoo.com">Fork me on Github</a></p>
        <p><a href="http://www.miitbeian.gov.cn/">京ICP备16016622号</a></p>
      </div> <!-- end footer-right -->
    </div>
    <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F754de327571c0ba7ff50a61fc964e196' type='text/javascript'%3E%3C/script%3E"));
    </script>
  </body>
</html>