<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Linux Tips - Wiki · Tanky Woo</title>
    <meta name="keywords" content="wiki, makrdown, linux, python, cpp, ops, simiki"/>
    <meta name="description" content="Tanky Woo's personal wiki, powered by vim and markdown. Focus on Python, C/C++, Linux, Ops-Dev, Gentoo, and so on."/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/">Wiki · Tanky Woo</a>
    &nbsp;&#187;&nbsp;
    <a href="/#linux">linux</a>
    &nbsp;&#187;&nbsp;Linux Tips
    <span class="updated">最后更新&nbsp;
    2016-08-22 11:00
    
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#shell">查看现在使用的是哪一个shell</a></li>
<li><a href="#login-shell">修改login shell</a></li>
<li><a href="#_1">快速返回到上一个目录</a></li>
<li><a href="#export-c">关于export C</a></li>
<li><a href="#10">查看本机最常用的10条命令</a></li>
<li><a href="#_2">获取一个字符串的长度</a></li>
<li><a href="#py">统计当前目录下（包括子目录）以.py结尾文件的个数及总代码行数</a></li>
<li><a href="#_3">输出错误重定向</a></li>
<li><a href="#show-number-of-connections-per-remote-ip">Show number of connections per remote IP</a></li>
<li><a href="#root">以root身份执行上一条命令</a></li>
<li><a href="#web">开启一个Web服务器(传输)</a></li>
<li><a href="#vim">vim里强制保存</a></li>
<li><a href="#_4">替换上条命令的关键字并执行</a></li>
<li><a href="#_5">复制一个备份文件</a></li>
<li><a href="#_6">搜索最近一条符合关键字的命令</a></li>
<li><a href="#_7">给远程机器添加公钥认证</a></li>
<li><a href="#linux">把 Linux 桌面录制为视频</a></li>
<li><a href="#arp">快速清空arp缓存表</a></li>
<li><a href="#hddssd">检查硬盘是HDD还是SSD</a></li>
<li><a href="#ext3">Ext3关闭日志特性</a></li>
<li><a href="#terminal-name">获取当前的terminal name</a></li>
<li><a href="#widle">w命令idle</a></li>
<li><a href="#awk">awk 显示某些列</a></li>
<li><a href="#useradd">useradd新建用户的目录权限</a></li>
<li><a href="#stderrstdout">重定向命令的stderr到stdout</a></li>
<li><a href="#newline">删除文件的最后一个newline符</a></li>
<li><a href="#_8">查看网卡类型</a></li>
<li><a href="#cron">cron命令中的%</a></li>
<li><a href="#mount-tmp-overflow">mount /tmp overflow</a></li>
<li><a href="#_9">检测某个端口是否被监听</a></li>
<li><a href="#linux-ipv6-in-ipv4">Linux IPv6-in-IPv4</a></li>
<li><a href="#days-since-19700101">days since 1970/01/01 和 当前日期互相转换</a></li>
</ul>
</div>
<h3 id="shell">查看现在使用的是哪一个shell</h3>
<div class="hlcode"><pre><span class="n">echo</span> <span class="err">$</span><span class="mi">0</span>
</pre></div>


<h3 id="login-shell">修改login shell</h3>
<div class="hlcode"><pre><span class="n">chsh</span>
</pre></div>


<h3 id="_1">快速返回到上一个目录</h3>
<p>有时候移到一个目录, 想直接返回去</p>
<div class="hlcode"><pre><span class="n">cd</span> <span class="o">-</span>
</pre></div>


<h3 id="export-c">关于export C</h3>
<p>建议在脚本开始处加上<code>export C</code>，且如果man手册乱码，也可以:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">export</span> <span class="n">C</span> <span class="n">man</span> <span class="n">xxx</span>
</pre></div>


<h3 id="10">查看本机最常用的10条命令</h3>
<div class="hlcode"><pre><span class="n">history</span> <span class="o">|</span> <span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span><span class="n">a</span><span class="p">[</span><span class="err">$</span><span class="mi">2</span><span class="p">]</span><span class="o">++</span><span class="p">}</span><span class="n">END</span><span class="p">{</span><span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="n">a</span><span class="p">){</span><span class="n">print</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="s">&quot; &quot;</span> <span class="n">i</span><span class="p">}}</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">rn</span> <span class="o">|</span> <span class="n">head</span>
</pre></div>


<h3 id="_2">获取一个字符串的长度</h3>
<p>三种方法:</p>
<div class="hlcode"><pre>len `expr length <span class="nv">$str</span>`
echo <span class="cp">${</span><span class="nb">str</span><span class="cp">}</span> | wc -L
echo <span class="cp">${</span><span class="nb">str</span><span class="cp">}</span> # 推荐
</pre></div>


<h3 id="py">统计当前目录下（包括子目录）以.py结尾文件的个数及总代码行数</h3>
<p>文件个数: </p>
<div class="hlcode"><pre><span class="n">find</span> <span class="p">.</span> <span class="o">-</span><span class="n">name</span> <span class="s">&quot;*.py&quot;</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span>
</pre></div>


<p>单个文件代码行数及总行数:</p>
<div class="hlcode"><pre><span class="n">find</span> <span class="p">.</span> <span class="o">-</span><span class="n">name</span> <span class="s">&quot;*.py&quot;</span> <span class="o">|</span> <span class="n">xargs</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span>
</pre></div>


<h3 id="_3">输出错误重定向</h3>
<div class="hlcode"><pre><span class="n">ls</span> <span class="mi">1</span><span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
<span class="n">ls</span> <span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
</pre></div>


<h3 id="show-number-of-connections-per-remote-ip">Show number of connections per remote IP</h3>
<div class="hlcode"><pre><span class="n">netstat</span> <span class="o">-</span><span class="n">antu</span> <span class="o">|</span> <span class="n">awk</span> <span class="err">&#39;$</span><span class="mi">5</span> <span class="o">~</span> <span class="o">/</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">:/</span><span class="p">{</span><span class="n">split</span><span class="p">(</span><span class="err">$</span><span class="mi">5</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">);</span> <span class="n">ips</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">++</span><span class="p">}</span> <span class="n">END</span> <span class="p">{</span><span class="k">for</span> <span class="p">(</span><span class="n">ip</span> <span class="n">in</span> <span class="n">ips</span><span class="p">)</span> <span class="n">print</span> <span class="n">ips</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span> <span class="n">ip</span> <span class="o">|</span> <span class="s">&quot;sort -k1 -nr&quot;</span><span class="p">}</span><span class="err">&#39;</span>
</pre></div>


<h3 id="root">以root身份执行上一条命令</h3>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="o">!!</span>
</pre></div>


<h3 id="web">开启一个Web服务器(传输)</h3>
<div class="hlcode"><pre><span class="cp"># -m 表示找到模块, 执行相应的.py文件</span>
<span class="cp"># SimpleHTTPServer 是一个 Http Server 模块</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">SimpleHTTPServer</span>
</pre></div>


<h3 id="vim">vim里强制保存</h3>
<p>有时候, 一些文件编辑后, 才发现只有root可写</p>
<div class="hlcode"><pre><span class="o">:</span><span class="n">w</span> <span class="o">!</span><span class="n">sudo</span> <span class="n">tee</span> <span class="o">%</span>
</pre></div>


<h3 id="_4">替换上条命令的关键字并执行</h3>
<div class="hlcode"><pre><span class="cp"># 将上一条命令的pint换成traceroute</span>
<span class="o">^</span><span class="n">ping</span><span class="o">^</span><span class="n">traceroute</span><span class="o">^</span>
</pre></div>


<h3 id="_5">复制一个备份文件</h3>
<p>有时候, 为了测试, 为防止意外, 可能需要把 filename 在备份一个 filename.bak</p>
<div class="hlcode"><pre><span class="n">cp</span> <span class="n">filename</span><span class="p">{,.</span><span class="n">bak</span><span class="p">}</span>
</pre></div>


<h3 id="_6">搜索最近一条符合关键字的命令</h3>
<p>比如上面执行过命令是ping wutianqi.com, 想再执行, 可以</p>
<div class="hlcode"><pre><span class="cp"># p是关键字, 也可以 pi, pin, ping都行</span>
<span class="o">!</span><span class="n">p</span>
</pre></div>


<h3 id="_7">给远程机器添加公钥认证</h3>
<div class="hlcode"><pre><span class="n">ssh</span><span class="o">-</span><span class="n">copy</span><span class="o">-</span><span class="n">id</span> <span class="n">user</span><span class="err">@</span><span class="n">host</span>
</pre></div>


<p>很多人喜欢生成公私钥后, 用scp传过去, 再登录上去设置。
其实完全没必要, ssh-copy-id会自动把公钥添加到~/.ssh/authorized_keys末尾。
如果 ssh-add -L 里面有内容，会优先使用里面的公钥; 其次，可以用 -i 指定要添加的公钥，最后会用默认的 ~/.ssh/id_rsa.pub</p>
<h3 id="linux">把 Linux 桌面录制为视频</h3>
<p><em>TODO</em> 这个命令先记录一下, 还没尝试</p>
<div class="hlcode"><pre><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">f</span> <span class="n">x11grab</span> <span class="o">-</span><span class="n">s</span> <span class="n">wxga</span> <span class="o">-</span><span class="n">r</span> <span class="mi">25</span> <span class="o">-</span><span class="n">i</span> <span class="o">:</span><span class="mf">0.0</span> <span class="o">-</span><span class="n">sameq</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">out</span><span class="p">.</span><span class="n">mpg</span>
</pre></div>


<h3 id="arp">快速清空arp缓存表</h3>
<div class="hlcode"><pre><span class="k">for</span> <span class="n">a</span> <span class="n">in</span> <span class="err">`</span><span class="n">arp</span> <span class="o">|</span> <span class="n">grep</span> <span class="s">&quot;eth1&quot;</span> <span class="o">|</span> <span class="n">cut</span> <span class="o">-</span><span class="n">d</span> <span class="s">&quot; &quot;</span> <span class="o">-</span><span class="n">f1</span><span class="err">`</span><span class="p">;</span> <span class="k">do</span> <span class="n">arp</span> <span class="o">-</span><span class="n">d</span> <span class="err">$</span><span class="n">a</span><span class="p">;</span> <span class="n">done</span>
</pre></div>


<h3 id="hddssd">检查硬盘是HDD还是SSD</h3>
<p>方法1:</p>
<div class="hlcode"><pre><span class="n">cat</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">block</span><span class="o">/</span><span class="n">sda</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">rotational</span>
</pre></div>


<p>输出<code>1</code>则是HDD, 输出<code>0</code>则是SSD</p>
<p>方法2:</p>
<p>安装<code>smartmontools</code>工具，使用<code>smartctl</code>命令查看信息。</p>
<div class="hlcode"><pre><span class="n">tankywoo</span><span class="err">@</span><span class="n">gentoo</span><span class="o">-</span><span class="n">local</span><span class="o">::~/</span> <span class="err">»</span> <span class="n">sudo</span> <span class="n">smartctl</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span>
<span class="n">smartctl</span> <span class="mf">6.1</span> <span class="mi">2013</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mi">16</span> <span class="n">r3800</span> <span class="p">[</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="mf">3.7.10</span><span class="o">-</span><span class="n">gentoo</span><span class="o">-</span><span class="n">r1</span><span class="o">-</span><span class="n">ks</span><span class="p">]</span> <span class="p">(</span><span class="n">local</span> <span class="n">build</span><span class="p">)</span>
<span class="n">Copyright</span> <span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="mi">2002</span><span class="o">-</span><span class="mi">13</span><span class="p">,</span> <span class="n">Bruce</span> <span class="n">Allen</span><span class="p">,</span> <span class="n">Christian</span> <span class="n">Franke</span><span class="p">,</span> <span class="n">www</span><span class="p">.</span><span class="n">smartmontools</span><span class="p">.</span><span class="n">org</span>

<span class="o">===</span> <span class="n">START</span> <span class="n">OF</span> <span class="n">INFORMATION</span> <span class="n">SECTION</span> <span class="o">===</span>
<span class="n">Device</span> <span class="n">Model</span><span class="o">:</span>     <span class="n">gentoo</span><span class="o">-</span><span class="mi">0</span> <span class="n">SSD</span>
<span class="n">Serial</span> <span class="n">Number</span><span class="o">:</span>    <span class="mi">36</span><span class="n">CBA5PYHBJMH4MDR0YY</span>
<span class="n">Firmware</span> <span class="n">Version</span><span class="o">:</span> <span class="n">F</span><span class="mf">.9</span><span class="n">AGAJ4</span>
<span class="n">User</span> <span class="n">Capacity</span><span class="o">:</span>    <span class="mi">34</span><span class="p">,</span><span class="mi">359</span><span class="p">,</span><span class="mi">738</span><span class="p">,</span><span class="mi">368</span> <span class="n">bytes</span> <span class="p">[</span><span class="mf">34.3</span> <span class="n">GB</span><span class="p">]</span>
<span class="n">Sector</span> <span class="n">Sizes</span><span class="o">:</span>     <span class="mi">512</span> <span class="n">bytes</span> <span class="n">logical</span><span class="p">,</span> <span class="mi">4096</span> <span class="n">bytes</span> <span class="n">physical</span>
<span class="n">Rotation</span> <span class="n">Rate</span><span class="o">:</span>    <span class="n">Solid</span> <span class="n">State</span> <span class="n">Device</span>
<span class="n">Device</span> <span class="n">is</span><span class="o">:</span>        <span class="n">Not</span> <span class="n">in</span> <span class="n">smartctl</span> <span class="n">database</span> <span class="p">[</span><span class="k">for</span> <span class="n">details</span> <span class="n">use</span><span class="o">:</span> <span class="o">-</span><span class="n">P</span> <span class="n">showall</span><span class="p">]</span>
<span class="n">ATA</span> <span class="n">Version</span> <span class="n">is</span><span class="o">:</span>   <span class="n">ATA8</span><span class="o">-</span><span class="n">ACS</span><span class="p">,</span> <span class="n">ATA</span><span class="o">/</span><span class="n">ATAPI</span><span class="o">-</span><span class="mi">5</span> <span class="n">T13</span><span class="o">/</span><span class="mi">1321</span><span class="n">D</span> <span class="n">revision</span> <span class="mi">1</span>
<span class="n">SATA</span> <span class="n">Version</span> <span class="n">is</span><span class="o">:</span>  <span class="n">SATA</span> <span class="mf">2.6</span><span class="p">,</span> <span class="mf">3.0</span> <span class="n">Gb</span><span class="o">/</span><span class="n">s</span>
<span class="n">Local</span> <span class="n">Time</span> <span class="n">is</span><span class="o">:</span>    <span class="n">Mon</span> <span class="n">Jun</span> <span class="mi">23</span> <span class="mi">23</span><span class="o">:</span><span class="mi">31</span><span class="o">:</span><span class="mi">46</span> <span class="mi">2014</span> <span class="n">CST</span>
<span class="n">SMART</span> <span class="n">support</span> <span class="n">is</span><span class="o">:</span> <span class="n">Unavailable</span> <span class="o">-</span> <span class="n">device</span> <span class="n">lacks</span> <span class="n">SMART</span> <span class="n">capability</span><span class="p">.</span>

<span class="n">A</span> <span class="n">mandatory</span> <span class="n">SMART</span> <span class="n">command</span> <span class="n">failed</span><span class="o">:</span> <span class="n">exiting</span><span class="p">.</span> <span class="n">To</span> <span class="k">continue</span><span class="p">,</span> <span class="n">add</span> <span class="n">one</span> <span class="n">or</span> <span class="n">more</span> <span class="err">&#39;</span><span class="o">-</span><span class="n">T</span> <span class="n">permissive</span><span class="err">&#39;</span> <span class="n">options</span><span class="p">.</span>
</pre></div>


<p>其中<code>Rotation Rate:    Solid State Device</code> 显示了是HDD还是SSD</p>
<ul>
<li><a href="http://linuxg.net/how-to-find-out-if-a-drive-is-a-ssd-or-an-hdd/">How to Find Out if a Drive is a SSD or an HDD</a></li>
<li><a href="http://stackoverflow.com/questions/908188/is-there-any-way-of-detecting-if-a-drive-is-a-ssd">How to know if a disk is an SSD or an HDD</a></li>
<li><a href="http://stackoverflow.com/questions/908188/is-there-any-way-of-detecting-if-a-drive-is-a-ssd">http://linuxg.net/how-to-find-out-if-a-drive-is-a-ssd-or-an-hdd/</a></li>
</ul>
<h3 id="ext3">Ext3关闭日志特性</h3>
<div class="hlcode"><pre><span class="n">tune2fs</span> <span class="o">-</span><span class="n">O</span> <span class="o">^</span><span class="n">has_journal</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdX</span>
</pre></div>


<p>关闭前后可以确认下文件系统的特性:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">tune2fs</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">features</span>
<span class="n">Filesystem</span> <span class="n">features</span><span class="o">:</span>      <span class="n">has_journal</span> <span class="n">ext_attr</span> <span class="n">resize_inode</span> <span class="n">dir_index</span> <span class="n">filetype</span> <span class="n">needs_recovery</span> <span class="n">sparse_super</span> <span class="n">large_file</span>
</pre></div>


<p>关闭后 <code>has_journal</code> 日志特性没了</p>
<p>参考 <a href="http://blog.serverbuddies.com/disable-journaling-in-ext3-file-system/">Disable journaling in ext3 file system</a></p>
<h3 id="terminal-name">获取当前的terminal name</h3>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">tty</span>
</pre></div>


<p>参考 <a href="http://www.cyberciti.biz/faq/linux-unix-appleosx-bsd-what-tty-command/">Find Out What tty I’m Using</a></p>
<h3 id="widle">w命令idle</h3>
<blockquote>
<p>The idle time is supposed to tell how long it has been since the user typed any input on that terminal. For Xwindows sessions, it is broken since Xwindows never reads input from a terminal, but instead gathers input directly from your mouse and keyboard, so the terminal never gets its timestamp updated since it is never read from.</p>
<p>Without a qualifier, it means MM:SS -- that is, minutes and whole seconds. As an added bonus, there's a fourth format you don't have in that output -- a number of days (NNdays) of inactivity.</p>
</blockquote>
<p>参考:</p>
<ul>
<li><a href="http://askubuntu.com/questions/283337/what-does-idle-time-output-from-w-command-tell">What does idle time output from “w” command tell?</a></li>
<li><a href="http://serverfault.com/questions/302455/how-to-read-the-idle-column-in-the-output-of-the-linux-w-command">How to read the “IDLE” column in the output of the Linux 'w' command?</a></li>
</ul>
<h3 id="awk">awk 显示某些列</h3>
<p>比如显示第3列及以后所有列:</p>
<div class="hlcode"><pre><span class="n">ps</span> <span class="n">aux</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">ngin</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">|</span> <span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span><span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">NF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">printf</span> <span class="err">$</span><span class="n">i</span> <span class="s">&quot; &quot;</span><span class="p">}</span> <span class="p">{</span><span class="n">print</span> <span class="s">&quot;&quot;</span><span class="p">}</span><span class="err">&#39;</span>
</pre></div>


<p>参考 <a href="http://stackoverflow.com/questions/2626274/print-all-but-the-first-three-columns">Print all but the first three columns</a></p>
<h3 id="useradd">useradd新建用户的目录权限</h3>
<p>默认情况下, <code>useradd</code> 的 <code>UMASK</code> 是在 <code>/etc/login.defs</code> 中控制的, Gentoo下是<code>0022</code>.</p>
<p>这样新建用户时, 创建的home目录就是0755了, 针对同一个用户组的, 权限较大, 限制为0700比较合适.</p>
<p>可以通过useradd时指定UMASK:</p>
<div class="hlcode"><pre><span class="n">useradd</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="n">K</span> <span class="n">UMASK</span><span class="o">=</span><span class="mo">0077</span> <span class="n">testuser</span>
</pre></div>


<p><code>/etc/login.defs</code> 的UMASK参数只是针对 useradd 创建用户目录时用的.</p>
<p>参考:</p>
<ul>
<li><a href="http://www.golinuxhub.com/2014/05/understanding-umask-value-in-linux.html">Understanding UMASK value in Linux</a> 讲解的挺详细</li>
<li><a href="http://unix.stackexchange.com/questions/76532/what-type-of-permissions-should-a-users-home-directory-and-files-have">What type of permissions should a user's home directory and files have?</a></li>
<li><a href="http://unix.stackexchange.com/questions/37194/why-is-the-default-umask-value-for-useradd-in-opensuse-set-to-022">Why is the default umask value for useradd in openSuSE set to 022?</a></li>
</ul>
<h3 id="stderrstdout">重定向命令的stderr到stdout</h3>
<div class="hlcode"><pre><span class="n">command</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
</pre></div>


<p>参考 <a href="http://stackoverflow.com/questions/2342826/how-to-pipe-stderr-and-not-stdout">How to pipe stderr, and not stdout?</a></p>
<h3 id="newline">删除文件的最后一个newline符</h3>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">perl</span> <span class="o">-</span><span class="n">pe</span> <span class="err">&#39;</span><span class="n">chomp</span> <span class="k">if</span> <span class="n">eof</span><span class="err">&#39;</span> <span class="n">filename</span> <span class="o">&gt;</span><span class="n">filename2</span>
</pre></div>


<p>或</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">perl</span> <span class="o">-</span><span class="n">pi</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">chomp</span> <span class="k">if</span> <span class="n">eof</span><span class="err">&#39;</span> <span class="n">filename</span>
</pre></div>


<p>参考: <a href="http://stackoverflow.com/questions/1654021/how-can-i-delete-a-newline-if-it-is-the-last-character-in-a-file">How can I delete a newline if it is the last character in a file?</a></p>
<h3 id="_8">查看网卡类型</h3>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">lspci</span> <span class="o">|</span> <span class="n">egrep</span> <span class="o">-</span><span class="n">i</span> <span class="o">--</span><span class="n">color</span> <span class="err">&#39;</span><span class="n">network</span><span class="o">|</span><span class="n">ethernet</span><span class="err">&#39;</span>
<span class="err">$</span> <span class="n">lspci</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">net</span>
<span class="err">$</span> <span class="n">lshw</span> <span class="o">-</span><span class="n">class</span> <span class="n">network</span>
<span class="err">$</span> <span class="n">dmesg</span> <span class="o">|</span> <span class="n">grep</span> <span class="err">&#39;</span><span class="n">Ethernet</span> <span class="n">driver</span><span class="err">&#39;</span>
</pre></div>


<h3 id="cron">cron命令中的<code>%</code></h3>
<p>本来是准备通过crontab把命令的标准输出重定向到文件中，于是写为：</p>
<div class="hlcode"><pre><span class="err">*/</span><span class="mi">1</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="n">root</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">sh</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="n">date</span> <span class="o">+%</span><span class="n">d</span><span class="o">-%</span><span class="n">m</span><span class="o">-%</span><span class="n">Y</span><span class="p">).</span><span class="n">log</span>
</pre></div>


<p>结果没有产生日志文件，且cron日志显示：</p>
<div class="hlcode"><pre><span class="n">CMD</span> <span class="p">(</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">sh</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="n">date</span> <span class="o">+</span><span class="p">)</span>
</pre></div>


<p><code>man 8 crontab</code> 有提到百分号<code>%</code>在cron中的特殊意义：</p>
<blockquote>
<p>The entire command portion of the line, up to a newline or % character, will be executed by /bin/sh or by the shell specified in the SHELL variable of the cronfile.  Percent-signs (%) in the command, unless escaped with  backslash (), will be changed into newline characters, and all data after the first % will be sent to the command as standard input.</p>
</blockquote>
<p>除非转义，否则<code>%</code>相当于换行符, 命令中第一个%之后的都被当做标准输入(<code>read</code>可以读到)。改为：</p>
<div class="hlcode"><pre><span class="err">*/</span><span class="mi">1</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="n">root</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">sh</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="n">date</span> <span class="o">+</span><span class="err">\</span><span class="o">%</span><span class="n">d</span><span class="o">-</span><span class="err">\</span><span class="o">%</span><span class="n">m</span><span class="o">-</span><span class="err">\</span><span class="o">%</span><span class="n">Y</span><span class="p">).</span><span class="n">log</span>
</pre></div>


<h3 id="mount-tmp-overflow">mount /tmp overflow</h3>
<p>一台机器显示/tmp被mount为overflow:</p>
<div class="hlcode"><pre><span class="nv">$ </span>df -lh
Filesystem                   Size  Used Avail Use% Mounted on
...
overflow                     1.0M 1004K   20K  99% /tmp
</pre></div>


<p>以前没见过这种情况，搜了下，主要是开机时/tmp分区磁盘满了，无法写一些数据，于是临时建了一个overflow。</p>
<p>清理空间后重启就可以了，或者直接umount，不过要注意很多服务把临时文件以及socks等，都写在/tmp下，所以umount后服务要重启。</p>
<p>可以通过配置禁止这个行为。</p>
<p>参考：</p>
<ul>
<li><a href="http://jarrodoverson.com/blog/overflow-filesystem-in-linux/">Overflow filesystem mounted as /tmp in linux</a></li>
<li><a href="http://unix.stackexchange.com/questions/60731/overflow-tmp-mounted-when-there-is-free-space-on">Overflow /tmp mounted when there is free space on /</a></li>
</ul>
<h3 id="_9">检测某个端口是否被监听</h3>
<div class="hlcode"><pre><span class="err">$</span> <span class="nx">nc</span> <span class="na">-z</span> <span class="o">&lt;</span><span class="nx">ip</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nb">port</span><span class="o">&gt;</span><span class="p">;</span> <span class="nx">echo</span> <span class="err">$</span><span class="o">?</span>
</pre></div>


<p>ref: <a href="http://stackoverflow.com/questions/9609130/quick-way-to-find-if-a-port-is-open-on-linux">Quick way to find if a port is open on Linux</a></p>
<p>TODO 通过/dev 或 /proc 下读取信息?</p>
<h3 id="linux-ipv6-in-ipv4">Linux IPv6-in-IPv4</h3>
<p>某个机器下有网卡<code>sit0</code>，研究了下。</p>
<p>摘自网上一篇<a href="http://askubuntu.com/a/236071/434496">回答</a>：</p>
<blockquote>
<p>sit stands for simple internet transition. sit0 is the Linux name for 6to4. 6to4 is a tunneling protocol for using IPv6 over an existing IPv4 connection.</p>
<p>Source: <a href="http://www.tldp.org/HOWTO/Linux+IPv6-HOWTO/">http://www.tldp.org/HOWTO/Linux+IPv6-HOWTO/</a></p>
</blockquote>
<p>具体可以参考<a href="http://www.tldp.org/HOWTO/Linux+IPv6-HOWTO/chapter-configuring-ipv6-in-ipv4-tunnels.html">Configuring IPv6-in-IPv4 tunnels</a></p>
<div class="hlcode"><pre><span class="c"># 创建tunnel device</span>
<span class="c"># 注意：最开始没有指定local，即默认的any，则报错：</span>
<span class="c"># $ ip tunnel add tun6to4 mode sit ttl 64</span>
<span class="c"># &gt; add tunnel &quot;sit0&quot; failed: No buffer space available</span>
<span class="c"># 这个帖子也有这个问题，还不太清楚：https://forums.gentoo.org/viewtopic-t-862122-start-0.html</span>
<span class="c"># 创建设备后，会有两个虚拟网卡sit0和tun6to4</span>
<span class="nv">$ </span>ip tunnel add tun6to4 mode sit ttl 64 <span class="nb">local </span>x.x.x.x

<span class="c"># 查看当前的tunnel device</span>
<span class="nv">$ </span>ip tunnel show
tun6to4: ipv6/ip remote any <span class="nb">local </span>x.x.x.x ttl 64 6rd-prefix 2002::/16
sit0: ipv6/ip remote any <span class="nb">local </span>any ttl 64 nopmtudisc 6rd-prefix 2002::/16

<span class="c"># 启动tunnel device</span>
<span class="nv">$ </span>ip link <span class="nb">set </span>dev tun6to4 up

<span class="c"># 添加ipv6地址和路由</span>
<span class="nv">$ </span>ip -6 addr add &lt;ipv6_address&gt; dev tun6to4
<span class="nv">$ </span>ip -6 route add default via &lt;ipv6_gw&gt; dev tun6to4

<span class="c"># 停掉并删除tunnel device</span>
<span class="c"># 注意sit0不是通过 ip tun del删除，是需要卸载模块</span>
<span class="c"># $ ip tun del sit0</span>
<span class="c"># delete tunnel &quot;sit0&quot; failed: Operation not permitted</span>
<span class="c"># 比较奇怪的是如果sit0已经被卸载，再执行ip tun del sit0，模块又被加载上</span>
<span class="nv">$ </span>ip link <span class="nb">set </span>dev tun6to4 down
<span class="nv">$ </span>ip tun del tun6to4
<span class="nv">$ </span>rmmod sit tunnel4 ip_tunnel  <span class="c"># 删除sit0</span>
</pre></div>


<p>Hurricane Eletrict(简称he, <a href="http://he.net/">he.net</a>)提供免费的IPv6 tunnel</p>
<p>额外参考：</p>
<ul>
<li><a href="http://zablog.me/2015/11/23/IPv6AWS/#注册_HE_Tunnel">用TunnelBroker给AWS绑定IPv6</a></li>
<li><a href="https://www.sixxs.net/wiki/Gentoo_configuration">SixXS configuration for Gentoo</a></li>
<li><a href="Configuring Hurricane Electric IPv6 Tunnel">Configuring Hurricane Electric IPv6 Tunnel</a></li>
<li><a href="http://www.deepspace6.net/docs/iproute2tunnel-en.html">Configuring tunnels with iproute2</a></li>
</ul>
<p>目前只是简单了解一些，有时间再注册下he.net实践下。</p>
<h3 id="days-since-19700101">days since 1970/01/01 和 当前日期互相转换</h3>
<p>根据当前日期，获取days since 1970/01/01</p>
<div class="hlcode"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="k">$((</span><span class="sb">`</span>date +%s<span class="sb">`</span> <span class="o">/</span> <span class="m">86400</span><span class="k">))</span>
17035
</pre></div>


<p>根据days since 1970/01/01, 反推出这一天的日期。</p>
<p>一般出现在根据密码修改时间获取日期，因为<code>/etc/shadow</code>存放的密码修改时间是days since 1970/01/01</p>
<p>针对这样的情况，最简单的是：</p>
<div class="hlcode"><pre><span class="nv">$ </span>chage -l tankywoo
Last password change                                    : Jun 07, 2016
...
</pre></div>


<p>第二种就是通过date命令计算：</p>
<div class="hlcode"><pre><span class="nv">$ </span>date -d <span class="s2">&quot;01/01/1970 +17035days&quot;</span> +%F
2016-08-22
</pre></div>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2012-2016 Tanky Woo.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://git.coding.net/tankywoo/yasimple_x2.git" target="_blank">YASimple_X2</a>.
        </p>
        <p>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>站点最后生成 2016-08-30 16:44:29</p>
        <p><a href="https://github.com/tankywoo/wiki.tankywoo.com">Fork me on Github</a></p>
        <p><a href="http://www.miitbeian.gov.cn/">京ICP备16016622号</a></p>
      </div> <!-- end footer-right -->
    </div>
    <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F754de327571c0ba7ff50a61fc964e196' type='text/javascript'%3E%3C/script%3E"));
    </script>
  </body>
</html>