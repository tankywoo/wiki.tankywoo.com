<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>SUID / SGID / Sticky Bit - Wiki · Tanky Woo</title>
    <meta name="keywords" content="wiki, makrdown, linux, python, cpp, ops, simiki"/>
    <meta name="description" content="Tanky Woo's personal wiki, powered by vim and markdown. Focus on Python, C/C++, Linux, Ops-Dev, Gentoo, and so on."/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/">Wiki · Tanky Woo</a>
    &nbsp;&#187;&nbsp;
    <a href="/#linux">linux</a>
    &nbsp;&#187;&nbsp;SUID / SGID / Sticky Bit
    <span class="updated">当前页面最后更新&nbsp;
    2015-11-03 20:36
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#suid">SUID</a></li>
<li><a href="#sgid">SGID</a></li>
<li><a href="#sticky-bit">Sticky Bit</a></li>
<li><a href="#_1">参考</a></li>
</ul>
</div>
<h2 id="suid">SUID</h2>
<p>即 Set User IDentification, 更详细说是Set owner User ID on execution.</p>
<blockquote>
<p>is a special type of file permissions given to a file. Normally in Linux/Unix when a program runs, it inherits access permissions from the logged in user. SUID is defined as giving temporary permissions to a user to run a program/file with the permissions of the file owner rather that the user who runs it. <strong>In simple words users will get file owner’s permissions as well as owner UID and GID when executing a file/program/command</strong>.</p>
</blockquote>
<p>用户在执行程序/命令时, 会临时拥有此程序的属主权限.</p>
<p>使用场景:</p>
<ul>
<li>Where root login is required to execute some commands/programs/scripts.</li>
<li>Where you don’t want to give credentials of a particular user, but want to run some programs as the owner.</li>
<li>Where you don’t want to use SUDO command, but want to give execute permission for a file/script etc.</li>
</ul>
<p>针对目标一般是文件</p>
<p>最常见的就是<code>passwd</code>命令:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">alh</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">passwd</span>
<span class="o">-</span><span class="n">rws</span><span class="o">--</span><span class="n">x</span><span class="o">--</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">42</span><span class="n">K</span> <span class="n">Sep</span> <span class="mi">17</span>  <span class="mi">2012</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">passwd</span>

<span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">alh</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="p">{</span><span class="n">passwd</span><span class="p">,</span><span class="n">shadow</span><span class="p">}</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mf">1.8</span><span class="n">K</span> <span class="n">Nov</span>  <span class="mi">3</span> <span class="mo">05</span><span class="o">:</span><span class="mi">28</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">-----</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">854</span> <span class="n">Nov</span>  <span class="mi">3</span> <span class="mo">05</span><span class="o">:</span><span class="mi">28</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shadow</span>
</pre></div>


<p>执行passwd命令会修改如上面的文件, 但是设置了suid, 则在执行命令时effective uid则是root.</p>
<p>设置suid的两种方式:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">chmod</span> <span class="n">u</span><span class="o">+</span><span class="n">s</span> <span class="n">xxx</span><span class="p">.</span><span class="n">file</span>
<span class="err">$</span> <span class="n">chmod</span> <span class="mi">4644</span> <span class="n">xxx</span><span class="p">.</span><span class="n">file</span>
</pre></div>


<p>注意user权限一栏的x是<code>s</code>. 如果<code>S</code>(captial), 则表示没有设置可执行权限(<code>x</code>).</p>
<p>[虽然有人说这样会导致suid无效, 不过我测试是没问题]</p>
<p>suid也可以给目录设置, 不过没什么用.</p>
<p>测试例子:</p>
<div class="hlcode"><pre><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">geteuid</span><span class="p">());</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>执行:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">test_suid</span>
<span class="mi">1000</span>

<span class="err">$</span> <span class="n">sudo</span> <span class="n">chmod</span> <span class="n">u</span><span class="o">+</span><span class="n">s</span> <span class="n">test_suid</span>

<span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">test_suid</span>
<span class="mi">0</span>
</pre></div>


<p>另外, 脚本设置suid是无效的:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">cat</span> <span class="n">a</span><span class="p">.</span><span class="n">sh</span>
<span class="cp">#!/bin/bash</span>

<span class="n">echo</span> <span class="err">&#39;</span><span class="o">&gt;</span> <span class="n">effective</span> <span class="n">id</span><span class="o">:</span> <span class="err">&#39;</span> <span class="err">`</span><span class="n">id</span> <span class="o">-</span><span class="n">u</span><span class="err">`</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="o">&gt;</span> <span class="n">real</span> <span class="n">id</span><span class="o">:</span> <span class="err">&#39;</span> <span class="err">`</span><span class="n">id</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">r</span><span class="err">`</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;\</span><span class="n">n</span><span class="o">---------------------</span><span class="err">\</span><span class="n">n</span><span class="err">&#39;</span>

<span class="n">touch</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">xxxxx</span>

<span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">al</span> <span class="n">a</span><span class="p">.</span><span class="n">sh</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">tankywoo</span> <span class="mi">129</span> <span class="n">Nov</span>  <span class="mi">3</span> <span class="mo">06</span><span class="o">:</span><span class="mi">27</span> <span class="n">a</span><span class="p">.</span><span class="n">sh</span>

<span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">sh</span>
<span class="o">&gt;</span> <span class="n">effective</span> <span class="n">id</span><span class="o">:</span>  <span class="mi">1000</span>
<span class="o">&gt;</span> <span class="n">real</span> <span class="n">id</span><span class="o">:</span>  <span class="mi">1000</span>

<span class="o">---------------------</span>

<span class="nl">touch:</span> <span class="n">cannot</span> <span class="n">touch</span> <span class="err">‘</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">xxxxx</span><span class="err">’</span><span class="o">:</span> <span class="n">Permission</span> <span class="n">denied</span>
</pre></div>


<p>可以通过C代码做一个wrapper来实现. 具体的原因和方法见:</p>
<blockquote>
<p>Linux ignores the setuid¹ bit on all interpreted executables (i.e. executables starting with a #! line). The <a href="http://www.faqs.org/faqs/unix-faq/faq/part4/section-7.html">comp.unix.questions FAQ</a> explains the security problems with setuid shell scripts. These problems are of two kinds: shebang-related and shell-related</p>
</blockquote>
<ul>
<li><a href="http://unix.stackexchange.com/questions/364/allow-setuid-on-shell-scripts">Allow setuid on shell scripts</a></li>
<li><a href="http://unix.stackexchange.com/questions/166817/using-the-setuid-bit-properly">Using the setuid bit properly</a></li>
<li><a href="http://superuser.com/questions/440363/can-i-make-a-script-always-execute-as-root">Can I make a script always execute as root?</a></li>
</ul>
<h2 id="sgid">SGID</h2>
<p>和SUID类似. Set Group ID up on execution.</p>
<blockquote>
<p>is a special type of file permissions given to a file/folder. Normally in Linux/Unix when a program runs, it inherits access permissions from the logged in user. SGID is defined as giving temporary permissions to a user to run a program/file with the permissions of the file group permissions to become member of that group to execute the file. <strong>In simple words users will get file Group’s permissions when executing a Folder/file/program/command</strong>.</p>
</blockquote>
<p>使用场景:</p>
<ul>
<li>保持子文件/子目录和父目录一个数组</li>
</ul>
<p>针对目标一般是目录</p>
<p>设置sgid的两种方式:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">chmod</span> <span class="n">g</span><span class="o">+</span><span class="n">s</span> <span class="n">directory</span>
<span class="err">$</span> <span class="n">chmod</span> <span class="mi">2755</span> <span class="n">directory</span>
</pre></div>


<p>注意group权限一栏的x是<code>s</code>. 如果<code>S</code>(captial), 则表示没有设置可执行权限(<code>x</code>).</p>
<p>默认情况下, 用户创建文件的数组是自身的primary group, 通过sgid可以改变这个特性:</p>
<div class="hlcode"><pre><span class="c1"># 设置sgid前</span>
<span class="o">$</span> ll file1
<span class="o">-</span>rw<span class="o">-</span>r<span class="o">--</span>r<span class="o">--</span> <span class="m">1</span> tankywoo tankywoo <span class="m">0</span> Nov  <span class="m">3</span> <span class="m">06</span><span class="o">:</span><span class="m">54</span> file1         <span class="c1"># &lt;--- group是tankywoo</span>
<span class="o">$</span> id
uid<span class="o">=</span><span class="m">1000</span><span class="p">(</span>tankywoo<span class="p">)</span> gid<span class="o">=</span><span class="m">1000</span><span class="p">(</span>tankywoo<span class="p">)</span> groups<span class="o">=</span><span class="m">1000</span><span class="p">(</span>tankywoo<span class="p">),</span><span class="m">10</span><span class="p">(</span>wheel<span class="p">),</span><span class="m">16</span><span class="p">(</span>cron<span class="p">)</span>

<span class="c1"># 设置sgid</span>
<span class="o">$</span> mkdir test_gid
<span class="o">$</span> sudo chmod g<span class="o">+</span>s test_gid
<span class="o">$</span> chgrp mygroup test_gid
<span class="o">$</span> ls <span class="o">-</span>ald test_gid
drwxr<span class="o">-</span>sr<span class="o">-</span>x <span class="m">2</span> tankywoo mygroup <span class="m">4096</span> Nov  <span class="m">3</span> <span class="m">06</span><span class="o">:</span><span class="m">54</span> test_gid
<span class="o">$</span> cd test_gid
<span class="o">$</span> touch file2
<span class="o">$</span> ll file2
<span class="o">-</span>rw<span class="o">-</span>r<span class="o">--</span>r<span class="o">--</span> <span class="m">1</span> tankywoo mygroup <span class="m">0</span> Nov  <span class="m">3</span> <span class="m">06</span><span class="o">:</span><span class="m">56</span> file2          <span class="c1"># &lt;--- group是mygroup</span>
</pre></div>


<h2 id="sticky-bit">Sticky Bit</h2>
<p>即 粘滞位</p>
<blockquote>
<p>is mainly used on folders in order to avoid deletion of a folder and its content by other users though they having write permissions on the folder contents. If Sticky bit is enabled on a folder, the folder contents are deleted by only owner who created them and the root user. No one else can delete other users data in this folder(Where sticky bit is set). This is a security measure to avoid deletion of critical folders and their content(sub-folders and files), though other users have full permissions.</p>
</blockquote>
<p>使用场景即作用, 一个公共目录, 大家(other)都可以写文件, 这时自然大家也都可以删文件; 粘滞位就是保护这些文件</p>
<p>设置sticky bit的三种方式:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">chmod</span> <span class="n">o</span><span class="o">+</span><span class="n">t</span> <span class="n">directory</span>
<span class="err">$</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">t</span> <span class="n">directory</span>
<span class="err">$</span> <span class="n">chmod</span> <span class="mi">1777</span> <span class="n">directory</span>
</pre></div>


<p>最常见的就是<code>/tmp</code> 目录:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">ll</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">tmp</span>
<span class="n">drwxrwxrwt</span> <span class="mi">14</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="n">Nov</span>  <span class="mi">3</span> <span class="mo">07</span><span class="o">:</span><span class="mi">12</span> <span class="o">/</span><span class="n">tmp</span>
</pre></div>


<p>针对目标一般是目录</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">chmod</span> <span class="mi">1777</span> <span class="n">test_sticky</span>
<span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">ald</span> <span class="n">test_sticky</span>
<span class="n">drwxrwxrwt</span> <span class="mi">2</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="n">Nov</span>  <span class="mi">3</span> <span class="mo">07</span><span class="o">:</span><span class="mi">17</span> <span class="n">test_sticky</span>

<span class="cp"># 用户shen创建一个文件</span>
<span class="n">shen</span> <span class="err">$</span> <span class="n">touch</span> <span class="n">xxx</span><span class="p">.</span><span class="n">txt</span>

<span class="cp"># 用户tankywoo删除此文件</span>
<span class="n">tankywoo</span> <span class="o">%</span> <span class="n">rm</span> <span class="n">xxx</span><span class="p">.</span><span class="n">txt</span>
<span class="nl">rm:</span> <span class="n">cannot</span> <span class="n">remove</span> <span class="err">‘</span><span class="n">xxx</span><span class="p">.</span><span class="n">txt</span><span class="err">’</span><span class="o">:</span> <span class="n">Operation</span> <span class="n">not</span> <span class="n">permitted</span>

<span class="cp"># 去掉sticky bit权限</span>
<span class="err">$</span> <span class="n">chmod</span> <span class="n">o</span><span class="o">-</span><span class="n">t</span> <span class="n">test_sticky</span>
<span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">ald</span> <span class="n">test_sticky</span>
<span class="n">drwxrwxrwx</span> <span class="mi">2</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="n">Nov</span>  <span class="mi">3</span> <span class="mo">07</span><span class="o">:</span><span class="mi">18</span> <span class="n">test_sticky</span>

<span class="cp"># 正常删除</span>
<span class="n">tankywoo</span> <span class="err">$</span> <span class="n">rm</span>  <span class="n">xxx</span><span class="p">.</span><span class="n">txt</span>
<span class="n">tankywoo</span> <span class="err">$</span>
</pre></div>


<h2 id="_1">参考</h2>
<p>非常详细的一系列三篇文章:</p>
<ul>
<li><a href="http://www.linuxnix.com/suid-set-suid-linuxunix/">What is SUID and how to set SUID in Linux/Unix?</a></li>
<li><a href="http://www.linuxnix.com/sgid-set-sgid-linuxunix/">What is SGID and how to set SGID in Linux?</a></li>
<li><a href="http://www.linuxnix.com/sticky-bit-set-linux/">What is a sticky Bit and how to set it in Linux?</a></li>
</ul>
  
</div>
    </div>
    <div id="footer">
      <div class="footer-left">
        <p>
        Copyright © 2012-2017 Tanky Woo.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://github.com/tankywoo/yasimple_x2" target="_blank">YASimple_X2</a>.
        </p>
        <p>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</p>
      </div> <!-- end footer-left -->
      <div class="footer-right">
        <p>站点最后生成 2017-12-20 17:19:45</p>
        <p><a href="https://github.com/tankywoo/wiki.tankywoo.com">Fork me on Github</a></p>
        <p><a href="http://www.miitbeian.gov.cn/">京ICP备16016622号</a></p>
      </div> <!-- end footer-right -->
    </div>

    
    

    <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F754de327571c0ba7ff50a61fc964e196' type='text/javascript'%3E%3C/script%3E"));
    </script>
  </body>
</html>